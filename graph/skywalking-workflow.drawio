<mxfile host="Electron" modified="2023-08-01T11:21:00.137Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="ryGbrnBXkVHMwjq7UHTo" version="21.6.5" type="device">
  <diagram id="PYI9xT5d_eNirprLVBCl" name="Skywalking-Agent 工作原理 (v8.14.0) ">
    <mxGraphModel dx="2603" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1169" pageHeight="827" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="CrG38wg852pacwZDw58O-541" value="拦截器（定义增强逻辑）" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fontColor=#007FFF;arcSize=1;dashed=1;" parent="1" vertex="1">
          <mxGeometry x="2115" y="3440" width="210" height="1490" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-510" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#82b366;fillColor=#d5e8d4;" parent="1" source="CrG38wg852pacwZDw58O-491" target="CrG38wg852pacwZDw58O-494" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="4260" y="4970" />
              <mxPoint x="4260" y="4830" />
              <mxPoint x="830" y="4830" />
              <mxPoint x="830" y="4805" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-378" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=9;fontColor=#FF3333;" parent="1" vertex="1">
          <mxGeometry x="-610" y="2540" width="580" height="475" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-2" value="&lt;p style=&quot;line-height: 1&quot;&gt;&lt;/p&gt;&lt;h1&gt;&lt;font style=&quot;font-size: 20px&quot;&gt;Skywalking-Agent 工作原理&lt;/font&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;(v8.14.0)&amp;nbsp;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;核心就是通过&lt;b style=&quot;font-size: 10px&quot;&gt;JavaAgent探针技术&lt;/b&gt;+&lt;b style=&quot;font-size: 10px&quot;&gt;ByteBuddy&lt;/b&gt;实现的。像什么AspectJ 、Cglib、arthas、jvm-sandbox 追根溯源本质都是基于JavaAgent技术。&lt;/font&gt;&lt;/div&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;前提：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;&lt;ul style=&quot;font-size: 10px&quot;&gt;&lt;li style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;理解 java-agent 原理，即字节码增强原理 （可以实现对代码无任何侵入的JVM层面的AOP）&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;ByteBuddy 字节码编程，字节码增强逻辑需要自行通过实现Transformer来实现；相对于ASM、Javassist，ByteBuddy 更易用且性能也更有优势。&lt;br&gt;&lt;/font&gt;&lt;/li&gt;&lt;li style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;最好理解ByteBuddy 工作原理，但是可能因为比较偏底层，关于基于JVM讲ByteBuddy原理的资料几乎没有，看到的基本都是怎么使用，但是原理不理解怎么使用都感觉很别扭。&lt;br&gt;&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;说明：&lt;br&gt;&lt;ul&gt;&lt;li&gt;本文中拦截点和切点是同一种概念&amp;nbsp;&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="10" y="20" width="710" height="180" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;" parent="1" source="CrG38wg852pacwZDw58O-3" target="CrG38wg852pacwZDw58O-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-184" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-3" target="CrG38wg852pacwZDw58O-183" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-3" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;premain&lt;/b&gt;(String agentArgs, Instrumentation &lt;b style=&quot;font-size: 10px;&quot;&gt;instrumentation&lt;/b&gt;)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;gradientColor=#97d077;" parent="1" vertex="1">
          <mxGeometry x="40" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-9" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-4" target="CrG38wg852pacwZDw58O-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-4" target="CrG38wg852pacwZDw58O-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-4" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;SnifferConfigInitializer&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;.initializeCoreConfig(agentArgs);&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;嗅探配置初始化，其实是&lt;b style=&quot;font-size: 10px;&quot;&gt;将配置的属性写入Config类&lt;/b&gt;&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="320" y="235" width="200" height="70" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-8" target="CrG38wg852pacwZDw58O-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-50" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-8" target="CrG38wg852pacwZDw58O-49" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-8" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;pluginFinder = new &lt;b style=&quot;font-size: 10px;&quot;&gt;PluginFinder&lt;/b&gt;(new PluginBootstrap().loadPlugins());&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;扫描插件定义、加载插件类并实例化，&lt;br style=&quot;font-size: 10px;&quot;&gt;至于 PluginFinder 只是为了方便查找而对容器的封装&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="320" y="750" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="CrG38wg852pacwZDw58O-10" target="CrG38wg852pacwZDw58O-14" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="420" y="1760" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-10" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;byteBuddy = new &lt;b style=&quot;font-size: 10px;&quot;&gt;ByteBuddy&lt;/b&gt;()&lt;br style=&quot;font-size: 10px;&quot;&gt;.with(TypeValidation.of(&lt;br style=&quot;font-size: 10px;&quot;&gt;Config.Agent.IS_OPEN_DEBUGGING_CLASS));&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;ByteBuddy实例化，可以理解为字节码编辑器&lt;/font&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=9;" parent="1" vertex="1">
          <mxGeometry x="310" y="1640" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-14" target="CrG38wg852pacwZDw58O-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-108" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-14" target="CrG38wg852pacwZDw58O-107" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-14" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;AgentBuilder agentBuilder = new &lt;b style=&quot;font-size: 10px;&quot;&gt;AgentBuilder&lt;/b&gt;.Default(&lt;b style=&quot;font-size: 10px;&quot;&gt;byteBuddy&lt;/b&gt;).ignore(...)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;字节码增强Builder&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=11;" parent="1" vertex="1">
          <mxGeometry x="310" y="1740" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-19" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-16" target="CrG38wg852pacwZDw58O-18" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-16" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;edgeClasses = new JDK9ModuleExporter.EdgeClasses();&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;创建用于存class名的List，这些类都要export&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=9;" parent="1" vertex="1">
          <mxGeometry x="310" y="1820" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-18" target="CrG38wg852pacwZDw58O-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-84" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-18" target="CrG38wg852pacwZDw58O-83" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-18" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;agentBuilder = BootstrapInstrumentBoost.inject(pluginFinder, instrumentation, agentBuilder, edgeClasses);&lt;br style=&quot;font-size: 10px;&quot;&gt;sd&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="310" y="1900" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-23" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-20" target="CrG38wg852pacwZDw58O-22" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-97" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-20" target="CrG38wg852pacwZDw58O-96" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-20" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;agentBuilder = JDK9ModuleExporter&lt;br style=&quot;font-size: 10px;&quot;&gt;.&lt;b style=&quot;font-size: 10px;&quot;&gt;openReadEdge&lt;/b&gt;(instrumentation, agentBuilder, edgeClasses);&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;确保 edgeClasses 及HIGH_PRIORITY_CLASSES&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;所提供类型的所有模块都可以被任何 Instrumentation 类型的模块读取&lt;/span&gt;&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="310" y="2060" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-25" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-22" target="CrG38wg852pacwZDw58O-24" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-111" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-22" target="CrG38wg852pacwZDw58O-110" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-22" value="&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;div&gt;agentBuilder&lt;/div&gt;&lt;div&gt;.&lt;b&gt;type&lt;/b&gt;(pluginFinder.buildMatch())&lt;/div&gt;&lt;div&gt;.&lt;b&gt;transform&lt;/b&gt;(new Transformer(pluginFinder))&lt;/div&gt;&lt;div&gt;.&lt;b&gt;with&lt;/b&gt;(AgentBuilder&lt;/div&gt;&lt;div&gt;&lt;span&gt;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;span&gt;.RedefinitionStrategy.&lt;/span&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;RETRANSFORMATION&lt;/font&gt;&lt;span&gt;)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;.&lt;b&gt;with&lt;/b&gt;(new RedefinitionListener())&lt;/div&gt;&lt;div&gt;.&lt;b&gt;with&lt;/b&gt;(new Listener())&lt;/div&gt;&lt;div&gt;.&lt;b&gt;installOn&lt;/b&gt;(instrumentation);&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=5;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="310" y="2220" width="220" height="120" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-24" target="CrG38wg852pacwZDw58O-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-174" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-24" target="CrG38wg852pacwZDw58O-173" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-24" value="&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;PluginFinder.pluginInitCompleted();&lt;br&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;拓展完成标志位设置true&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="320" y="4000.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-26" target="CrG38wg852pacwZDw58O-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-176" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-26" target="CrG38wg852pacwZDw58O-175" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-26" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;ServiceManager.INSTANCE.boot();&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="320" y="4100.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-186" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="CrG38wg852pacwZDw58O-28" target="CrG38wg852pacwZDw58O-187" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="600" y="5029.75" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-28" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;Runtime.getRuntime()&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;.addShutdownHook(new Thread(&lt;b style=&quot;font-size: 10px;&quot;&gt;ServiceManager&lt;/b&gt;.INSTANCE::&lt;b style=&quot;font-size: 10px;&quot;&gt;shutdown&lt;/b&gt;, &quot;skywalking service shutdown thread&quot;));&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;注册一个关闭钩子线程，进程关闭时执行ServiceManager shutdown()方法&lt;/font&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;arcSize=6;" parent="1" vertex="1">
          <mxGeometry x="310" y="5010" width="220" height="79.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-32" target="CrG38wg852pacwZDw58O-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-32" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;嗅探配置存储在名为 &lt;b style=&quot;font-size: 10px;&quot;&gt;AGENT_SETTINGS&lt;/b&gt; 的&lt;b style=&quot;font-size: 10px;&quot;&gt;Properties&lt;/b&gt; 对象&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="600" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-37" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-34" target="CrG38wg852pacwZDw58O-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-34" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;configFileStream = loadConfig();&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;AGENT_SETTINGS&lt;/b&gt;.load(configFileStream);&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;获取skywalking-agent.jar所在目录，加载config/agent.config文件中的属性&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="590" y="320" width="220" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-36" target="CrG38wg852pacwZDw58O-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-36" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;overrideConfigBySystemProp();&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;然后用系统属性覆盖同名的属性&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-41" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-38" target="CrG38wg852pacwZDw58O-40" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-38" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;overrideConfigByAgentOptions(&lt;br style=&quot;font-size: 10px;&quot;&gt;agentOptions);&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;用 -javaagent 命令行参数覆盖同名属性&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-40" target="CrG38wg852pacwZDw58O-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-45" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-40" target="CrG38wg852pacwZDw58O-44" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-40" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;initializeConfig(Config.class);&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="600" y="580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-52" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-42" target="CrG38wg852pacwZDw58O-51" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-42" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;setAgentVersion();&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;读取META-INF/MANIFEST.MF Implementation-Version&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;内容设置到Config.Agent.VERSION&lt;/span&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-44" target="CrG38wg852pacwZDw58O-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-44" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;ConfigInitializer&lt;/b&gt;.initialize(&lt;br style=&quot;font-size: 10px;&quot;&gt;AGENT_SETTINGS, configClass);&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;递归将Properties属性写入&lt;b style=&quot;font-size: 10px;&quot;&gt;Config&lt;/b&gt;的各个内部类的公共静态成员变量&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="840" y="570" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-46" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;org.apache.skywalking.apm.agent.core.conf.&lt;b style=&quot;font-size: 10px;&quot;&gt;Config&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;内部定义了一组public静态内部类，内部类中也只有静态成员&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;Agent&lt;br style=&quot;font-size: 10px;&quot;&gt;OsInfo&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;Collector&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;Profile&lt;br style=&quot;font-size: 10px;&quot;&gt;Meter&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;Jvm&lt;br style=&quot;font-size: 10px;&quot;&gt;Log&lt;br style=&quot;font-size: 10px;&quot;&gt;Buffer&lt;br style=&quot;font-size: 10px;&quot;&gt;Logging&lt;br style=&quot;font-size: 10px;&quot;&gt;StatusCheck&lt;br style=&quot;font-size: 10px;&quot;&gt;Plugin&lt;br style=&quot;font-size: 10px;&quot;&gt;Correlation&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-360" y="240" width="320" height="200" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-47" value="&lt;b style=&quot;font-size: 10px;&quot;&gt;ConfigInitializer$&lt;/b&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;initNextLevel()&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;写入的详细过程参考这个方法，使用反射；Properties中的key和类的静态成员名是对应的&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1080" y="580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-54" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-49" target="CrG38wg852pacwZDw58O-53" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-78" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-49" target="CrG38wg852pacwZDw58O-77" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-49" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;new PluginBootstrap().loadPlugins()&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;最终将插件加载到一组&lt;b style=&quot;font-size: 10px;&quot;&gt;AbstractClassEnhancePluginDefine&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-51" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;TIPS:&lt;br style=&quot;font-size: 10px;&quot;&gt;读取MANIFEST.MF 到 Manifest对象&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="840" y="660" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-57" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-53" target="CrG38wg852pacwZDw58O-56" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-53" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;AgentClassLoader.initDefaultLoader();&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;这个类加载器，扫描 skywalking-agent.jar所在目录&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="840" y="760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-55" value="&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;org.apache.skywalking.apm.agent.core.plugin.&lt;/span&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;div style=&quot;text-align: center ; font-size: 10px&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;&lt;b style=&quot;font-size: 10px&quot;&gt;AbstractClassEnhancePluginDefine&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;这个是插件定义抽象类，所有插件都继承此类，此抽象类并没有成员变量&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;内部定义 增强逻辑、匹配机制、拦截点、拦截点对应拦截器（在插件包中定义）&lt;br&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;//串联整个增强逻辑的入口方法&lt;br&gt;//类适配，增强静态方法，增强实例方法&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;public DynamicType.Builder&amp;lt;?&amp;gt; &lt;b&gt;define&lt;/b&gt;(TypeDescription typeDescription, DynamicType.Builder&amp;lt;?&amp;gt; builder,&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ClassLoader classLoader, EnhanceContext context) throws PluginException {}&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected DynamicType.Builder&amp;lt;?&amp;gt; enhance(TypeDescription typeDescription,&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;span&gt;&#x9;&lt;/span&gt;&lt;span&gt;&#x9;&lt;/span&gt;&lt;span&gt;&#x9;&lt;/span&gt;&lt;span&gt;&#x9;&lt;/span&gt;DynamicType.Builder&amp;lt;?&amp;gt; newClassBuilder,&amp;nbsp;&lt;/font&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;ClassLoader classLoader, EnhanceContext context) {}&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected abstract DynamicType.Builder&amp;lt;?&amp;gt; &lt;b&gt;enhanceInstance&lt;/b&gt;(TypeDescription typeDescription,&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;DynamicType.Builder&amp;lt;?&amp;gt; newClassBuilder, ClassLoader classLoader,&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;EnhanceContext context) throws PluginException;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected abstract DynamicType.Builder&amp;lt;?&amp;gt; &lt;b&gt;enhanceClass&lt;/b&gt;(TypeDescription typeDescription,&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;span&gt;&#x9;&lt;/span&gt;&lt;span&gt;&#x9;&lt;/span&gt;DynamicType.Builder&amp;lt;?&amp;gt; newClassBuilder,&amp;nbsp;&lt;/font&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;ClassLoader classLoader) throws PluginException;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//类适配&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected abstract ClassMatch &lt;b&gt;enhanceClass&lt;/b&gt;();&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected String[] &lt;b&gt;witnessClasses&lt;/b&gt;() {}&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected List&amp;lt;WitnessMethod&amp;gt; witnessMethods() {}&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;public boolean isBootstrapInstrumentation() {}&lt;br&gt;&lt;br&gt;public abstract ConstructorInterceptPoint[] &lt;b&gt;getConstructorsInterceptPoints&lt;/b&gt;();&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;public abstract InstanceMethodsInterceptPoint[] &lt;b&gt;getInstanceMethodsInterceptPoints&lt;/b&gt;();&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;public abstract InstanceMethodsInterceptV2Point[] getInstanceMethodsInterceptV2Points();&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;public abstract StaticMethodsInterceptPoint[] &lt;b&gt;getStaticMethodsInterceptPoints&lt;/b&gt;();&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;public abstract StaticMethodsInterceptV2Point[] getStaticMethodsInterceptV2Points();&lt;br&gt;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="1800" width="560" height="400" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-59" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-56" target="CrG38wg852pacwZDw58O-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-56" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;PluginResourcesResolver 扫描插件定义资源文件（&lt;b style=&quot;font-size: 10px;&quot;&gt;skywalking-plugin.def&lt;/b&gt;）到 List&amp;lt;URL&amp;gt; resources&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="840" y="840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-58" target="CrG38wg852pacwZDw58O-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-68" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-58" target="CrG38wg852pacwZDw58O-67" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-58" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;for resource:&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;PluginCfg&lt;/b&gt;.INSTANCE.load(&lt;br style=&quot;font-size: 10px;&quot;&gt;pluginUrl.openStream());&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;遍历读取插件定义资源文件构建 PluginDefine 对象列表，并选择&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="840" y="920" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-60" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;org.apache.skywalking.apm.agent.core.plugin.&lt;/span&gt;&lt;/font&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;PluginCfg&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//经 AgentClassLoader 扫描加载以及经过插件选择器选择后的插件列表&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px;&quot;&gt;private List&amp;lt;&lt;b style=&quot;font-size: 10px;&quot;&gt;PluginDefine&lt;/b&gt;&amp;gt; &lt;b style=&quot;font-size: 10px;&quot;&gt;pluginClassList&lt;/b&gt; = new ArrayList&amp;lt;PluginDefine&amp;gt;();&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//插件选择器&lt;/span&gt;&lt;/p&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; //仅仅是过滤掉 Config.Plugin.EXCLUDE_PLUGINS 中定义的要排除的插件&lt;/span&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px;&quot;&gt;private PluginSelector &lt;b style=&quot;font-size: 10px;&quot;&gt;pluginSelector&lt;/b&gt; = new PluginSelector();&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-480" y="760" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-61" target="CrG38wg852pacwZDw58O-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-61" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;List&amp;lt;PluginDefine&amp;gt; pluginClassList = &lt;b style=&quot;font-size: 10px;&quot;&gt;PluginCfg&lt;/b&gt;.INSTANCE.getPluginClassList();&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;被选中的插件中拦截器类列表&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="840" y="1100" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-75" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-63" target="CrG38wg852pacwZDw58O-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-63" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;for pluginClassList:&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;AbstractClassEnhancePluginDefine&lt;/b&gt; plugin = Class.forName(...).newInstance();&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;plugins&lt;/b&gt;.add(plugin);&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;前面获取的插件定义仅仅是插件增强类名，这里加载增强类并实例化，存储到List容器&lt;/font&gt;&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="820" y="1180" width="240" height="100" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-65" value="因为打包时，skywalking-agent 和 插件、工具是分开打包的&lt;br style=&quot;font-size: 10px&quot;&gt;而且都放在了skywalking-agent 目录，即skywalking-agent.jar 所在的目录，&lt;br style=&quot;font-size: 10px&quot;&gt;而默认的类加载器只读取Jar包内的内容，所以需要重新定义一个类加载器，&lt;br style=&quot;font-size: 10px&quot;&gt;扫描这个父目录，才能加载到插件（Config.Plugin.MOUNT 实际加载的目录：&quot;&lt;b&gt;plugins&lt;/b&gt;&quot;, &quot;&lt;b&gt;activations&lt;/b&gt;&quot;）。" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1050" y="765" width="490" height="50" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-66" value="实际扫描到了126个，这里只贴几个，看看是什么样的&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;0 = {URL@1273} &quot;jar:file:/home/lee/lib/skywalking/skywalking-agent/plugins/graphql-16plus-plugin-8.14.0.jar!/skywalking-plugin.def&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;1 = {URL@1425} &quot;jar:file:/home/lee/lib/skywalking/skywalking-agent/plugins/apm-hbase-1.x-2.x-plugin-8.14.0.jar!/skywalking-plugin.def&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;2 = {URL@1428} &quot;jar:file:/home/lee/lib/skywalking/skywalking-agent/plugins/apm-mssql-jtds-1.x-plugin-8.14.0.jar!/skywalking-plugin.def&quot;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;3 = {URL@1432} &quot;jar:file:/home/lee/lib/skywalking/skywalking-agent/plugins/apm-sharding-sphere-3.x-plugin-8.14.0.jar!/skywalking-plugin.def&quot;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1050" y="840" width="690" height="70" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-67" target="CrG38wg852pacwZDw58O-69" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-67" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;PluginDefine plugin = PluginDefine.&lt;b style=&quot;font-size: 10px;&quot;&gt;build&lt;/b&gt;(pluginDefine);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;pluginClassList&lt;/b&gt;.add(plugin);&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1080" y="930" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-69" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;pluginClassList = &lt;b style=&quot;font-size: 10px;&quot;&gt;pluginSelector&lt;/b&gt;.select(pluginClassList);&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;插件选择规则：仅仅是过滤掉 Config.Plugin.&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;EXCLUDE_PLUGINS 中定义的要排除的插件&lt;/font&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1060" y="1010" width="240" height="70" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-71" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;org.apache.skywalking.apm.agent.core.conf.&lt;/font&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;PluginDefine&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//插件名称，比如 jdk-http-plugin&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px;&quot;&gt;private String &lt;b style=&quot;font-size: 10px;&quot;&gt;name&lt;/b&gt;;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//插件定义类，一个插件可能有多个定义类，这个定义类内部实现的就是&lt;b style=&quot;font-size: 10px;&quot;&gt;增强逻辑&lt;/b&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;//比如 org.apache.skywalking.apm.plugin.jdk.http.define.HttpClientInstrumentation&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px;&quot;&gt;private String &lt;b style=&quot;font-size: 10px;&quot;&gt;defineClass&lt;/b&gt;;&lt;/font&gt;&lt;/span&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-960" y="760" width="440" height="120" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-72" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;return plugins;&lt;/span&gt;&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="860" y="1400" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-76" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-74" target="CrG38wg852pacwZDw58O-72" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-74" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;plugins.addAll(DynamicPluginLoader.INSTANCE&lt;br style=&quot;font-size: 10px;&quot;&gt;.load(AgentClassLoader.getDefault()));&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;还有个动态插件加载（测试并没用到略）：&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;SPI扫描 InstrumentationLoader 实现，并加载插件&lt;/span&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="820" y="1300" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-131" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-77" target="CrG38wg852pacwZDw58O-130" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-134" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-77" target="CrG38wg852pacwZDw58O-132" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="810" y="1510" />
              <mxPoint x="810" y="1590" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-77" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;new &lt;b style=&quot;font-size: 10px;&quot;&gt;PluginFinder&lt;/b&gt;(plugins)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;猜测是对List额外增加Map容器，方便使用某插件时查找，&lt;/font&gt;&lt;font color=&quot;#ff3333&quot; style=&quot;font-size: 10px;&quot;&gt;需要结合具体插件看TODO&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="1480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-79" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;org.apache.skywalking.apm.&lt;b style=&quot;font-size: 10px;&quot;&gt;dependencies&lt;/b&gt;.net.bytebuddy.agent.builder.&lt;b style=&quot;font-size: 10px;&quot;&gt;AgentBuilder&lt;/b&gt;&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;是ByteBuddy的接口类，只不过是被shade插件打包时重新改了包名（前面拼接了skywalking的包名）&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="1280" width="520" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-102" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=blockThin;endFill=0;" parent="1" source="CrG38wg852pacwZDw58O-80" target="CrG38wg852pacwZDw58O-79" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-80" value="&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center ; font-size: 10px&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;org.apache.skywalking.apm.&lt;b style=&quot;font-size: 10px&quot;&gt;dependencies&lt;/b&gt;.net.bytebuddy.agent.builder.&lt;b style=&quot;font-size: 10px&quot;&gt;AgentBuilder.Default&lt;/b&gt;&lt;/span&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;ByteBuddy核心类&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;&lt;b style=&quot;font-size: 10px&quot;&gt;byteBuddy&lt;/b&gt; = {ByteBuddy@2512}&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;listener = {AgentBuilder$Listener$NoOp@2641} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;circularityLock = {AgentBuilder$CircularityLock$Default@2514}&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;poolStrategy = {AgentBuilder$PoolStrategy$Default@2642} &quot;FAST&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;typeStrategy = {AgentBuilder$TypeStrategy$Default$1@2643} &quot;REBASE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;locationStrategy = {AgentBuilder$LocationStrategy$ForClassLoader$1@2644} &quot;STRONG&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;nativeMethodStrategy = {AgentBuilder$Default$NativeMethodStrategy$Disabled@2645} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;warmupStrategy = {AgentBuilder$Default$WarmupStrategy$NoOp@2646} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;transformerDecorator = {AgentBuilder$TransformerDecorator$NoOp@2647} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;initializationStrategy = {AgentBuilder$InitializationStrategy$SelfInjection$Split@2648}&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;redefinitionStrategy&lt;/b&gt; = {AgentBuilder$RedefinitionStrategy$1@2649} &quot;DISABLED&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;redefinitionDiscoveryStrategy = {AgentBuilder$RedefinitionStrategy$DiscoveryStrategy$SinglePass@2650} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;redefinitionBatchAllocator = {AgentBuilder$RedefinitionStrategy$BatchAllocator$ForTotal@2651} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;redefinitionListener = {AgentBuilder$RedefinitionStrategy$Listener$NoOp@2652} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;redefinitionResubmissionStrategy = {AgentBuilder$RedefinitionStrategy$ResubmissionStrategy$Disabled@2653} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;injectionStrategy = {AgentBuilder$InjectionStrategy$UsingReflection@2654} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;lambdaInstrumentationStrategy = {AgentBuilder$LambdaInstrumentationStrategy$2@2655} &quot;DISABLED&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;descriptionStrategy = {AgentBuilder$DescriptionStrategy$Default$1@2656} &quot;HYBRID&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;fallbackStrategy = {AgentBuilder$FallbackStrategy$ByThrowableType@2657}&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;classFileBufferStrategy = {AgentBuilder$ClassFileBufferStrategy$Default$1@2658} &quot;RETAINING&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;installationListener = {AgentBuilder$InstallationListener$NoOp@2659} &quot;INSTANCE&quot;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;ignoreMatcher = {AgentBuilder$RawMatcher$Disjunction@2660}&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font color=&quot;#330000&quot; style=&quot;font-size: 10px&quot;&gt;transformations = {Collections$EmptyList@2661}&amp;nbsp; size = 0&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-640" y="1400" width="600" height="360" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-86" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-83" target="CrG38wg852pacwZDw58O-85" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-95" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-83" target="CrG38wg852pacwZDw58O-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-83" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;prepareJREInstrumentation(&lt;br style=&quot;font-size: 10px;&quot;&gt;pluginFinder, classesTypeMap)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;为ByteBuddy生成动态委托 ???&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="1910" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-88" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-85" target="CrG38wg852pacwZDw58O-87" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-85" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;TypePool typePool = TypePool.Default.of(&lt;br style=&quot;font-size: 10px;&quot;&gt;BootstrapInstrumentBoost.class&lt;br style=&quot;font-size: 10px;&quot;&gt;.getClassLoader());&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="840" y="1910" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-91" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#FF3333;" parent="1" source="CrG38wg852pacwZDw58O-87" target="CrG38wg852pacwZDw58O-90" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-87" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;bootstrapClassMatchDefines = pluginFinder&lt;br style=&quot;font-size: 10px;&quot;&gt;.&lt;b style=&quot;font-size: 10px;&quot;&gt;getBootstrapClassMatchDefine&lt;/b&gt;();&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;测试DEMO中为空&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="840" y="1990" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-89" value="&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;org.apache.skywalking.apm.agent.core.plugin.&lt;b style=&quot;font-size: 10px&quot;&gt;PluginFinder&lt;/b&gt;&lt;/span&gt;&lt;/font&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;插件容器类&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;//可按目标类名查询的插件定义容器&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final Map&amp;lt;String, LinkedList&amp;lt;AbstractClassEnhancePluginDefine&amp;gt;&amp;gt; &lt;b&gt;nameMatchDefine&lt;/b&gt;&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;span&gt;&#x9;&lt;/span&gt;= new HashMap&amp;lt;String, LinkedList&amp;lt;AbstractClassEnhancePluginDefine&amp;gt;&amp;gt;();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//按IndirectMatch匹配的插件定义容器（比如拦截某些注解注释的类）&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final List&amp;lt;AbstractClassEnhancePluginDefine&amp;gt; &lt;b&gt;signatureMatchDefine&lt;/b&gt;&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;span&gt;&#x9;&lt;/span&gt;= new ArrayList&amp;lt;AbstractClassEnhancePluginDefine&amp;gt;();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final List&amp;lt;AbstractClassEnhancePluginDefine&amp;gt; &lt;b&gt;bootstrapClassMatchDefine&lt;/b&gt;&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;span&gt;&#x9;&lt;/span&gt;= new ArrayList&amp;lt;AbstractClassEnhancePluginDefine&amp;gt;();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private static boolean IS_PLUGIN_INIT_COMPLETED = false;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-480" y="920" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-93" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;" parent="1" source="CrG38wg852pacwZDw58O-90" target="CrG38wg852pacwZDw58O-92" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-90" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;for&amp;nbsp;bootstrapClassMatchDefines :&amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;TODO 暂略&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="840" y="2070" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-92" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;return bootstrapClassMatchDefines&lt;br style=&quot;font-size: 10px;&quot;&gt;.size() &amp;gt; 0;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="840" y="2150" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-94" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;测试中并未用到暂略，TODO&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="600" y="1990" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-96" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;agentBuilder = agentBuilder&lt;br style=&quot;font-size: 10px;&quot;&gt;.&lt;b style=&quot;font-size: 10px;&quot;&gt;assureReadEdgeFromAndTo&lt;/b&gt;(&lt;br style=&quot;font-size: 10px;&quot;&gt;instrumentation, Class.forName(className));&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=11;" parent="1" vertex="1">
          <mxGeometry x="600" y="2070" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-98" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="290" y="1820" width="10" height="320" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-100" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;JDK9及以后版本&lt;span style=&quot;font-size: 10px;&quot;&gt;才会用到，&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;JDK8可以直接&lt;span style=&quot;font-size: 10px;&quot;&gt;跳过&lt;br style=&quot;font-size: 10px;&quot;&gt;JDK8这3步不会对AgentBuilder有任何修改&lt;/span&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="170" y="1953.75" width="120" height="52.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-101" value="还是先看下ByteBuddy的使用然后再回来看AgentBuilder的代码比较好" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="180" y="1755" width="100" height="30" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-103" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;.def 文件中定义了一组拦截器类名（存储增强逻辑），比如apm-springmvc-annotation-5.x-plugin-8.14.0.jar&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;spring-mvc-annotation-5.x=org.apache.skywalking.apm.plugin.spring.mvc.v5.define.ControllerInstrumentation&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;spring-mvc-annotation-5.x=org.apache.skywalking.apm.plugin.spring.mvc.v5.define.RestControllerInstrumentation&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;spring-mvc-annotation-5.x=org.apache.skywalking.apm.plugin.spring.mvc.v5.define.HandlerMethodInstrumentation&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;spring-mvc-annotation-5.x=org.apache.skywalking.apm.plugin.spring.mvc.v5.define.reactive.InvocableHandlerMethodInstrumentation&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;spring-mvc-annotation-5.x=org.apache.skywalking.apm.plugin.spring.mvc.v5.define.reactive.ReactiveControllerInstrumentation&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;spring-mvc-annotation-5.x=org.apache.skywalking.apm.plugin.spring.mvc.v5.define.reactive.ReactiveRestControllerInstrumentation&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1060" y="1090" width="640" height="90" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-105" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;org.apache.skywalking.apm.&lt;/span&gt;&lt;/font&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;dependencies.net.bytebuddy.&lt;b style=&quot;font-size: 10px;&quot;&gt;ByteBuddy&lt;/b&gt;&lt;/span&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;这个就是bytebuddy框架的类，只不过被maven插件shade重新打包修改了包名&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px; font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-480" y="1160" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-107" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;ignore(ElementMatcher&amp;lt;? super TypeDescription&amp;gt; typeMatcher)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;忽略修改一些包的类&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=11;" parent="1" vertex="1">
          <mxGeometry x="600" y="1740" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-109" value="&lt;span style=&quot;font-size: 10px;&quot;&gt;ElementMatcher 用于匹配元素，&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;ignore 忽略修改匹配的类的字节码，&lt;br style=&quot;font-size: 10px;&quot;&gt;这里是&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;忽略&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;bytebuddy、日志、javassit、asm、反射等等包的类&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="810" y="1750" width="300" height="40" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-114" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-110" target="CrG38wg852pacwZDw58O-113" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-136" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-110" target="CrG38wg852pacwZDw58O-135" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-110" value="&lt;font style=&quot;line-height: 0.5; font-size: 10px;&quot;&gt;ElementMatcher&amp;lt;? super TypeDescription&amp;gt; &lt;b style=&quot;font-size: 10px;&quot;&gt;buildMatch&lt;/b&gt;()&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;TypeDescription对应Java Type、Class这种概念，此方法定义对哪些类进行增强的匹配机制&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="600" y="2250" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-112" value="PluginFinder.java" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="650" y="2230" width="100" height="20" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-116" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;dashed=1;" parent="1" source="CrG38wg852pacwZDw58O-113" target="CrG38wg852pacwZDw58O-115" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-120" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-113" target="CrG38wg852pacwZDw58O-119" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-113" value="&lt;font style=&quot;line-height: 0.5; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;ElementMatcher.Junction judge = new AbstractJunction&amp;lt;NamedElement&amp;gt;() {...}&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="840" y="2250" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-118" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-115" target="CrG38wg852pacwZDw58O-117" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-115" value="&lt;font style=&quot;line-height: 0.5; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;matches(NamedElement target)&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1080" y="2250" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-121" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" source="CrG38wg852pacwZDw58O-117" target="CrG38wg852pacwZDw58O-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-125" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" source="CrG38wg852pacwZDw58O-117" target="CrG38wg852pacwZDw58O-124" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1420" y="2330" />
              <mxPoint x="1240" y="2330" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-117" value="&lt;font style=&quot;line-height: 0.5; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;nameMatchDefine.containsKey(&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;target.getActualName())&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;即目标类名需要在插件加载的Implementation列表中&lt;/font&gt;&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1320" y="2250" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-123" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-119" target="CrG38wg852pacwZDw58O-122" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-126" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" source="CrG38wg852pacwZDw58O-119" target="CrG38wg852pacwZDw58O-124" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-119" value="&lt;font style=&quot;line-height: 0.5; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;judge = judge.and(not(isInterface()))&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;必须是非接口类型&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="840" y="2330" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-127" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" source="CrG38wg852pacwZDw58O-122" target="CrG38wg852pacwZDw58O-124" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-129" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-122" target="CrG38wg852pacwZDw58O-128" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-122" value="&lt;font style=&quot;line-height: 0.5; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;for signatureMatchDefine:&lt;br style=&quot;font-size: 10px;&quot;&gt;ClassMatch match = define.enhanceClass();&lt;br style=&quot;font-size: 10px;&quot;&gt;judge = judge.or(((&lt;b style=&quot;font-size: 10px;&quot;&gt;IndirectMatch&lt;/b&gt;) match)&lt;br style=&quot;font-size: 10px;&quot;&gt;.buildJunction());&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;或者满足&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;IndirectMatch条件&lt;/span&gt;&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="820" y="2410" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-124" value="&lt;b style=&quot;font-size: 10px&quot;&gt;拦截的类是否要增强，匹配规则&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1160" y="2345" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-128" value="&lt;font style=&quot;line-height: 0.5; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;return new &lt;b style=&quot;font-size: 10px;&quot;&gt;ProtectiveShieldMatcher&lt;/b&gt;(judge)&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;并没有封装额外的逻辑，等同于还是上面的judge&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="840" y="2510" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-130" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;Map&amp;lt;String, LinkedList&amp;lt;AbstractClassEnhancePluginDefine&amp;gt;&amp;gt; &lt;/font&gt;&lt;b style=&quot;font-size: 9px&quot;&gt;nameMatchDefine&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px&quot;&gt;适用于拦截指定名称的类，比如&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot; size=&quot;1&quot;&gt;org.elasticsearch.client.ClusterClient&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="830" y="1480" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-132" value="List&amp;lt;AbstractClassEnhancePluginDefine&amp;gt; &lt;b style=&quot;font-size: 10px&quot;&gt;signatureMatchDefine&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px&quot;&gt;比如拦截某个注解注释的类等等，比如&lt;br&gt;RestControllerInstrumentation&amp;nbsp;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="830" y="1560" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-138" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-135" target="CrG38wg852pacwZDw58O-137" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-142" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;dashed=1;" parent="1" source="CrG38wg852pacwZDw58O-135" target="CrG38wg852pacwZDw58O-141" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-135" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;new &lt;b style=&quot;font-size: 10px&quot;&gt;Transformer&lt;/b&gt;(pluginFinder)&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;实例化字节码增强转换器&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="600" y="2600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-140" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-137" target="CrG38wg852pacwZDw58O-139" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-137" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;new &lt;b style=&quot;font-size: 10px&quot;&gt;RedefinitionListener&lt;/b&gt;()&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;监听对已加载的类的修改，代码中只是&lt;br&gt;监听了onError() 打印错误日志&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="600" y="2700.25" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-189" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-139" target="CrG38wg852pacwZDw58O-188" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-139" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;new &lt;b style=&quot;font-size: 10px&quot;&gt;Listener&lt;/b&gt;()&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;实现AgentBuilder.Listener接口监听&lt;br&gt;字节码转换的过程，也仅仅是发生异常时打印下错误日志&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="600" y="2780.25" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-144" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-141" target="CrG38wg852pacwZDw58O-143" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-195" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;dashed=1;" parent="1" source="CrG38wg852pacwZDw58O-141" target="CrG38wg852pacwZDw58O-194" edge="1">
          <mxGeometry x="0.7515" relative="1" as="geometry">
            <mxPoint x="940" y="2920" as="targetPoint" />
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-141" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;Transformer#&lt;b style=&quot;font-size: 10px;&quot;&gt;transform&lt;/b&gt;(&lt;br style=&quot;font-size: 10px;&quot;&gt;final DynamicType.Builder&amp;lt;?&amp;gt; builder,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;final TypeDescription typeDescription,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;final ClassLoader classLoader,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;final JavaModule javaModule,&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;final ProtectionDomain protectionDomain)&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="840" y="2585" width="200" height="90" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-146" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-143" target="CrG38wg852pacwZDw58O-145" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-143" value="&lt;font style=&quot;line-height: 0.5; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;LoadedLibraryCollector&lt;br style=&quot;font-size: 10px;&quot;&gt;.registerURLClassLoader(classLoader);&lt;/font&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1080" y="2600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-150" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-145" target="CrG38wg852pacwZDw58O-149" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-152" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-145" target="CrG38wg852pacwZDw58O-151" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-160" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-145" target="CrG38wg852pacwZDw58O-159" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-145" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;pluginDefines&lt;/b&gt; = pluginFinder.&lt;b&gt;find&lt;/b&gt;(typeDescription);&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 10px&quot; color=&quot;#007fff&quot;&gt;查找与typeDescription适配的PluginDefine可能有多个&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1080" y="2680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-148" value="遍历&amp;nbsp;pluginFinder nameMatchDefine、signatureMatchDefine 查找适配的 PluginDefine&amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;nameMatchDefine 是通过类名匹配&lt;br style=&quot;font-size: 10px;&quot;&gt;signatureMatchDefine 通过 IndirectMatch 匹配" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1320" y="2580" width="230" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-149" value="&lt;font style=&quot;line-height: 0.5; font-size: 10px;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;this.&lt;b style=&quot;font-size: 10px;&quot;&gt;nameMatchDefine&lt;/b&gt;.containsKey(typeName)&lt;/span&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1320" y="2640" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-222" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-151" target="CrG38wg852pacwZDw58O-221" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-151" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;IndirectMatch match = (IndirectMatch)pluginDefine.&lt;b&gt;enhanceClass&lt;/b&gt;();&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/span&gt;match.&lt;b&gt;isMatch&lt;/b&gt;(typeDescription)&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1320" y="2720" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-162" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-159" target="CrG38wg852pacwZDw58O-244" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1320" y="2850" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-282" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-159" target="CrG38wg852pacwZDw58O-281" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-159" value="&lt;font style=&quot;line-height: 1&quot;&gt;&lt;div&gt;for &lt;b&gt;pluginDefines&lt;/b&gt;:&amp;nbsp;&lt;/div&gt;&lt;div&gt;DynamicType.Builder&amp;lt;?&amp;gt; &lt;b&gt;possibleNewBuilder&lt;/b&gt; = define.&lt;b&gt;define&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;typeDescription, newBuilder, classLoader, context);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;字节码增强&lt;/font&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1080" y="2810" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-163" value="&lt;b&gt;AbstractClassEnhancePluginDefine&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1345" y="2790" width="190" height="20" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-167" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-164" target="CrG38wg852pacwZDw58O-166" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-164" value="&lt;font style=&quot;line-height: 1&quot;&gt;this.&lt;b&gt;enhance&lt;/b&gt;(typeDescription, builder,&lt;br&gt;&amp;nbsp;classLoader, context)&lt;br&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;WitnessFinder&amp;nbsp; 插件版本适配成功&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1320" y="3080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-169" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-166" target="CrG38wg852pacwZDw58O-168" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-261" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-166" target="CrG38wg852pacwZDw58O-260" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-166" value="&lt;font style=&quot;line-height: 1&quot;&gt;&amp;nbsp;newClassBuilder = this.&lt;b&gt;enhanceClass&lt;/b&gt;(typeDescription, newClassBuilder, classLoader)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;定义增强静态方法&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1560" y="3080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-271" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-168" target="CrG38wg852pacwZDw58O-270" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-168" value="&lt;font style=&quot;line-height: 1&quot;&gt;newClassBuilder = this.&lt;b&gt;enhanceInstance&lt;/b&gt;(typeDescription, newClassBuilder, classLoader, context);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;定义增强实例方法：包括构造方法和其他实例方法&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#e3c800;strokeColor=#B09500;fontColor=#000000;" parent="1" vertex="1">
          <mxGeometry x="1560" y="3260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-171" value="&lt;b&gt;具体到每个类到底是什么增强逻辑在对应的 Instrumentation 类中定义&lt;/b&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1560" y="3050" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-172" value="ByteBuddy工作原理简述（对类拓展的两种方式）：&lt;br&gt;&lt;ul&gt;&lt;li&gt;在原类型基础上创建子类（原类型应该也已经加载），在子类中拓展功能，然后加载子类并使用&lt;/li&gt;&lt;li&gt;对已加载的原类型重新定义（修改原类的字节码，包名类名都不变）并变基（应该是类重载）&lt;br&gt;&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;SkyWalking Agent 主要流程：&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;首先明确 Instrumentation 对类进行转换是在循环中完成的，一个个地增强处理。&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;1 嗅探配置初始化&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;2 插件定义类加载，以及PluginFinder容器封装（为了方便查询插件定义）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;3 DynamicType.Builder 构造（就是字节码修改器）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;&lt;span&gt;&#x9;&lt;/span&gt;3.1 首先是根据目标类（要被增强的类）通过PluginFinder 查找适配的插件（匹配方式有两种：按类名、按IndirectMatch）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;3.2 适配的插件可能有多个版本，需要通过Witness机制进行版本适配（Witness中定义了不同版本的差异信息，比如加载的差异化的类）&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;3.3 定义增强静态方法， 插件的Instrumentation类中会定义拦截点（切点），拦截点中定义要对哪个静态方法进行增强（ElementMathcer），以及怎么增强 (Interceptor)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;3.4 定义增强构造方法，原理和上面类似&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;3.5 定义增强实例方法，原理和上面类似&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;4 服务首次调用时进行类加载与类增强&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;5 方法调用时在拦截器中创建追踪上下文，包括Segment、Span等，一个线程调用链路(Segment)中依次是 EntrySpan、LocalSpan、如果有调用其他服务返回时还有ExitSpan（是一个栈结构），方法调用完毕时（EntrySpan结束时）会通过 TraceSegmentServiceClient 先临时保存到 DataCarrier 的缓冲中&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;6 TraceSegmentServiceClient 内部是生产者消费者模式，通过消费者线程轮询从 DataCarrier 的缓冲拉取数据通过 gRPC 上报&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;7 gRPC Server 端配置（TODO）&lt;br&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="820" y="20" width="760" height="220" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-173" value="&lt;font&gt;IS_PLUGIN_INIT_COMPLETED = true;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="600" y="4000.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-178" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" target="CrG38wg852pacwZDw58O-177" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="690" y="4210" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-327" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-175" target="CrG38wg852pacwZDw58O-326" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-331" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-175" target="CrG38wg852pacwZDw58O-177" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-175" value="&lt;font&gt;bootedServices = loadAllServices();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;测试Demo中一共加载了20个BootService&lt;br&gt;里面包含一些数据Collector&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="600" y="4100.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-180" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-177" target="CrG38wg852pacwZDw58O-179" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-333" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-177" target="CrG38wg852pacwZDw58O-332" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-177" value="&lt;font&gt;prepare();&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="600" y="4180.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-182" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-179" target="CrG38wg852pacwZDw58O-181" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-335" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-179" target="CrG38wg852pacwZDw58O-334" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-179" value="&lt;font&gt;startup();&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="600" y="4260.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-337" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-181" target="CrG38wg852pacwZDw58O-336" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-181" value="&lt;font&gt;onComplete();&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="600" y="4340.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-220" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-183" target="CrG38wg852pacwZDw58O-194" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-183" value="&lt;b&gt;业务服务 main()&lt;/b&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;gradientColor=#97d077;" parent="1" vertex="1">
          <mxGeometry x="40" y="3800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-7" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;测试DEMO运行配置：&lt;br style=&quot;font-size: 10px;&quot;&gt;-javaagent:/home/lee/lib/skywalking/skywalking-agent/skywalking-agent.jar&lt;br style=&quot;font-size: 10px;&quot;&gt;环境变量：&lt;br style=&quot;font-size: 10px;&quot;&gt;SW_AGENT_NAME=demo-application;&lt;br style=&quot;font-size: 10px;&quot;&gt;SW_AGENT_COLLECTOR_BACKEND_SERVICES=127.0.0.1:11800;&lt;br style=&quot;font-size: 10px;&quot;&gt;SW_AGENT_SPAN_LIMIT=2000&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;agetArgs&lt;/b&gt; 可以通过 -javaagent:path/to/your/agent.jar=yourAgentArgs&amp;nbsp; 这种方式传入，测试demo中为null&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;instrumentation&lt;/b&gt; 是Java 虚拟机 Instrumentation 接口的实例，&lt;br style=&quot;font-size: 10px;&quot;&gt;它允许 JavaAgent 在字节码加载到 JVM 之前或之后对所有类进行查询、修改、转换等操作&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;关于如何调试 skywalking-agent.jar&lt;br style=&quot;font-size: 10px;&quot;&gt;最简单的方法可以将jar包加入Project Settings -&amp;gt; Libraries&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="311" width="300" height="239" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-187" value="&lt;font&gt;shutdown();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;关闭所有 BootService 组件、清理资源&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="600" y="5019.75" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-188" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;&lt;b&gt;installOn&lt;/b&gt;(instrumentation)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;安装转换器、监听器等到 sun.instrument.&lt;b&gt;TransformerManager&lt;/b&gt;&lt;br&gt;只是安装转换逻辑并没有执行&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="600" y="2880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-193" value="&lt;font style=&quot;font-size: 12px&quot;&gt;&lt;b&gt;增强执行时机&lt;/b&gt;：&lt;/font&gt;&lt;font&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;（并没有看ByteBuddy源码和Java Agent源码，这里是测试得知）&lt;/font&gt;&lt;br&gt;&lt;b style=&quot;font-size: 12px&quot;&gt;类加载阶段&lt;br&gt;&lt;/b&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;调用栈参考《Skywalking原理篇.md》1.1.3.2. 增强执行时机&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="840" y="3710" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-197" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-194" target="CrG38wg852pacwZDw58O-196" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-194" value="RestControllerInstrumentation&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;以mvc-annotation-5.x-plugin为例&lt;br&gt;看怎么一步步执行到类增强的操作&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="840" y="3801" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-199" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-196" target="CrG38wg852pacwZDw58O-198" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-196" value="SpringBoot Demo&lt;br&gt;Application#main()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1080" y="3801" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-201" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-198" target="CrG38wg852pacwZDw58O-200" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-198" value="AbstractApplicationContext#&lt;br&gt;refresh()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1320" y="3801.5" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-203" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-200" target="CrG38wg852pacwZDw58O-202" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-200" value="AbstractBeanDefinition#&lt;br&gt;resolveBeanClass()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1560" y="3801" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-205" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-202" target="CrG38wg852pacwZDw58O-204" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-202" value="ClassUtils#forName()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1800" y="3800.5" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-207" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-204" target="CrG38wg852pacwZDw58O-206" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-204" value="Launcher$AppClassLoader#loadClass()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2040" y="3800.5" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-209" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-206" target="CrG38wg852pacwZDw58O-208" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-206" value="ClassLoader#defineClass()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2280" y="3800.5" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-211" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-208" target="CrG38wg852pacwZDw58O-210" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-208" value="InstrumentationImpl#transform()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1080" y="3900.5" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-213" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-210" target="CrG38wg852pacwZDw58O-212" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-210" value="TransformerManager#transform()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1320" y="3900.5" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-215" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-212" target="CrG38wg852pacwZDw58O-214" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-212" value="AgentBuilder$Default$&lt;br&gt;ExecutingTransformer#transform()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1560" y="3900.5" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-217" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;" parent="1" source="CrG38wg852pacwZDw58O-214" target="CrG38wg852pacwZDw58O-216" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-214" value="AgentBuilder$Default$&lt;br&gt;ExecutingTransformer#doTransform()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1800" y="3900.5" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-218" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;fillColor=#d5e8d4;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-216" target="CrG38wg852pacwZDw58O-141" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2140" y="3980" />
              <mxPoint x="820" y="3980" />
              <mxPoint x="820" y="2653" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-216" value="SkyWalkingAgent$Transformer#&lt;br&gt;transform()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2040" y="3900.5" width="200" height="59.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-226" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-221" target="CrG38wg852pacwZDw58O-225" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-221" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;以 Spring RestControllerInstrumentation&lt;br&gt;为例&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1600" y="2720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-240" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-225" target="CrG38wg852pacwZDw58O-239" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-225" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;AbastractControllerInstrumentation#&lt;br&gt;enhanceClass()&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1840" y="2720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-234" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=blockThin;endFill=0;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-227" target="CrG38wg852pacwZDw58O-55" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-227" value="&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.&lt;/span&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;div style=&quot;text-align: center&quot;&gt;&lt;b&gt;ClassEnhancePluginDefine&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//实现增强实例方法逻辑（包括构造方法和其他实例方法）&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected DynamicType.Builder&amp;lt;?&amp;gt; &lt;b&gt;enhanceInstance&lt;/b&gt;(TypeDescription typeDescription,&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; DynamicType.Builder&amp;lt;?&amp;gt; newClassBuilder, ClassLoader classLoader,&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; EnhanceContext context) throws PluginException&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//实现增强静态方法逻辑&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected DynamicType.Builder&amp;lt;?&amp;gt; &lt;b&gt;enhanceClass&lt;/b&gt;(TypeDescription typeDescription,&amp;nbsp;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;span&gt;&#x9;&lt;/span&gt;&lt;span&gt;&#x9;&lt;/span&gt;DynamicType.Builder&amp;lt;?&amp;gt; newClassBuilder,&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ClassLoader classLoader) throws PluginException&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//获取实例方法拦截点，由各种插件子类重写&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;public InstanceMethodsInterceptV2Point[] &lt;b&gt;getInstanceMethodsInterceptV2Points&lt;/b&gt;()&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//获取静态方法拦截点，由各种插件子类重写&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;public StaticMethodsInterceptV2Point[] &lt;b&gt;getStaticMethodsInterceptV2Points&lt;/b&gt;()&lt;br&gt;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-540" y="2220" width="440" height="200" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-238" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=blockThin;endFill=0;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-228" target="CrG38wg852pacwZDw58O-229" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-228" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;span&gt;org.apache.skywalking.apm.plugin.spring.mvc.v5.define.&lt;/span&gt;&lt;/div&gt;&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center&quot;&gt;&lt;b&gt;RestControllerInstrumentation&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;//定义对哪个注解注释的类进行增强&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected String[] getEnhanceAnnotations()&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-540" y="2915" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-237" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=blockThin;endFill=0;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-229" target="CrG38wg852pacwZDw58O-232" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-229" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;span&gt;org.apache.skywalking.apm.plugin.spring.mvc.v5.define.&lt;/span&gt;&lt;/div&gt;&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center&quot;&gt;&lt;b&gt;AbstractControllerInstrumentation&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;定义了&lt;b&gt;构造器拦截点&lt;/b&gt;（内部包含&lt;b&gt;适配器&lt;/b&gt;和&lt;b&gt;拦截器类名&lt;/b&gt;）、&lt;b&gt;实例方法拦截点&lt;/b&gt;、&lt;b&gt;目标类适配器&lt;/b&gt;ClassMatch；&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;即定义了对哪个类增强（ClassMatch），对这个类的哪些构造方法和实例方法(ElementMatcher)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;怎么增强(Inteceptor)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;详细说明：&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;1 构造器拦截点：&lt;br&gt;对任意构造方法（any()）进行增强，增强逻辑参考：&lt;br&gt;org.apache.skywalking.apm.plugin.spring.mvc.v5.ControllerConstructorInterceptor&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;2 实例方法拦截点：&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;对 @RequestMapping 注解的方法进行增强，增强逻辑：&lt;br&gt;org.apache.skywalking.apm.plugin.spring.mvc.commons.interceptor.&lt;b&gt;RequestMappingMethodInterceptor&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;对 @GetMapping @PostMapping @PutMapping @DeleteMapping @PatchMapping注解的方法进行增强，增强逻辑：&lt;br&gt;org.apache.skywalking.apm.plugin.spring.mvc.commons.interceptor.&lt;b&gt;RestMappingMethodInterceptor&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;没有静态方法拦截点&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="2674.75" width="560" height="220" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-236" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=blockThin;endFill=0;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-232" target="CrG38wg852pacwZDw58O-233" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-232" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;span&gt;org.apache.skywalking.apm.plugin.spring.mvc.v5.define.&lt;/span&gt;&lt;/div&gt;&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center&quot;&gt;&lt;b&gt;AbstractSpring5Instrumentation&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//定义插件版本适配，这里是通过不同版本加载的差异化的类名，5.x是通过识别是否有加载&lt;br&gt;org.springframework.web.servlet.resource.HttpResource 这个类&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected final String[] witnessClasses()&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="2574.75" width="560" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-235" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=blockThin;endFill=0;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-233" target="CrG38wg852pacwZDw58O-227" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-233" value="&lt;div style=&quot;text-align: center&quot;&gt;org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.&lt;/div&gt;&lt;div style=&quot;text-align: center&quot;&gt;&lt;b&gt;ClassInstanceMethodsEnhancePluginDefine&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;//重写获取静态方法拦截点，默认返回null&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;public StaticMethodsInterceptPoint[] getStaticMethodsInterceptPoints()&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-540" y="2440" width="440" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-239" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;&lt;b&gt;ClassAnnotationMatch&lt;/b&gt;&lt;br&gt;.byClassAnnotationMatch(&lt;br&gt;getEnhanceAnnotations());&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2080" y="2720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-243" value="&lt;b&gt;匹配机制&lt;/b&gt;：&lt;br&gt;获取目标类型所有注解，然后判断是否包含当前增强类指定的注解" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="2285" y="2720.25" width="190" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-248" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-244" target="CrG38wg852pacwZDw58O-247" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-244" value="&lt;font style=&quot;line-height: 1&quot;&gt;WitnessFinder finder = WitnessFinder.INSTANCE;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1320" y="2820" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-251" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-247" target="CrG38wg852pacwZDw58O-250" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-257" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-247" target="CrG38wg852pacwZDw58O-256" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-247" value="&lt;font style=&quot;line-height: 1&quot;&gt;String[] witnessClasses = witnessClasses();&lt;br&gt;if (!finder.exist(witnessClass, classLoader){&lt;br&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;return null;&lt;br&gt;}&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1320" y="2900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-252" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-250" target="CrG38wg852pacwZDw58O-164" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-250" value="&lt;font style=&quot;line-height: 1&quot;&gt;List&amp;lt;WitnessMethod&amp;gt; witnessMethods = this.witnessMethods();&lt;br&gt;if (!finder.exist(witnessClass, classLoader){&lt;br&gt;&lt;span&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;return null;&lt;br&gt;}&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1320" y="2980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-253" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;flipH=1;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1770" y="2820" width="20" height="220" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-255" value="&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;span&gt;如果插件有多个版本，需要检查当前应该使用哪个版本;&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;span&gt;WitnewssFinder 就是做这个事情的，可以通过类名或方法名进行版本&lt;/span&gt;适配&lt;span&gt;，&lt;br&gt;比如&amp;nbsp;spring-mvc-annotation 插件有3个版本，如何检测当前应该使用哪个版本插件呢？&lt;/span&gt;&lt;br&gt;&lt;span&gt;spring-mvc-annotation-5.x&lt;br&gt;&lt;/span&gt;spring-mvc-annotation-4.x&lt;br&gt;spring-mvc-annotation-3.x&lt;br&gt;三个版本的插件通过在 witnesssClasses()、witnessMethods() 定义差异化的类或方法，然后读取类加载器加载的类或方法是否存在来区分版本的（信息都存在TypePool），如果当前插件是这个版本就使用这个插件进行增强&amp;nbsp;&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1800" y="2870" width="400" height="127.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-256" value="&lt;font style=&quot;line-height: 1&quot;&gt;typePool.describe(witnessClass)&lt;br&gt;.isResolved()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;typePool中是否包含版本差异化的类&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1560" y="2900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-258" value="&lt;p style=&quot;margin: 4px 0px 0px ; text-align: center ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;span style=&quot;font-size: 10px&quot;&gt;org.apache.skywalking.apm.agent.core.plugin.&lt;/span&gt;&lt;/font&gt;&lt;b&gt;WitnessFinder&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;ClassLoader -&amp;gt; TypePool 的Map容器，TypePool 是 ByteBuddy 保存类行信息的容器&lt;br&gt;这个类用于当有多个版本插件时，根据插件中定义的类型差异化信息和实际加载的信息对比，&lt;br&gt;选择合适的插件版本，更多查 Skywalking Witness 机制，原理其实比较简单&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final Map&amp;lt;ClassLoader, TypePool&amp;gt; &lt;b&gt;poolMap&lt;/b&gt; = new HashMap&amp;lt;ClassLoader, TypePool&amp;gt;();&lt;/font&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1160" y="1800" width="480" height="100" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-259" value="&lt;font color=&quot;#007fff&quot;&gt;比如测试Demo中匹配的是 &lt;br&gt;spring-mvc-annotation-5.x&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#330000;" parent="1" vertex="1">
          <mxGeometry x="1350" y="3140" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-263" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-260" target="CrG38wg852pacwZDw58O-262" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-267" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-260" target="CrG38wg852pacwZDw58O-266" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-260" value="&lt;font style=&quot;line-height: 1&quot;&gt;StaticMethodsInterceptPoint[] staticMethodsInterceptPoints = getStaticMethodsInterceptPoints();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;获取静态方法拦截点&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1800" y="3080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-265" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-262" target="CrG38wg852pacwZDw58O-264" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-262" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;以 Spring RestControllerInstrumentation&lt;br&gt;为例&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2040" y="3080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-264" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;return null;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2280" y="3080" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-269" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-266" target="CrG38wg852pacwZDw58O-268" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-266" value="&lt;font style=&quot;line-height: 1&quot;&gt;如果静态方法拦截点不为空&lt;br&gt;适配方法和增强逻辑并拦截增强&lt;br&gt;.method(...).intercept(...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;DEMO中没有静态方法先略过这个&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1800" y="3160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-268" value="&lt;font style=&quot;line-height: 1&quot;&gt;&lt;div&gt;newClassBuilder = newClassBuilder.method(&lt;br&gt;isStatic().and(staticMethodsInterceptPoint.getMethodsMatcher()))&lt;/div&gt;&lt;div&gt;.intercept(MethodDelegation.withDefaultConfiguration()...);&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2040" y="3160" width="320" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-275" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-270" target="CrG38wg852pacwZDw58O-274" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-270" value="&lt;font style=&quot;font-size: 8px&quot;&gt;ConstructorInterceptPoint[] &lt;b&gt;constructorInterceptPoints&lt;/b&gt; = getConstructorsInterceptPoints();&lt;br&gt;InstanceMethodsInterceptPoint[] &lt;b&gt;instanceMethodsInterceptPoints&lt;/b&gt; = getInstanceMethodsInterceptPoints();&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1800" y="3260" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-277" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-274" target="CrG38wg852pacwZDw58O-276" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-274" value="&lt;div&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;newClassBuilder = newClassBuilder.defineField(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;CONTEXT_ATTR_NAME, Object.class, ACC_PRIVATE | ACC_VOLATILE)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;.implement(&lt;b&gt;EnhancedInstance&lt;/b&gt;.class)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;.intercept(FieldAccessor.ofField(CONTEXT_ATTR_NAME));&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;给类添加一个 private volatile 实现了 &lt;b&gt;EnhancedInstance&amp;nbsp;&lt;/b&gt;接口类型的字段&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry x="1800" y="3340" width="280" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-279" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-276" target="CrG38wg852pacwZDw58O-278" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-288" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;dashed=1;" parent="1" source="CrG38wg852pacwZDw58O-276" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2120" y="3480" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-276" value="&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;/div&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;for &lt;b&gt;constructorInterceptPoints&lt;/b&gt;:&lt;br style=&quot;font-size: 8px&quot;&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;newClassBuilder = newClassBuilder.&lt;b style=&quot;font-size: 8px&quot;&gt;constructor&lt;/b&gt;(&lt;br&gt;constructorInterceptPoint.getConstructorMatcher())&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;.&lt;b style=&quot;font-size: 8px&quot;&gt;intercept&lt;/b&gt;(SuperMethodCall.INSTANCE.andThen(&lt;br&gt;MethodDelegation.withDefaultConfiguration()&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;.&lt;b&gt;to&lt;/b&gt;(new &lt;b&gt;ConstructorInter&lt;/b&gt;(constructorInterceptPoint&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;.getConstructorInterceptor(), classLoader))));&lt;br style=&quot;font-size: 8px&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;构造方法增强（有两个分支只展示其中一个），&lt;b&gt; TODO 测试 to()&lt;/b&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=8;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1800" y="3440" width="280" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-307" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;dashed=1;" parent="1" source="CrG38wg852pacwZDw58O-278" target="CrG38wg852pacwZDw58O-308" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2120" y="3640" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-278" value="&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;/div&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;for &lt;b&gt;instanceMethodsInterceptPoints&lt;/b&gt;:&lt;br style=&quot;font-size: 8px&quot;&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;div&gt;newClassBuilder = newClassBuilder.&lt;b&gt;method&lt;/b&gt;(junction)&lt;/div&gt;&lt;div&gt;.&lt;b&gt;intercept&lt;/b&gt;(MethodDelegation.withDefaultConfiguration()&lt;/div&gt;&lt;div&gt;.to(new InstMethodsInter(interceptor, classLoader)));&lt;/div&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 8px&quot;&gt;其他实例方法增强（有四个分支这里只展示其中一个）&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=8;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1800" y="3600" width="280" height="80" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-280" value="&lt;b&gt;ClassEnhancePluginDefine&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=8;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1880" y="3240" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-284" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-281" target="CrG38wg852pacwZDw58O-283" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-281" value="&lt;font style=&quot;line-height: 1&quot;&gt;context.initializationStageCompleted();&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1080" y="2920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-283" value="&lt;font style=&quot;line-height: 1&quot;&gt;return &lt;b&gt;newClassBuilder&lt;/b&gt;;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="1080" y="3000" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-291" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-289" target="CrG38wg852pacwZDw58O-290" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-289" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;以 Spring RestControllerInstrumentation&lt;br&gt;为例&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2120" y="3450" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-293" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-290" target="CrG38wg852pacwZDw58O-292" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-290" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;constructorInterceptPoint&lt;br&gt;.getConstructorMatcher()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;方法实现是any() ，即匹配任何构造方法&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2360" y="3450" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-297" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-292" target="CrG38wg852pacwZDw58O-296" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-292" value="&lt;font style=&quot;font-size: 9px&quot;&gt;增强逻辑是 先执行 super() 父构造器，&lt;br&gt;然后加载并委托给拦截点类constructorInterceptPoint中的拦截器&lt;b&gt;ControllerConstructorInterceptor&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry x="2360" y="3530" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-295" value="&lt;b&gt;ConstructorInter&lt;/b&gt; 用于加载 Interceptor 类，另外定义了委托方法：&lt;br&gt;&lt;div&gt;@RuntimeType&lt;/div&gt;&lt;div&gt;&lt;span&gt;public void &lt;b&gt;intercept&lt;/b&gt;(@This Object obj, @AllArguments Object[] allArguments) { ...}&lt;/span&gt;&lt;/div&gt;&lt;div&gt;没看Byte Buddy 源码是怎么将这个方法作为委托方法的，不过确实是这个方法&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="2080" y="3520" width="250" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-299" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-296" target="CrG38wg852pacwZDw58O-298" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-296" value="&lt;font size=&quot;1&quot;&gt;interceptor.onConstruct(targetObject, allArguments)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2600" y="3530" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-322" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#82b366;fillColor=#d5e8d4;" parent="1" source="CrG38wg852pacwZDw58O-298" target="CrG38wg852pacwZDw58O-274" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-324" value="存储" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=9;fontColor=#007FFF;" parent="CrG38wg852pacwZDw58O-322" vertex="1" connectable="0">
          <mxGeometry x="-0.8448" y="-3" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-298" value="功能是将 @RequestMapping 注解中的&lt;br&gt;&lt;b&gt;basePath&lt;/b&gt; 存到&amp;nbsp;&lt;b&gt;EnhanceRequireObjectCache&lt;/b&gt; 缓存对象中并赋值给新增的动态字段" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2840" y="3530" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-300" value="&lt;b&gt;ContructorInter&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="2655" y="3510" width="90" height="20" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-301" value="&lt;b&gt;ControllerConstructorInterceptor&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="2860" y="3510" width="160" height="20" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-303" value="1&amp;nbsp;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#330000;" parent="1" vertex="1">
          <mxGeometry x="840" y="2680" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-305" value="mvc-annotation-5.x-plugin&amp;nbsp;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;fontColor=#330000;" parent="1" vertex="1">
          <mxGeometry x="-600" y="2540" width="130" height="20" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-310" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-308" target="CrG38wg852pacwZDw58O-309" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-308" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;以 Spring RestControllerInstrumentation&lt;br&gt;为例&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2120" y="3610" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-313" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-309" target="CrG38wg852pacwZDw58O-312" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-309" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;not(isStatic()).and(&lt;br&gt;instanceMethodsInterceptPoint&lt;br&gt;.getMethodsMatcher())&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2360" y="3610" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-315" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-312" target="CrG38wg852pacwZDw58O-314" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-312" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;增强逻辑是 加载并委托给实例方法拦截器&amp;nbsp;&lt;/font&gt;&lt;br&gt;&lt;font size=&quot;1&quot;&gt;RequestMappingMethodInterceptor&lt;br&gt;&lt;/font&gt;&lt;b&gt;RestMappingMethodInterceptor&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#e1d5e7;strokeColor=#9673a6;" parent="1" vertex="1">
          <mxGeometry x="2360" y="3690" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-317" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-314" target="CrG38wg852pacwZDw58O-316" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-367" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-314" target="CrG38wg852pacwZDw58O-364" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-314" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;interceptor.&lt;b&gt;beforeMethod&lt;/b&gt;(targetObject, method, allArguments, method.getParameterTypes(), result);&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2600" y="3690" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-319" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-316" target="CrG38wg852pacwZDw58O-318" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-316" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;result.isContinue()&lt;br&gt;&lt;/font&gt;ret = zuper.call();&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2600" y="3770" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-321" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-318" target="CrG38wg852pacwZDw58O-320" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-318" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;catch:&lt;br&gt;&lt;/font&gt;interceptor.&lt;b&gt;handleMethodException&lt;/b&gt;(&lt;br&gt;targetObject, method, allArguments, method.getParameterTypes(), t)&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2600" y="4320.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-368" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-320" target="CrG38wg852pacwZDw58O-353" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-320" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;finally:&lt;br&gt;&lt;/font&gt;ret = interceptor.&lt;b&gt;afterMethod&lt;/b&gt;(&lt;br&gt;targetObject, method, allArguments, method.getParameterTypes(), ret)&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2600" y="4400.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-325" value="这个动态字段就是传值用的" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="2080" y="3350" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-329" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-326" target="CrG38wg852pacwZDw58O-328" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-326" value="&lt;font&gt;load(allServices)&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="840" y="4100.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-328" value="&lt;font&gt;ServiceLoader.load(&lt;b&gt;BootService&lt;/b&gt;.class, AgentClassLoader.getDefault())&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;通过SPI机制使用AgentClassLoader加载所有BootService类&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1080" y="4100.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-330" value="@DefaultImplementor 注解的BootService&lt;br&gt;可以被&amp;nbsp;OverrideImplementor 注解的BootSerivce覆盖" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1280" y="4115.5" width="230" height="30" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-332" value="&lt;font&gt;先对 bootedService 按照&amp;nbsp;priority() 排序,&lt;br&gt;然后遍历执行各服务的 prepare() 方法&lt;br&gt;service.&lt;b&gt;prepare&lt;/b&gt;()&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="840" y="4180.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-334" value="&lt;font&gt;同上然后遍历执行&amp;nbsp;&lt;br&gt;service.&lt;b&gt;boot&lt;/b&gt;()&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="840" y="4260.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-336" value="&lt;font&gt;同上然后遍历执行&lt;br&gt;service.&lt;b&gt;onComplete&lt;/b&gt;()&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="840" y="4340.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-341" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-338" target="CrG38wg852pacwZDw58O-340" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-338" value="&lt;font style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;&amp;nbsp;StackDepth stackDepth = (StackDepth) &lt;b&gt;ContextManager&lt;/b&gt;.getRuntimeContext()&lt;br&gt;.get(CONTROLLER_METHOD_STACK_DEPTH);&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2840" y="3770" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-343" value="Y, 即首次调用" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-340" target="CrG38wg852pacwZDw58O-342" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="3030" y="4010" />
              <mxPoint x="3030" y="3870" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-350" value="N" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-340" target="CrG38wg852pacwZDw58O-349" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-352" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-340" target="CrG38wg852pacwZDw58O-351" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-340" value="request == null" style="rhombus;whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2900" y="3980" width="80" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-345" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-342" target="CrG38wg852pacwZDw58O-344" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-342" value="ContextCarrier contextCarrier&amp;nbsp;= new ContextCarrier();" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="3140" y="3840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-348" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-344" target="CrG38wg852pacwZDw58O-347" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-371" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-344" target="CrG38wg852pacwZDw58O-370" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-344" value="&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;String &lt;b&gt;operationName&lt;/b&gt; = this.buildOperationName(method, &lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;httpServletRequest.getMethod(),&amp;nbsp;&lt;span&gt;(EnhanceRequireObjectCache)&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;&lt;span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;objInst.getSkyWalkingDynamicField());&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot; color=&quot;#007fff&quot;&gt;&lt;span&gt;//创建入口Span EntrySpan&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;AbstractSpan &lt;b&gt;span&lt;/b&gt; = ContextManager.&lt;b&gt;createEntrySpan&lt;/b&gt;(operationName, contextCarrier);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot; color=&quot;#007fff&quot;&gt;//记录URL、Method类型、Component、&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;Tags.URL.set(span, httpServletRequest.getRequestURL().toString());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;Tags.HTTP.METHOD.set(span, httpServletRequest.getMethod());&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;span.setComponent(ComponentsDefine.SPRING_MVC_ANNOTATION);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;SpanLayer.asHttp(span);&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=5;align=left;" parent="1" vertex="1">
          <mxGeometry x="3080" y="3920" width="320" height="120" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-423" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-347" target="CrG38wg852pacwZDw58O-422" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-347" value="&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;div&gt;if (SpringMVCPluginConfig.Plugin.SpringMVC.COLLECT_HTTP_PARAMS) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; RequestUtil.collectHttpParam(httpServletRequest, span);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;if (!CollectionUtil.isEmpty(SpringMVCPluginConfig.Plugin.&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;Http.INCLUDE_HTTP_HEADERS)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; RequestUtil.collectHttpHeaders(httpServletRequest, span);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;额外收集参数、请求头信息&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=5;align=left;" parent="1" vertex="1">
          <mxGeometry x="3080" y="4055" width="320" height="95" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-349" value="&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;AbstractSpan span = ContextManager.&lt;b&gt;createLocalSpan&lt;/b&gt;(buildOperationName(objInst, method));&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;span.setComponent(ComponentsDefine.SPRING_MVC_ANNOTATION);&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="3080" y="4250" width="320" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-351" value="stackDepth.increment();" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2840" y="4320.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-356" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-353" target="CrG38wg852pacwZDw58O-355" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-353" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;StackDepth &lt;b&gt;stackDepth&lt;/b&gt; = (StackDepth) runtimeContext.get(&lt;br&gt;CONTROLLER_METHOD_STACK_DEPTH);&lt;br&gt;&lt;/font&gt;stackDepth.&lt;b&gt;decrement&lt;/b&gt;();&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2840" y="4400.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-358" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-355" target="CrG38wg852pacwZDw58O-357" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-355" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;AbstractSpan span = ContextManager.activeSpan();&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2840" y="4480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-360" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-357" target="CrG38wg852pacwZDw58O-359" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-357" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;if (stackDepth.depth() == 0)&lt;br&gt;清理 RuntimeContext&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2840" y="4560.25" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-362" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" parent="1" source="CrG38wg852pacwZDw58O-359" target="CrG38wg852pacwZDw58O-363" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2940" y="4760" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-359" value="&lt;font style=&quot;font-size: 8px&quot;&gt;&lt;div&gt;if (!SpringMVCPluginConfig.Plugin.SpringMVC.COLLECT_HTTP_PARAMS&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&amp;amp;&amp;amp; span.isProfiling()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (HttpServletRequest.class.isAssignableFrom(request.getClass())) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RequestUtil.&lt;b&gt;collectHttpParam&lt;/b&gt;((HttpServletRequest) request, span);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; } else if (ServerHttpRequest.class.isAssignableFrom(request.getClass())) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; RequestUtil.&lt;b&gt;collectHttpParam&lt;/b&gt;((ServerHttpRequest) request, span);&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=4;" parent="1" vertex="1">
          <mxGeometry x="2800" y="4640" width="280" height="100" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-400" value="" style="edgeStyle=none;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#330000;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-363" target="CrG38wg852pacwZDw58O-399" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-363" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;finally:&lt;br&gt;&lt;/font&gt;ContextManager.stopSpan();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;当所有活跃的 Span 都被结束后，当前线程的 TraceSegment 完成&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2840" y="4760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-366" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-364" target="CrG38wg852pacwZDw58O-338" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-364" value="&lt;font style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;Object request = ContextManager.getRuntimeContext()&lt;br&gt;.get(REQUEST_KEY_IN_RUNTIME_CONTEXT);&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2840" y="3690" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-369" value="request 是被 GetBeanInterceptor&amp;nbsp; &lt;br&gt;或 InvokeHandlerMethodInterceptor&amp;nbsp; 写入的&amp;nbsp;&lt;br&gt;TODO 确认" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="3050" y="3700" width="200" height="40" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-405" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-370" target="CrG38wg852pacwZDw58O-404" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-408" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-370" target="CrG38wg852pacwZDw58O-407" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-370" value="&lt;font size=&quot;1&quot;&gt;context = &lt;b&gt;getOrCreate&lt;/b&gt;(&lt;br&gt;operationName, true);&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;context 即 TraceContext, 保存在 ContextManager&amp;nbsp;CONTEXT&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=12;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3440" y="3949.75" width="200" height="60.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-372" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;span&gt;org.apache.skywalking.apm.agent.core.context.&lt;/span&gt;&lt;b&gt;ContextManager&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;ContextManager控制TraceSegment的整个上下文。&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private static final String &lt;b&gt;EMPTY_TRACE_CONTEXT_ID&lt;/b&gt; = &quot;N/A&quot;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//追踪上下文信息(ThreadLocal 存储 TracingContext)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private static ThreadLocal&amp;lt;AbstractTracerContext&amp;gt; &lt;b&gt;CONTEXT&lt;/b&gt; = new ThreadLocal&amp;lt;AbstractTracerContext&amp;gt;();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//运行时上下文信息，是一个HashMap容器，存储栈TracingContext栈深度等信息&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private static ThreadLocal&amp;lt;RuntimeContext&amp;gt; &lt;b&gt;RUNTIME_CONTEXT&lt;/b&gt; = new ThreadLocal&amp;lt;RuntimeContext&amp;gt;();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private static ContextManagerExtendService &lt;b&gt;EXTEND_SERVICE&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="3240" width="520" height="120" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-373" value="&lt;div&gt;&lt;b&gt;CONTEXT 保存Trace上下文信息 ( TracingContext )：&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;result = {TracingContext@10266}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;lastWarningTimestamp = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;segment&lt;/b&gt; = {&lt;b&gt;TraceSegment&lt;/b&gt;@10268} &quot;TraceSegment{traceSegmentId=&#39;b327dabf42ab432fb69e6ac26b1c25b2.53.16896932079200000&#39;, ref=null, spans=[]}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;activeSpanStack&lt;/b&gt; = {LinkedList@10269}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; 0 = {&lt;b&gt;EntrySpan&lt;/b&gt;@10299}&amp;nbsp;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;//入口Span&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;currentMaxDepth = 2&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;&lt;span style=&quot;white-space: pre&quot;&gt;&#x9;&lt;/span&gt;//深度为何是2？因为先被tomcat的插件拦截了&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;stackDepth = 2&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;peer = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;spanId = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;parentSpanId = -1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;tags&lt;/b&gt; = {ArrayList@10362}&amp;nbsp; size = 2&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;operationName&lt;/b&gt; = &quot;GET:/demo/echo&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&lt;b&gt;layer&lt;/b&gt; = {SpanLayer@10304} &quot;HTTP&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;isInAsyncMode = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;isAsyncStopped = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;owner = {TracingContext@10266}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;startTime = 1689693207922&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;endTime = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;errorOccurred = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;componentId = 14&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;logs = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;refs = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;skipAnalysis = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;primaryEndpoint&lt;/b&gt; = {TracingContext$PrimaryEndpoint@10270}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; span = {EntrySpan@10299}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; this$0 = {TracingContext@10266}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;spanIdGenerator = 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;asyncSpanCounter = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;isRunningInAsyncMode = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;asyncFinishLock = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;running = true&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;createTime = 1689693207921&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;profileStatus = {ProfileStatusReference@10271}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;correlationContext = {CorrelationContext@10272}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;extensionContext = {ExtensionContext@10273}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;spanLimitWatcher = {SpanLimitWatcher@10274} &quot;AgentConfigChangeWatcher{propertyKey=&#39;agent.span_limit_per_segment&#39;}&quot;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#330000;" parent="1" vertex="1">
          <mxGeometry x="-1160" y="3547" width="520" height="438" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-376" value="这部分表示给原方法环绕（Around）增强, 添加符合 OpenTracing 标准的 Tracing 信息到线程本地变量，即ContextManager CONTEXT&lt;br&gt;&lt;br&gt;大概率 RestMappingMethodInterceptor 并不是此线程中的第一个拦截器，所以调试时会发现执行到右边时 CONTEXT EntrySpan 都已经初始化了，还看到 EntrySpan 最大栈深是2（已验证前面先被Tomcat插件拦截了）&lt;br&gt;&lt;font color=&quot;#ff3333&quot;&gt;&lt;br&gt;验证：把其他插件都禁止加载, 可以通过&lt;br&gt;&lt;font style=&quot;font-size: 10px ; text-align: center&quot;&gt;Config.Plugin.&lt;/font&gt;&lt;font style=&quot;font-size: 10px ; text-align: center&quot;&gt;EXCLUDE_PLUGINS排除插件&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="2710" y="3880" width="190" height="160" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-379" value="" style="rounded=0;whiteSpace=wrap;html=1;fontSize=9;fontColor=#FF3333;" parent="1" vertex="1">
          <mxGeometry x="-1160" y="2540" width="530" height="475" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-381" value="tomcat-10x-plugin-8.14.0.&amp;nbsp; (demo SpringBoot2.2.2 内置Tomcat9.0.29)" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;fontColor=#330000;" parent="1" vertex="1">
          <mxGeometry x="-1160" y="2540" width="300" height="20" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-15" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;endArrow=blockThin;endFill=0;" edge="1" parent="1" source="CrG38wg852pacwZDw58O-382" target="CrG38wg852pacwZDw58O-233">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-382" value="&lt;div style=&quot;text-align: center&quot;&gt;org.apache.skywalking.apm.plugin.tomcat10x.define.&lt;b&gt;TomcatInstrumentation&lt;/b&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;定义了&lt;b&gt;构造器拦截点&lt;/b&gt;（内部包含&lt;b&gt;适配器&lt;/b&gt;和&lt;b&gt;拦截器类名&lt;/b&gt;）、&lt;b&gt;实例方法拦截点&lt;/b&gt;、&lt;b&gt;目标类适配器&lt;/b&gt;ClassMatch；&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;即定义了对哪个类增强（ClassMatch），对这个类的哪些构造方法和实例方法(ElementMatcher)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;怎么增强(Inteceptor)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;详细说明：&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;1 构造器拦截点：&lt;br&gt;对任意构造方法（any()）进行增强，增强逻辑参考：&lt;br&gt;org.apache.skywalking.apm.plugin.spring.mvc.v5.ControllerConstructorInterceptor&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;2 实例方法拦截点：&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;对 @RequestMapping 注解的方法进行增强，增强逻辑：&lt;br&gt;org.apache.skywalking.apm.plugin.spring.mvc.commons.interceptor.&lt;b&gt;RequestMappingMethodInterceptor&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;对 @GetMapping @PostMapping @PutMapping @DeleteMapping @PatchMapping注解的方法进行增强，增强逻辑：&lt;br&gt;org.apache.skywalking.apm.plugin.spring.mvc.commons.interceptor.&lt;b&gt;RestMappingMethodInterceptor&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;没有静态方法拦截点&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px ; font-size: 10px&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1150" y="2574.75" width="510" height="220" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-383" value="&lt;div style=&quot;text-align: center&quot;&gt;org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan.&lt;b&gt;AsyncSpan&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="3706" width="520" height="39" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-385" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=block;endFill=0;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-384" target="CrG38wg852pacwZDw58O-383" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-384" value="&lt;div style=&quot;text-align: center&quot;&gt;org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan.&lt;b&gt;AbstractSpan&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="3766.5" width="520" height="39" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-387" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=block;endFill=0;strokeColor=#330000;dashed=1;" parent="1" source="CrG38wg852pacwZDw58O-386" target="CrG38wg852pacwZDw58O-384" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-386" value="&lt;div style=&quot;text-align: center&quot;&gt;org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan.&lt;b&gt;AbstractTracingSpan&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//从0开始&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected int &lt;b&gt;spanId&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//父spanId, -1表示没有父span&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected int &lt;b&gt;parentSpanId&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//标签集合，键值对形式&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected List&amp;lt;TagValuePair&amp;gt; &lt;b&gt;tags&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//操作名&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected String &lt;b&gt;operationName&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//相当于操作类型，目前定义了这5种：DB 、RPC_FRAMEWORK 、HTTP 、MQ、CACHE&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected SpanLayer &lt;b&gt;layer&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//表示当前异步操作是否已经开始&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected volatile boolean isInAsyncMode = false;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//表示当前异步操作是否已经结束&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile boolean isAsyncStopped = false;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//此span位于的TracingContext&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected final TracingContext &lt;b&gt;owner&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected long startTime;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected long endTime;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//采集Span信息过程中是否发生错误&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected boolean errorOccurred = false;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//所属插件组件ID&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected int &lt;b&gt;componentId&lt;/b&gt; = 0;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected List&amp;lt;LogDataEntity&amp;gt; logs;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//用于当前span指定自己所在的segment的前一个segment,&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//除非这个span所在的segment是整条链路上的第一个segment&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected List&amp;lt;TraceSegmentRef&amp;gt; &lt;b&gt;refs&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected boolean skipAnalysis;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="3825" width="520" height="360" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-389" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=block;endFill=0;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-388" target="CrG38wg852pacwZDw58O-386" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-388" value="&lt;div style=&quot;text-align: center&quot;&gt;org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan.&lt;b&gt;StackBasedTracingSpan&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;官方注释说：代表具有内部堆栈结构的Span, 其实只是代表栈的节点，栈的数据结构体现在Trace上下文中&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//当前Span在栈中的深度&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected int &lt;b&gt;stackDepth&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//对端地址，比如一次RPC,对端地址就是RPC Server 的地址&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;protected String peer;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="4204" width="520" height="121" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-391" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=block;endFill=0;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-390" target="CrG38wg852pacwZDw58O-388" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-390" value="&lt;div style=&quot;text-align: center&quot;&gt;org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan.&lt;b&gt;EntrySpan&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//栈的最大深度&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private int &lt;b&gt;currentMaxDepth&lt;/b&gt;;&lt;/font&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="4345" width="520" height="79" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-395" style="edgeStyle=none;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=block;endFill=0;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-392" target="CrG38wg852pacwZDw58O-386" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-392" value="&lt;div style=&quot;text-align: center&quot;&gt;org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan.&lt;b&gt;LocalSpan&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="4206" width="400" height="79" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-394" style="rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=block;endFill=0;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-393" target="CrG38wg852pacwZDw58O-388" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-393" value="&lt;div style=&quot;text-align: center&quot;&gt;org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan.&lt;b&gt;ExitSpan&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;br&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="4345" width="400" height="79" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-397" value="仅从代码看很难理解 EntrySpan LocalSpan ExitSpan 的关系，以及数据结构上的联系，还是写个测试，将这几种Span一起调试下" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#007FFF;fontStyle=1" parent="1" vertex="1">
          <mxGeometry x="-1040" y="4105" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-475" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#FF3333;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-399" target="CrG38wg852pacwZDw58O-474" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-399" value="&lt;font&gt;&lt;font size=&quot;1&quot;&gt;AbstractTracerContext context = get();&lt;br&gt;&lt;/font&gt;&lt;b&gt;stopSpan&lt;/b&gt;(context.activeSpan(), context);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;即关闭当前栈顶的Span, 如果栈为空的话（即关闭的是栈底的Span），还需要清空 CONTEXT、RUNTIME_CONTEXT上下文&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3080" y="4760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-403" value="&lt;div&gt;&lt;b&gt;RUNTIME_CONTEXT 保存信息：&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;font color=&quot;#007fff&quot;&gt;比如拦截Spring Controller 方法时，保存的是请求和响应对象：&lt;/font&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;context = {ConcurrentHashMap@10041}&amp;nbsp; size = 2&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;SW_RESPONSE&quot; -&amp;gt; {ResponseFacade@10056}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&quot;SW_REQUEST&quot; -&amp;gt; {RequestFacade@10046}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#330000;" parent="1" vertex="1">
          <mxGeometry x="-1155" y="4005.5" width="520" height="68.75" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-415" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#330000;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-404" target="CrG38wg852pacwZDw58O-414" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-421" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-404" target="CrG38wg852pacwZDw58O-420" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-404" value="&lt;div style=&quot;&quot;&gt;&lt;span&gt;span = context.&lt;/span&gt;&lt;b&gt;createEntrySpan&lt;/b&gt;&lt;span&gt;(&lt;br&gt;operationName);&lt;/span&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=11;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3440" y="4030" width="200" height="60.75" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-406" value="从这里往后面是把拦截Controller 方法的其他插件都删除了，只执行 SpringMVC插件的执行流程，看下 TraceContext 上下文创建和 Span 创建的流程" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="3440" y="3900.5" width="240" height="40" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-407" value="&lt;div style=&quot;text-align: left ; font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;&amp;nbsp;AbstractTracerContext context = &lt;b&gt;CONTEXT&lt;/b&gt;.get();&lt;/font&gt;&lt;/div&gt;&lt;font&gt;&lt;div style=&quot;font-size: 8px ; text-align: left&quot;&gt;&lt;span&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;EXTEND_SERVICE = ServiceManager.INSTANCE.findService(&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;text-align: left&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;&lt;b&gt;ContextManagerExtendService&lt;/b&gt;.class);&lt;br&gt;context = EXTEND_SERVICE.&lt;b&gt;createTraceContext&lt;/b&gt;(operationName, forceSampling);&lt;br&gt;&lt;/font&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;&lt;b&gt;CONTEXT&lt;/b&gt;.set(context);&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=6;align=center;" parent="1" vertex="1">
          <mxGeometry x="3680" y="3949.75" width="320" height="60.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-409" value="&lt;font&gt;ContextManager&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个BootService组件用于存储 TraceContext、运行时上下文数据&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="600" y="4440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-410" value="&lt;font&gt;ContextManagerExtendService&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这个组件用于创建TraceContext&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="600" y="4520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-411" value="SkyWalkingAgent 用于拦截目标方法，&lt;br&gt;收集追踪数据，并上报&lt;br&gt;数据的收集、上报还需要依赖一些其他组件实现，&lt;br&gt;这里就是启动这些组件" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=8;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="420" y="4165.5" width="190" height="50" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-509" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-412" target="CrG38wg852pacwZDw58O-494" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-523" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;dashed=1;" parent="1" source="CrG38wg852pacwZDw58O-412" target="CrG38wg852pacwZDw58O-522" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-528" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;dashed=1;" parent="1" source="CrG38wg852pacwZDw58O-412" target="CrG38wg852pacwZDw58O-521" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-412" value="&lt;font&gt;TraceSegmentServiceClient&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="600" y="4600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-413" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;span&gt;org.apache.skywalking.apm.agent.core.context.&lt;/span&gt;&lt;b&gt;TracingContext&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;这里才是真正实现了栈&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private long lastWarningTimestamp = 0;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private static ProfileTaskExecutionService PROFILE_TASK_EXECUTION_SERVICE;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//它是与当前 Context 上下文关联的 TraceSegment 对象&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private TraceSegment &lt;b&gt;segment&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//用于记录当前 TraceSegment 中所有活跃的 Span（即未关闭的 Span）, 这个就是栈本身&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private LinkedList&amp;lt;AbstractSpan&amp;gt; &lt;b&gt;activeSpanStack&lt;/b&gt; = new LinkedList&amp;lt;&amp;gt;();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private PrimaryEndpoint &lt;b&gt;primaryEndpoint&lt;/b&gt; = null;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//其实是计数器，每生成一个新的span, 就 +1&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private int &lt;b&gt;spanIdGenerator&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile int asyncSpanCounter;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private static final AtomicIntegerFieldUpdater&amp;lt;TracingContext&amp;gt; ASYNC_SPAN_COUNTER_UPDATER =&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&amp;nbsp; &amp;nbsp; AtomicIntegerFieldUpdater.newUpdater(TracingContext.class, &quot;asyncSpanCounter&quot;);&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile boolean isRunningInAsyncMode;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile ReentrantLock asyncFinishLock;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile boolean running;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final long createTime;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final ProfileStatusReference profileStatus;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final CorrelationContext correlationContext;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final ExtensionContext extensionContext;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final SpanLimitWatcher spanLimitWatcher;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1160" y="3240" width="520" height="300" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-417" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-414" target="CrG38wg852pacwZDw58O-416" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-414" value="&lt;div&gt;先通过spanIdGenerator判断span数量是否达到上限，默认最多好像3000，达到上线后创建 NoopSpan就是空span, 然后推到activeSpanStack里，然后return&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=6;align=center;" parent="1" vertex="1">
          <mxGeometry x="3680" y="4030" width="200" height="60.75" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-416" value="&lt;div&gt;entrySpan = new &lt;b&gt;EntrySpan&lt;/b&gt;(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; spanIdGenerator++, parentSpanId,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; operationName, owner&lt;/div&gt;&lt;div&gt;);&lt;/div&gt;&lt;div&gt;return push(entrySpan);&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=6;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3680" y="4109.75" width="200" height="60.75" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-420" value="context.extract(carrier)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;从Carrier提取TraceId等信息赋值到当前&lt;br&gt;TraceSegment, 设置当前span segment-ref即前一个Segment, 提取拓展、关联信息。&lt;br&gt;即传播上下文信息&lt;br&gt;&lt;/font&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=11;align=center;" parent="1" vertex="1">
          <mxGeometry x="3440" y="4109.75" width="200" height="60.75" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-422" value="&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;stackDepth = new StackDepth();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;ContextManager.&lt;b&gt;getRuntimeContext&lt;/b&gt;()&lt;br&gt;.put(&lt;b&gt;CONTROLLER_METHOD_STACK_DEPTH&lt;/b&gt;, &lt;b&gt;stackDepth&lt;/b&gt;);&lt;/font&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="3140" y="4170.5" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-426" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-424" target="CrG38wg852pacwZDw58O-425" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-431" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-424" target="CrG38wg852pacwZDw58O-427" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-432" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-424" target="CrG38wg852pacwZDw58O-429" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-424" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;TraceAnnotationMethodInterceptor&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;@Trace 拦截器&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2120" y="4860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-434" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-425" target="CrG38wg852pacwZDw58O-433" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-425" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;void beforeMethod(...)&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2360" y="4860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-438" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-427" target="CrG38wg852pacwZDw58O-436" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-427" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;void afterMethod(...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;什么都没做&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2360" y="5340" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-439" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-429" target="CrG38wg852pacwZDw58O-437" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-429" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;void handleMethodException()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;只是打印了条错误日志&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2360" y="5420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-443" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-433" target="CrG38wg852pacwZDw58O-442" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-433" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;super.beforeMethod(method, allArguments);&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2600" y="4860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-435" value="BaseTraceAnnotationInterceptor" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=9;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="2865" y="4840" width="150" height="20" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-445" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-436" target="CrG38wg852pacwZDw58O-444" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-436" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;&lt;div&gt;super.afterMethod(method, ret);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;return ret;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2600" y="5340" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-437" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;super.handleMethodException(t);&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2600" y="5420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-450" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-442" target="CrG38wg852pacwZDw58O-449" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-442" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 8px&quot;&gt;&lt;font style=&quot;font-size: 8px&quot;&gt;Trace trace = method.getAnnotation(Trace.class);&lt;br&gt;&lt;/font&gt;operationName = MethodUtil.&lt;b&gt;generateOperationName&lt;/b&gt;(method);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;获取操作名，不存在则生成&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2840" y="4860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-468" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-444" target="CrG38wg852pacwZDw58O-467" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-444" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;AbstractSpan localSpan = ContextManager.&lt;b&gt;activeSpan&lt;/b&gt;();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;activeSpan其实是获取&lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 127 , 255)&quot;&gt;TracingContext&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;栈顶操作&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2840" y="5340" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-447" value="operationName 生成规则：全限定类名.方法名.(参数类型, ...)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=8;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="3050" y="4860" width="230" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-452" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-449" target="CrG38wg852pacwZDw58O-451" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-466" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-449" target="CrG38wg852pacwZDw58O-459" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-449" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;&lt;span style=&quot;font-size: 8px&quot;&gt;localSpan = ContextManager.&lt;b&gt;createLocalSpan&lt;/b&gt;(operationName);&lt;/span&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2840" y="4940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-454" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-451" target="CrG38wg852pacwZDw58O-453" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-451" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 10px&quot;&gt;&lt;span&gt;AbstractTracerContext context = getOrCreate(operationName, false);&lt;br&gt;&lt;/span&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px&quot;&gt;以Demo调用流程为例，这里获取前面SpringMVC拦截器创建的TracingContext&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3080" y="4940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-458" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-453" target="CrG38wg852pacwZDw58O-457" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-453" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;return context.&lt;b&gt;createLocalSpan&lt;/b&gt;(operationName);&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;创建LocalSpan并入栈&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3080" y="5020" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-457" value="&lt;div style=&quot;font-size: 9px&quot;&gt;&lt;div&gt;span = new &lt;b&gt;LocalSpan&lt;/b&gt;(spanIdGenerator++, parentSpanId, operationName, this);&lt;/div&gt;&lt;div&gt;return &lt;b&gt;push&lt;/b&gt;(span);&lt;/div&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;fontSize=10;rounded=1;arcSize=6;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3320" y="5020" width="200" height="60.75" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-462" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-459" target="CrG38wg852pacwZDw58O-461" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-459" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;&lt;font size=&quot;1&quot;&gt;Map&amp;lt;String, Object&amp;gt; context = CustomizeExpression.evaluationContext(&lt;br&gt;allArguments);&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;解析参数&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2840" y="5100" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-464" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-461" target="CrG38wg852pacwZDw58O-463" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-461" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;org.apache.skywalking.apm.toolkit.trace.Tags tags = method.getAnnotation(&lt;b&gt;Tags&lt;/b&gt;.class);&lt;br&gt;&lt;/font&gt;TagUtil.&lt;b&gt;tagSpan&lt;/b&gt;(localSpan, context, tag);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;解析@Tags注解，加入Span&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2840" y="5180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-463" value="&lt;font style=&quot;line-height: 0.5 ; font-size: 9px&quot;&gt;&lt;font style=&quot;font-size: 9px&quot;&gt;Tag tag = method.getAnnotation(&lt;b&gt;Tag&lt;/b&gt;.class);&lt;br&gt;&lt;/font&gt;TagUtil.&lt;b&gt;tagSpan&lt;/b&gt;(localSpan, context, tag);&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2840" y="5260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-470" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-467" target="CrG38wg852pacwZDw58O-469" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-467" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;Map&amp;lt;String, Object&amp;gt; context = CustomizeExpression&lt;br&gt;.evaluationReturnContext(ret);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;解析返回值，存储到&lt;/font&gt;&lt;span style=&quot;color: rgb(0 , 127 , 255)&quot;&gt;Map并&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;返回&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" parent="1" vertex="1">
          <mxGeometry x="2840" y="5420" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-472" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#FF3333;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-469" target="CrG38wg852pacwZDw58O-471" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-469" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;添加tag信息和beforeMethod中tagSpan() 操作一样&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="2840" y="5500" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-473" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;fontSize=9;fontColor=#FF3333;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-471" target="CrG38wg852pacwZDw58O-399" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-471" value="&lt;font style=&quot;line-height: 0.5&quot;&gt;ContextManager.stopSpan();&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2840" y="5580" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-478" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-474" target="CrG38wg852pacwZDw58O-477" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-474" value="&lt;font size=&quot;1&quot;&gt;&lt;div&gt;AbstractTracingSpan toFinishSpan = (AbstractTracingSpan) lastSpan;&lt;/div&gt;&lt;div&gt;if (toFinishSpan.&lt;b&gt;finish&lt;/b&gt;(segment)) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;pop&lt;/b&gt;();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;span的finish()方法&lt;b&gt;将结束的span加入到TraceSegment已结束的span列表&lt;/b&gt;，这个列表后面通过GRPC推送到OAP&lt;/font&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="3320" y="4740" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-482" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-477" target="CrG38wg852pacwZDw58O-480" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-477" value="&lt;font size=&quot;1&quot;&gt;finish();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;检测线程活跃的Span是否为空，&lt;br&gt;为空时执行TracingContext关闭处理&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="3320" y="4860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-479" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;span&gt;org.apache.skywalking.apm.agent.core.context.trace.&lt;/span&gt;&lt;b&gt;TraceSegment&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;private String &lt;/span&gt;&lt;b style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;traceSegmentId&lt;/b&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;;&lt;/span&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;span&gt;// parent trace segment 引用&lt;/span&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private TraceSegmentRef &lt;b&gt;ref&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;// 当前 segment 所有已经结束的 span&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private List&amp;lt;AbstractTracingSpan&amp;gt; &lt;b&gt;spans&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;// 关联的 traceId&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private DistributedTraceId &lt;b&gt;relatedGlobalTraceId&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private boolean ignore = false;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private boolean isSizeLimited = false;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final long createTime;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-600" y="3380" width="520" height="160" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-484" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-480" target="CrG38wg852pacwZDw58O-483" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-486" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=9;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-480" target="CrG38wg852pacwZDw58O-485" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-480" value="&lt;font&gt;TracingThreadListenerManager&lt;br&gt;.notifyFinish(this);&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#d5e8d4;gradientColor=#97d077;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="3560" y="4860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-490" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-483" target="CrG38wg852pacwZDw58O-489" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-483" value="&lt;font&gt;&amp;nbsp;TracingContext.ListenerManager#&lt;br&gt;notifyFinish(TraceSegment)&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#d5e8d4;gradientColor=#97d077;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="3560" y="4940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-488" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-485" target="CrG38wg852pacwZDw58O-487" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-485" value="&lt;font&gt;for&amp;nbsp;LISTENERS:&lt;br&gt;listener.&lt;b style=&quot;font-size: 10px&quot;&gt;afterMainThreadFinish&lt;/b&gt;(&lt;br&gt;finishedContext);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;当前DEMO只有一个&lt;b&gt;TracingThreadListener&lt;/b&gt;监听器&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3800" y="4860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-487" value="&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;b&gt;ProfileTaskExecutionService&lt;/b&gt;&lt;br&gt;#afterMainThreadFinish(TracingContext tracingContext)&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="4040" y="4860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-492" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-489" target="CrG38wg852pacwZDw58O-491" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-489" value="&lt;font&gt;&amp;nbsp;&lt;span&gt;for LISTENERS:&lt;/span&gt;&amp;nbsp;&lt;br&gt;listener.&lt;b&gt;afterFinished&lt;/b&gt;(finishedSegment);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;当前DEMO只有一个&lt;b&gt;TracingContextListener&lt;/b&gt;监听器&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="3800" y="4940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-491" value="&lt;font&gt;&lt;b&gt;TraceSegmentServiceClient&lt;/b&gt;#&lt;br&gt;afterFinished(finishedSegment);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;上报 TraceSegment数据，通过生产者端往DataCarrier Buffer中添加数据&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="4040" y="4940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-493" value="&lt;font&gt;......&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="600" y="4840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-500" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-494" target="CrG38wg852pacwZDw58O-499" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-494" value="&lt;font&gt;&lt;b&gt;afterFinished&lt;/b&gt;(TraceSegment traceSegment)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;数据生产&lt;br&gt;&lt;/b&gt;&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="840" y="4760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-496" value="几个常用的BootService" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="470" y="4459" width="120" height="20" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-503" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-497" target="CrG38wg852pacwZDw58O-502" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-497" value="&lt;font&gt;&lt;b&gt;carrier.produce(&lt;/b&gt;traceSegment&lt;b&gt;)&lt;/b&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1080" y="4840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-501" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-499" target="CrG38wg852pacwZDw58O-497" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-499" value="&lt;font&gt;&lt;div&gt;if (traceSegment.&lt;b&gt;isIgnore&lt;/b&gt;()) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="1080" y="4760" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-505" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-502" target="CrG38wg852pacwZDw58O-504" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-502" value="&lt;font&gt;return this.channels.&lt;b&gt;save&lt;/b&gt;(data);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里的QueueBuffer实现是 Buffer,&lt;br&gt;如果Buffer已满会自旋重试几次，失败返回false&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1320" y="4840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;entryX=1;entryY=0.25;entryDx=0;entryDy=0;fillColor=#d5e8d4;strokeColor=#82b366;shape=link;" edge="1" parent="1" source="CrG38wg852pacwZDw58O-504" target="UjX5X4dZ-ghX8sMesIcD-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-504" value="&lt;font&gt;buffer[i] = data;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;buffer是QueueBuffer数组，默认size=5&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1560" y="4840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-517" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=diamondThin;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-506" target="CrG38wg852pacwZDw58O-516" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-526" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-506" target="CrG38wg852pacwZDw58O-525" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-506" value="&lt;font&gt;DataCarrier&amp;lt;TraceSegment&amp;gt; carrier =&lt;br&gt;new &lt;b&gt;DataCarrier&lt;/b&gt;&amp;lt;&amp;gt;(CHANNEL_SIZE, BUFFER_SIZE, BufferStrategy.IF_POSSIBLE);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;channel size 和 buffer size 使用默认设置&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1080" y="4600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-511" value="生产者消费者模式 + 观察者模式&lt;br&gt;工作原理：&lt;br&gt;EntrySpan结束后, 通过观察者模式通知&lt;br&gt;TraceSegmentServiceClient 执行&amp;nbsp;afterFinished&lt;br&gt;将跟踪数据存放到 DataCarrier channels&lt;br&gt;（数据容器）&lt;br&gt;由消费者线程轮询从 channels中拉取数据&lt;br&gt;通过GRPC上报" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="600" y="4660" width="230" height="110" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-513" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;org.apache.skywalking.apm.agent.core.remote.&lt;/font&gt;&lt;span style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;&lt;b&gt;TraceSegmentServiceClient&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;GRPC客户端、还包含生产者方法、数据容器、消费者&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private long lastLogTime;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private long segmentUplinkedCounter;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private long segmentAbandonedCounter;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//追踪数据的容器、消费者线程&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile DataCarrier&amp;lt;TraceSegment&amp;gt; &lt;b&gt;carrier&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//GRPC客户端Stub，默认使用GRPC协议上报&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile TraceSegmentReportServiceGrpc.TraceSegmentReportServiceStub &lt;b&gt;serviceStub&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile GRPCChannelStatus status = GRPCChannelStatus.DISCONNECT;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;fillColor=#FFE599;" parent="1" vertex="1">
          <mxGeometry x="-600" y="4719.75" width="520" height="180" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-515" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=diamondThin;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-514" target="CrG38wg852pacwZDw58O-513" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-514" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;org.apache.skywalking.apm.agent.core.context.trace.AbstractSpan.&lt;b&gt;DataCarrier&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//最终存储追踪数据的容器&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private Channels&amp;lt;T&amp;gt; &lt;b&gt;channels&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//消费者线程+channels&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private IDriver &lt;b&gt;driver&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private String name;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1160" y="4759.75" width="520" height="100" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-516" value="&lt;font&gt;channels = new Channels&amp;lt;&amp;gt;(channelSize, bufferSize, new SimpleRollingPartitioner&amp;lt;T&amp;gt;(), &lt;b&gt;strategy&lt;/b&gt;);&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1320" y="4600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-518" value="使用有界的容器存储追踪数据，就会遇到容器填满后新增数据怎么处理的问题，&lt;br&gt;这里的策略就是处理这个问题的（和其他框架思想都一样，代码看多了就能猜个八九不离十）&lt;br&gt;Channels QueueBuffer 提供了两种实现（Buffer、ArrayBlockingQueueBuffer） &lt;br&gt;以 &lt;b&gt;Buffer&lt;/b&gt;&amp;nbsp; 为例（内部是数组）：&lt;br&gt;BLOCKING：如果索引位置不为空，直接替换旧数据，索引值计算用的 AtomicRangeInteger 不会数组边界溢出&lt;br&gt;IF_POSSIBLE：如果索引位置不为空，返回false，然后自旋重试几次&lt;br&gt;如果使用&amp;nbsp;&lt;b&gt;ArrayBlockingQueueBuffer&lt;/b&gt; 作为&amp;nbsp;QueueBuffer：&lt;br&gt;BLOCKING：如果队列已满直接阻塞 （ArrayBlockingQueue）&lt;br&gt;IF_POSSIBLE：不支持这种模式" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1530" y="4575" width="500" height="110" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-520" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;fontSize=10;fontColor=#007FFF;endArrow=diamondThin;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-519" target="CrG38wg852pacwZDw58O-514" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-519" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;org.apache.skywalking.apm..commons.datacarrier.buffer.&lt;/font&gt;&lt;b style=&quot;color: rgb(51 , 0 , 0)&quot;&gt;Channels&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;b&gt;追踪数据的容器&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//多个channel(QueueBuffer)、每个channel 有一个容器（&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;Buffer 是数组、ArrayBlockingQueueBuffer是ArrayBlockingQueue [有界、阻塞]）&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;span&gt;private final QueueBuffer&amp;lt;T&amp;gt;[] &lt;/span&gt;&lt;b&gt;bufferChannels&lt;/b&gt;&lt;span&gt;;&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//save数据时用于选取一个&amp;nbsp;QueueBuffer&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private IDataPartitioner&amp;lt;T&amp;gt; &lt;b&gt;dataPartitioner&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//数据save策略&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final BufferStrategy &lt;b&gt;strategy&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//可存储元素个数（存储TraceSegment），channelSize (bufferChannels size) * bufferSize (QueueBuffer size)&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final long &lt;b&gt;size&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1160" y="4921.25" width="520" height="158.5" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-530" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-521" target="CrG38wg852pacwZDw58O-529" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-521" value="&lt;font&gt;&lt;b&gt;ConsumerThread&lt;/b&gt;#&lt;b&gt;run&lt;/b&gt;()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;数据消费&lt;br&gt;&lt;/b&gt;默认启动1个消费者线程&lt;br&gt;线程名：DataCarrier.gRPC-log.Consumer.&amp;lt;N&amp;gt;.Thread&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="840" y="4920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-524" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-522" target="CrG38wg852pacwZDw58O-506" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-522" value="&lt;font&gt;boot()&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="840" y="4600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-2" value="&lt;font color=&quot;#007fff&quot;&gt;启动&lt;/font&gt;" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=1;exitDx=0;exitDy=0;entryX=1;entryY=0;entryDx=0;entryDy=0;fillColor=#d5e8d4;strokeColor=#82b366;" edge="1" parent="1" source="CrG38wg852pacwZDw58O-525" target="CrG38wg852pacwZDw58O-521">
          <mxGeometry x="-0.7273" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1060" y="4740" />
              <mxPoint x="1060" y="4920" />
            </Array>
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-525" value="&lt;font&gt;carrier.consume(this, 1);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;启动消费者线程（默认一个线程）&lt;/font&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1080" y="4680" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-527" value="中间件标配，都一样，没什么好说的" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=10;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="310" y="5089.75" width="170" height="39" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="CrG38wg852pacwZDw58O-529" target="UjX5X4dZ-ghX8sMesIcD-3">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-529" value="&lt;font&gt;ConsumerThread#&lt;br&gt;consume(consumeList)&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1080" y="4920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-534" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-531" target="CrG38wg852pacwZDw58O-533" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-531" value="&lt;font&gt;&lt;b&gt;TraceSegmentServerClient&lt;/b&gt;#&lt;br&gt;&lt;b&gt;consume&lt;/b&gt;(List&amp;lt;TraceSegment&amp;gt; data)&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1560" y="4920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-536" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-533" target="CrG38wg852pacwZDw58O-535" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-533" value="&lt;font&gt;&lt;b&gt;默认通过 GRPC 异步上报&lt;/b&gt;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#ffe6cc;strokeColor=#d79b00;" parent="1" vertex="1">
          <mxGeometry x="1800" y="4920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-538" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-535" target="CrG38wg852pacwZDw58O-537" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-535" value="&lt;font style=&quot;font-size: 8px&quot;&gt;&lt;div&gt;&lt;div&gt;StreamObserver&amp;lt;SegmentObject&amp;gt; &lt;b&gt;upstreamSegmentStreamObserver&lt;/b&gt; = serviceStub.withDeadlineAfter(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; Config.Collector.GRPC_UPSTREAM_TIMEOUT, TimeUnit.SECONDS&lt;/div&gt;&lt;div&gt;).collect(new StreamObserver&amp;lt;Commands&amp;gt;() {...}&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里是grpc-api:1.50.0的接口，&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1080" y="5020" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-540" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=8;fontColor=#007FFF;endArrow=classic;endFill=1;strokeColor=#330000;" parent="1" source="CrG38wg852pacwZDw58O-537" target="CrG38wg852pacwZDw58O-539" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-10" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.25;exitDx=0;exitDy=0;entryX=0;entryY=0.25;entryDx=0;entryDy=0;" edge="1" parent="1" source="CrG38wg852pacwZDw58O-537" target="UjX5X4dZ-ghX8sMesIcD-8">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-537" value="&lt;font style=&quot;font-size: 8px&quot;&gt;&lt;div&gt;for (TraceSegment segment : data) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; SegmentObject upstreamSegment = segment.transform();&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; upstreamSegmentStreamObserver.&lt;b&gt;onNext&lt;/b&gt;(upstreamSegment);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;默认使用双向流RPC模式传输&lt;/font&gt;&lt;/div&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#d5e8d4;strokeColor=#82b366;gradientColor=#97d077;" parent="1" vertex="1">
          <mxGeometry x="1080" y="5100" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="CrG38wg852pacwZDw58O-539" value="&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;span&gt;upstreamSegmentStreamObserver.onCompleted();&lt;br&gt;&lt;/span&gt;status.wait4Finish();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;同步等待异步操作执行完毕&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1080" y="5180" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-1" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;Span保存有所属TraceSegment的引用,&lt;br&gt;Span结束时通过TraceSegment#archive()方法&lt;br&gt;将自己保存到所属TraceSegment已完成Span列表&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="3520" y="4740" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-6" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="UjX5X4dZ-ghX8sMesIcD-3" target="CrG38wg852pacwZDw58O-531">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-3" value="&lt;font&gt;for&amp;nbsp;dataSources:&lt;br&gt;&lt;b&gt;dataSource&lt;/b&gt;.obtain(consumeList);&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="1320" y="4920" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-7" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;onNext()是流RPC模式传输接口&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="920" y="5115" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-11" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.75;exitDx=0;exitDy=0;entryX=1;entryY=0.75;entryDx=0;entryDy=0;" edge="1" parent="1" source="UjX5X4dZ-ghX8sMesIcD-8" target="CrG38wg852pacwZDw58O-537">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-8" value="&lt;font style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 12px;&quot;&gt;OAP Server Collector&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;OAP服务端&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#d5e8d4;strokeColor=#82b366;gradientColor=#97d077;" vertex="1" parent="1">
          <mxGeometry x="1560" y="5100" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-12" value="&lt;font color=&quot;#007fff&quot;&gt;TCP + ProtoBuf&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1410" y="5115" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-14" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0;exitDx=0;exitDy=0;entryX=0.75;entryY=1;entryDx=0;entryDy=0;endArrow=diamondThin;endFill=1;" edge="1" parent="1" source="UjX5X4dZ-ghX8sMesIcD-13" target="CrG38wg852pacwZDw58O-514">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-13" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;org.apache.skywalking.apm..commons.datacarrier.consumer.&lt;/font&gt;&lt;b style=&quot;color: rgb(51, 0, 0); background-color: initial;&quot;&gt;ConsumeDriver&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;b&gt;消费者&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private boolean running;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//消费者线程&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private &lt;b&gt;ConsumerThread&lt;/b&gt;[] &lt;b&gt;consumerThreads&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//追踪数据的容器，及DataCarrier中channels的引用&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private Channels&amp;lt;T&amp;gt; &lt;b&gt;channels&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private ReentrantLock lock;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;" vertex="1" parent="1">
          <mxGeometry x="-600" y="4919.75" width="520" height="158.5" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-16" value="这部分代码感觉比较通用，&lt;br&gt;将其抽离了出来，方便自己后面写组件参考：&lt;br&gt;&lt;b&gt;repo&lt;/b&gt;: communication/rpc-grpc-example/skywalking-grpc" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="280" y="4600" width="320" height="60" as="geometry" />
        </mxCell>
        <mxCell id="UjX5X4dZ-ghX8sMesIcD-18" value="&lt;div style=&quot;text-align: center&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;org.apache.skywalking.apm.agent.core.remote.&lt;/font&gt;&lt;b style=&quot;color: rgb(51, 0, 0); background-color: initial;&quot;&gt;GRPCChannelManager&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px&quot;&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;b&gt;GRPC通信信道管理器&lt;/b&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile GRPCChannel &lt;b&gt;managedChannel&lt;/b&gt; = null;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile ScheduledFuture&amp;lt;?&amp;gt; connectCheckFuture;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//是否需要重连的意思&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile boolean reconnect = true;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//用于随机从多个服务节点中选择一个节点连接&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final Random random = new Random();&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//关注连接状态的Listener，如TraceSegmentServiceClient需要连接就绪才可以上报数据&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private final List&amp;lt;GRPCChannelListener&amp;gt; &lt;b&gt;listeners&lt;/b&gt; = Collections.synchronizedList(new LinkedList&amp;lt;&amp;gt;());&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//Collector服务地址列表，多节点&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile List&amp;lt;String&amp;gt; &lt;b&gt;grpcServers&lt;/b&gt;;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//被选中连接的节点索引&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile int &lt;b&gt;selectedIdx&lt;/b&gt; = -1;&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//需要重连时触发重连的周期次数，连接成功后清零，每个周期默认30秒，&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;//Config.Agent.FORCE_RECONNECTION_PERIOD 如果为1，就会每30秒重连一次，如果为2就是2*30秒重连一次&lt;/p&gt;&lt;p style=&quot;margin: 0px 0px 0px 4px&quot;&gt;&lt;font color=&quot;#330000&quot;&gt;private volatile int &lt;b&gt;reconnectCount&lt;/b&gt; = 0;&lt;/font&gt;&lt;/p&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;fontColor=#007FFF;fillColor=#FFE599;" vertex="1" parent="1">
          <mxGeometry x="-600" y="4460.5" width="520" height="239.5" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
