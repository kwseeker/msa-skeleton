<mxfile host="Electron" modified="2023-09-30T14:55:07.414Z" agent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.7.5 Chrome/114.0.5735.289 Electron/25.8.1 Safari/537.36" etag="7J8ELAWLNRBnJY2Oz_Qb" version="21.7.5" type="device" pages="2">
  <diagram id="9ECC-ABarEBT77yPrqBL" name="gateway-3.1.8">
    <mxGraphModel dx="2020" dy="843" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="5Pg-zcQFXHUufSQWG7cZ-1" value="&lt;p style=&quot;line-height: 1&quot;&gt;&lt;/p&gt;&lt;h1&gt;&lt;font style=&quot;font-size: 20px&quot;&gt;Spring-Cloud-Gateway 工作原理&lt;/font&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;(v3.1.8)&amp;nbsp;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;其核心是一个WebFlux应用。&lt;/font&gt;&lt;/div&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;前提：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;&lt;ul style=&quot;font-size: 10px&quot;&gt;&lt;li style=&quot;font-size: 10px&quot;&gt;理解WebFlux工作原理与WebFlux应用开发&lt;/li&gt;&lt;li style=&quot;font-size: 10px&quot;&gt;ProjectReactor （包括 reactor-netty）&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;说明：&lt;br&gt;&lt;ul&gt;&lt;li&gt;如果对WebFlux工作原理（主要是请求处理流程）能有一个清晰的理解的话，再看Spring Cloud Gateway 的工作原理会比较简单&lt;/li&gt;&lt;li&gt;这个流程请结合WebFlux的流程图看&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="10" y="20" width="710" height="180" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="v0geVxzHFCW3Ob6fWTqS-1" target="v0geVxzHFCW3Ob6fWTqS-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-1" value="spring-cloud-starter-gateway" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="220" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="v0geVxzHFCW3Ob6fWTqS-3" target="v0geVxzHFCW3Ob6fWTqS-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="v0geVxzHFCW3Ob6fWTqS-3" target="v0geVxzHFCW3Ob6fWTqS-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="v0geVxzHFCW3Ob6fWTqS-3" target="v0geVxzHFCW3Ob6fWTqS-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-14" style="edgeStyle=orthogonalEdgeStyle;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;rounded=1;" parent="1" source="v0geVxzHFCW3Ob6fWTqS-3" target="v0geVxzHFCW3Ob6fWTqS-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QqUapiyuQsOda3R7l0Wb-10" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="v0geVxzHFCW3Ob6fWTqS-3" target="QqUapiyuQsOda3R7l0Wb-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QqUapiyuQsOda3R7l0Wb-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="v0geVxzHFCW3Ob6fWTqS-3" target="QqUapiyuQsOda3R7l0Wb-8" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="QqUapiyuQsOda3R7l0Wb-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="v0geVxzHFCW3Ob6fWTqS-3" target="QqUapiyuQsOda3R7l0Wb-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-3" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;自动配置类&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;位于spring-cloud-gateway-server config目录，开始不需要详细看，后面用到哪个Bean再来这些类中找&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="240" y="220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-5" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;GatewayAutoConfiguration&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="480" y="220" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-7" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;GatewayNoLoadBalancerClientAutoConfiguration&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="480" y="300" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-10" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;GatewayReactiveLoadBalancerClient&lt;br&gt;AutoConfiguration&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="480" y="380" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="v0geVxzHFCW3Ob6fWTqS-12" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;GatewayResilience4JCircuitBreakerAutoConfiguration&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="480" y="460" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QqUapiyuQsOda3R7l0Wb-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="QqUapiyuQsOda3R7l0Wb-1" target="TLQ8Jejc-yUDhLceZBrH-5" edge="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="240" y="830" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="QqUapiyuQsOda3R7l0Wb-1" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;请求处理与响应&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="40" y="800" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QqUapiyuQsOda3R7l0Wb-4" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;这里省略Netty处理逻辑、只关注从WebFlux&lt;br&gt;的&lt;/font&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;HttpWebHandlerAdapter&lt;/font&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;之后的处理部分&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="40" y="860" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="QqUapiyuQsOda3R7l0Wb-5" value="&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;一共9个自动配置类&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="275" y="280" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="QqUapiyuQsOda3R7l0Wb-6" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;GatewayRedisAutoConfiguration&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="480" y="620" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QqUapiyuQsOda3R7l0Wb-8" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;SimpleUrlHandlerMappingGlobalCors&lt;br&gt;AutoConfiguration&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="480" y="700" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="QqUapiyuQsOda3R7l0Wb-12" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;GatewayReactiveOAuth2AutoConfiguration&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="480" y="540" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-5" target="TLQ8Jejc-yUDhLceZBrH-8">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-5" value="ServerWebExchange &lt;b&gt;exchange&lt;/b&gt; = createExchange(request, response);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;ServerWebExchange就是请求响应上下文&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=10;" vertex="1" parent="1">
          <mxGeometry x="240" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-6" value="&lt;b&gt;HttpWebHandlerAdapter&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="260" y="770" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-7" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-8" target="TLQ8Jejc-yUDhLceZBrH-12">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-8" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;return &lt;b&gt;getDelegate&lt;/b&gt;().&lt;b&gt;handle&lt;/b&gt;(exchange)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;.doOnSuccess(aVoid -&amp;gt; logResponse(exchange))&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;.onErrorResume(ex -&amp;gt; handleUnresolvedError(exchange, ex))&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;.then(Mono.defer(response::&lt;b&gt;setComplete&lt;/b&gt;));&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;getDelegate()获取的是经过&lt;b&gt;装饰器模式&lt;/b&gt;层层修饰后的&lt;b&gt;DispatcherHandler&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=6;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="240" y="880" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-12" target="TLQ8Jejc-yUDhLceZBrH-13">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-12" target="TLQ8Jejc-yUDhLceZBrH-15">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-12" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;Mono&amp;lt;Void&amp;gt; completion;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;try {&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; completion = super.&lt;b&gt;handle&lt;/b&gt;(exchange);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;} catch (Throwable ex) {&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; completion = Mono.error(ex);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;" vertex="1" parent="1">
          <mxGeometry x="480.5" y="880" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-13" value="for this.&lt;b&gt;exceptionHandlers&lt;/b&gt;:&lt;br&gt;completion = completion.&lt;b&gt;onErrorResume&lt;/b&gt;(ex -&amp;gt; handler.handle(exchange, ex));&lt;br&gt;return completion;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;统一异常处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" vertex="1" parent="1">
          <mxGeometry x="461" y="980" width="239" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-14" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-15" target="TLQ8Jejc-yUDhLceZBrH-20">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-15" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;return this.chain.&lt;b&gt;filter&lt;/b&gt;(exchange);&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=15;" vertex="1" parent="1">
          <mxGeometry x="720" y="890" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-16" value="ExceptionHandlingWebHandler" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="485.75" y="850" width="190" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-17" value="FilteringWebHandler" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="755" y="860" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-18" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-20" target="TLQ8Jejc-yUDhLceZBrH-21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-25" value="&lt;font color=&quot;#007fff&quot;&gt;1&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="TLQ8Jejc-yUDhLceZBrH-18">
          <mxGeometry x="0.104" y="1" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-20" target="TLQ8Jejc-yUDhLceZBrH-22">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-24" value="&lt;font color=&quot;#007fff&quot;&gt;2&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="TLQ8Jejc-yUDhLceZBrH-19">
          <mxGeometry x="-0.4053" y="2" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-20" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div&gt;return Mono.&lt;b&gt;defer&lt;/b&gt;(() -&amp;gt;&lt;/div&gt;&lt;div&gt;this.currentFilter != null &amp;amp;&amp;amp; this.chain != null ?&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;invokeFilter&lt;/b&gt;(this.currentFilter, this.chain, exchange) : &lt;font color=&quot;#007fff&quot;&gt;//1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; this.handler.&lt;b&gt;handle&lt;/b&gt;(exchange)); &lt;font color=&quot;#007fff&quot;&gt;//2&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;过滤器不为空就执行过滤器逻辑，否则直接执行请求处理&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=15;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="960" y="890" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-21" target="TLQ8Jejc-yUDhLceZBrH-33">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-39" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-21" target="TLQ8Jejc-yUDhLceZBrH-38">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-21" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;依次执行过滤器逻辑&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;过滤器都执行完最后执行WebHandler(即handler)&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1258.75" y="890" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-22" target="TLQ8Jejc-yUDhLceZBrH-28">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1521.75" y="1120" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-22" value="&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;div&gt;Flux.fromIterable(this.&lt;b&gt;handlerMappings&lt;/b&gt;)&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;concatMap&lt;/b&gt;(mapping -&amp;gt; mapping.&lt;b&gt;getHandler&lt;/b&gt;(&lt;b&gt;exchange&lt;/b&gt;))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .next()&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .switchIfEmpty(createNotFoundError())&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;flatMap&lt;/b&gt;(handler -&amp;gt; &lt;b&gt;invokeHandler&lt;/b&gt;(exchange, handler))&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; .&lt;b&gt;flatMap&lt;/b&gt;(result -&amp;gt; &lt;b&gt;handleResult&lt;/b&gt;(exchange, result));&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;获取匹配的请求处理器，调用匹配的&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;请求处理器，响应处理&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1241" y="1080" width="240.75" height="80" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-23" value="DispatcherHandler" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1299.13" y="1050" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-35" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-28" target="TLQ8Jejc-yUDhLceZBrH-29">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-28">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1760" y="1120" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-47" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-28" target="TLQ8Jejc-yUDhLceZBrH-46">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-28" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;mapping.getHandler(exchange)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;遍历handlerMappings,&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;获取与请求匹配的所有处理器的Mono序列&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1519.25" y="1090" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-36" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-29" target="TLQ8Jejc-yUDhLceZBrH-30">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-101" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-29" target="TLQ8Jejc-yUDhLceZBrH-99">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-29" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;invokeHandler(exchange, handler)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;调用处理器处理请求&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1520" y="1400" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-30" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;handleResult(exchange, result)&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;处理请求响应结果&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="1520" y="1740" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-31" value="DefaultWebFilterChain" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1010" y="860" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-32" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;delegate 对象结构：装饰器模式+责任链模式&lt;br&gt;最外层是ExceptionHandlingWebHandler&lt;br&gt;然后深入一层是 FilterWebHandler&lt;br&gt;FilterWebHandler 通过&amp;nbsp;DefaultWebFilterChain 责任链模式&lt;br&gt;将过滤器和DispatcherHandler链接起来&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="160" y="960" width="280" height="90" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-33" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;MetricsWebFilter&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;spring-boot-actuator 中定义的&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="1520" y="890" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-94" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;endArrow=diamondThin;endFill=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-37" target="TLQ8Jejc-yUDhLceZBrH-92">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-37" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b style=&quot;&quot;&gt;DefaultWebFilterChain&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;//所有WebFilter，handler之前执行的过滤器&lt;br&gt;&lt;font color=&quot;#000000&quot;&gt;private final List&amp;lt;WebFilter&amp;gt; &lt;b&gt;allFilters&lt;/b&gt;;&lt;/font&gt;&lt;/span&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//用于处理请求的WebHandler, 看请求处理逻辑可以看到链条有两层，第一层的&lt;br&gt;handler是&lt;b&gt;DispatcherHandler&lt;/b&gt;, 内部又有一层，第二层的handler是&lt;br&gt;&lt;b&gt;FilteringWebHandler, &lt;/b&gt;对应的过滤器链内外层也各有一条&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;private final WebHandler &lt;b&gt;handler&lt;/b&gt;;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//当前执行到的WebFilter, 所有都执行过后为null&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;private final WebFilter &lt;b&gt;currentFilter&lt;/b&gt;;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;private final DefaultWebFilterChain &lt;b&gt;chain&lt;/b&gt;;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" vertex="1" parent="1">
          <mxGeometry x="-400" y="800" width="360" height="160" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-38" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;WeightCalcuatorWebFilter&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;spring-cloud-gateway-server 中定义的&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="1520" y="970" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-40" value="测试案例中加载的&lt;b&gt;WebFilter&lt;/b&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1535" y="860" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-41" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;this = {DispatcherHandler@10767}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;b style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;handlerMappings&lt;/font&gt;&lt;/b&gt;&lt;font size=&quot;1&quot;&gt; = {Collections$UnmodifiableRandomAccessList@11219}&amp;nbsp; size = 7&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 0 = {AdditionalHealthEndpointPathsWebFluxHandlerMapping@11224}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 1 = {WebFluxEndpointHandlerMapping@11225}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 2 = {ControllerEndpointHandlerMapping@11226}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 3 = {&lt;b&gt;RouterFunctionMapping&lt;/b&gt;@11227}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 4 = {RequestMappingHandlerMapping@11228}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 5 = {&lt;b&gt;RoutePredicateHandlerMapping&lt;/b&gt;@11229}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 6 = {SimpleUrlHandlerMapping@11230}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#3399ff&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#3333ff&quot;&gt;包含Endpoint的都是spring-boot-actuator中定义的，ReqeustMappingHandlerMapping是通过&lt;br&gt;&amp;nbsp;@ReqeustMapping注解定义的，SimpleUrlHandlerMapping是通过重写Handler接口&lt;/font&gt;&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#3333ff&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;font color=&quot;#3333ff&quot;&gt;&amp;nbsp;handleRequest(HttpServletRequest request, HttpServletResponse response) 方法定义的&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;font size=&quot;1&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;b style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;handlerAdapters&lt;/font&gt;&lt;/b&gt;&lt;span style=&quot;font-size: 9px; background-color: initial; color: rgb(0, 127, 255);&quot;&gt; = {ArrayList@11220}&amp;nbsp; size = 4&lt;/span&gt;&lt;font size=&quot;1&quot; color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 0 = {WebSocketHandlerAdapter@11232}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 1 = {RequestMappingHandlerAdapter@11233}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 2 = {HandlerFunctionAdapter@11234}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 3 = {SimpleHandlerAdapter@11235}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;b style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;resultHandlers&lt;/font&gt;&lt;/b&gt;&lt;font size=&quot;1&quot;&gt; = {ArrayList@11221}&amp;nbsp; size = 4&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 0 = {ResponseEntityResultHandler@11237}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 1 = {ServerResponseResultHandler@11238}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 2 = {ResponseBodyResultHandler@11239}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; 3 = {ViewResolutionResultHandler@11240}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;br&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1130" y="1160" width="400" height="280" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-44" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b&gt;DispatcherHandler&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//一组“路由-&amp;gt;请求处理器”的容器 (案例中有7种)&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;private List&amp;lt;HandlerMapping&amp;gt; &lt;b&gt;handlerMappings&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;//一组请求处理适配器，分别适配不同的处理器类型&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;private List&amp;lt;HandlerAdapter&amp;gt; &lt;b&gt;handlerAdapters&lt;/b&gt;;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//请求结果处理器&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;private List&amp;lt;HandlerResultHandler&amp;gt; &lt;b&gt;resultHandlers&lt;/b&gt;;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" vertex="1" parent="1">
          <mxGeometry x="-400" y="1000" width="360" height="100" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-45" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;RouteFunctionMapping&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;存储@Bean +&amp;nbsp;RouterFunction定义的路由与处理方法&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;，通过 obtainApplicationContext()&lt;/span&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;.getBeanProvider(RouterFunction.class) 加载&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="1760" y="1090" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-72" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-46" target="TLQ8Jejc-yUDhLceZBrH-71">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-46" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;RoutePredicateHandlerMapping&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;font size=&quot;1&quot;&gt;存储通过配置 spring.cloud.gateway.routes 和&amp;nbsp;&lt;/font&gt;&lt;font size=&quot;1&quot;&gt;RouteLocatorBuilder 定义的路由与处理方法&lt;/font&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="1760" y="1180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-48" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;SCG中主要用到下面两种HandlerMapping&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="1755" y="1050" width="210" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-59" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-51" target="TLQ8Jejc-yUDhLceZBrH-58">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-70" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-51" target="TLQ8Jejc-yUDhLceZBrH-69">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-51" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;return lookupRoute(exchange)&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;遍历此HandlerMapping所有RouteLocator，返回与当前请求匹配的第一个Route (Mono&amp;lt;Route&amp;gt;)&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2240" y="1180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-56" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=0;exitDx=0;exitDy=0;entryX=0.5;entryY=1;entryDx=0;entryDy=0;endArrow=diamondThin;endFill=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-53" target="TLQ8Jejc-yUDhLceZBrH-44">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-53" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b&gt;RoutePredicateHandlerMapping&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//路由断言Handler容器，是HandlerMapping的一种实现&lt;br&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private final FilteringWebHandler webHandler;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;//本质是&lt;b&gt;RouteDefinitionRouteLocator&lt;/b&gt;的容器,&amp;nbsp;CompositeRouteLocator 用于&lt;/div&gt;&lt;div&gt;组合多个RouteLocator,&amp;nbsp;CachingRouteLocator 则用于提供缓存的功能&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private final RouteLocator &lt;b&gt;routeLocator&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private final Integer managementPort;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private final ManagementPortType managementPortType;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" vertex="1" parent="1">
          <mxGeometry x="-400" y="1140" width="360" height="160" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-57" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b&gt;RouteDefinitionRouteLocator&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//&lt;br&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private final RouteDefinitionLocator routeDefinitionLocator;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private final ConfigurationService configurationService;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private final Map&amp;lt;String, RoutePredicateFactory&amp;gt; &lt;b&gt;predicates&lt;/b&gt; = new LinkedHashMap&amp;lt;&amp;gt;();&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private final Map&amp;lt;String, GatewayFilterFactory&amp;gt; &lt;b&gt;gatewayFilterFactories&lt;/b&gt; = new HashMap&amp;lt;&amp;gt;();&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private final GatewayProperties gatewayProperties;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" vertex="1" parent="1">
          <mxGeometry x="-480" y="1340" width="440" height="160" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-66" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-58" target="TLQ8Jejc-yUDhLceZBrH-65">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-79" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-58" target="TLQ8Jejc-yUDhLceZBrH-78">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-58" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;retrun this.routeLocator.&lt;b&gt;getRoutes&lt;/b&gt;()&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; size=&quot;1&quot;&gt;获取所有RouteLocator对象序列&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2501" y="1180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-68" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-65" target="TLQ8Jejc-yUDhLceZBrH-67">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-80" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-65" target="TLQ8Jejc-yUDhLceZBrH-67">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-65" value="&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;div style=&quot;&quot;&gt;.concatMap(route -&amp;gt; Mono.just(route).&lt;b&gt;filterWhen&lt;/b&gt;(r -&amp;gt; {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;exchange.getAttributes()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.put(GATEWAY_PREDICATE_ROUTE_ATTR, r.getId());&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;return r.&lt;b&gt;getPredicate&lt;/b&gt;().&lt;b&gt;apply&lt;/b&gt;(exchange);&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;})&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.doOnError(...)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.onErrorResume(e -&amp;gt; Mono.empty())&lt;/div&gt;&lt;div&gt;)&lt;/div&gt;&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;即通过断言匹配exchange，返回匹配的RouteLocator的序列&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2481" y="1260" width="240" height="100" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-67" value="&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;.next()&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;//找到一个就跳出&lt;/font&gt;&lt;/div&gt;&lt;div&gt;.map(route -&amp;gt; {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;b&gt;validateRoute&lt;/b&gt;(route, exchange); &lt;font color=&quot;#007fff&quot;&gt;// RoutePredicateHandlerMapping 中定义，方法为空&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;return route;&lt;/div&gt;&lt;div&gt;});&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2501" y="1380" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-110" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;fillColor=#d5e8d4;strokeColor=#82b366;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-69" target="TLQ8Jejc-yUDhLceZBrH-108">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2340" y="1400" />
              <mxPoint x="2460" y="1400" />
              <mxPoint x="2460" y="1480" />
              <mxPoint x="2581" y="1480" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-117" value="&lt;font color=&quot;#007fff&quot;&gt;attr Map 就是用于传参的&lt;/font&gt;" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" vertex="1" connectable="0" parent="TLQ8Jejc-yUDhLceZBrH-110">
          <mxGeometry x="-0.8024" y="-2" relative="1" as="geometry">
            <mxPoint x="11" y="8" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-69" value="&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;div&gt;.flatMap((Function&amp;lt;Route, Mono&amp;lt;?&amp;gt;&amp;gt;) r -&amp;gt; {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;exchange.getAttributes()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.remove(GATEWAY_PREDICATE_ROUTE_ATTR);&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;b&gt;exchange.getAttributes().put(GATEWAY_ROUTE_ATTR, r);&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;return &lt;b&gt;Mono.just(webHandler)&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;}).switchIfEmpty(Mono.empty().then(Mono.fromRunnable(() -&amp;gt; {&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;exchange.getAttributes()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.remove(GATEWAY_PREDICATE_ROUTE_ATTR);&lt;/div&gt;&lt;div&gt;})));&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;这里可以看到匹配的&lt;b&gt;Route&lt;/b&gt;被放入了exchange属性Map&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;只要有匹配的Route就返回webHandler(固定的)&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="2220" y="1260" width="240" height="120" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-73" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-71" target="TLQ8Jejc-yUDhLceZBrH-51">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-75" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-71" target="TLQ8Jejc-yUDhLceZBrH-74">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-71" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;return getHandlerInternal(exchange)&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2000" y="1180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-74" value="&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;.map(handler -&amp;gt; {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &lt;font style=&quot;font-size: 10px;&quot;&gt;//CORS相关配置处理 || PreFlight 请求处理，暂略, TODO&lt;/font&gt;&lt;/font&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; return handler;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;});&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2000" y="1260" width="200" height="80" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-78" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;TODO Routes Predicate 哪里填充的&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2740" y="1180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-81" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;WebSocketHandlerAdapter&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于适配WebSocketHandler子类型的处理器&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2000" y="1400" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-83" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;RequestMappingHandlerAdapter&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于适配HandlerMethod类型处理器&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2000" y="1480" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-84" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;HandlerFunctionAdapter&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于适配HandlerFunction类型的处理器&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2000" y="1560" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-91" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-85">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2240" y="1670" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-85" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;SimpleHandlerAdapter&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于适配WebHandler子类型的处理器&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;因为RoutePredicateHandlerMapping&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;中的webHandler是&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;FilteringWebHandler&lt;/b&gt;类型，所以用这个适配器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2000" y="1640" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-86" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;SCG中加载了4种处理器适配器&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2025" y="1370" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-98" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;entryX=0;entryY=0.5;entryDx=0;entryDy=0;entryPerimeter=0;" edge="1" parent="1" target="TLQ8Jejc-yUDhLceZBrH-97">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2200.75" y="1670" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-92" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b&gt;FilteringWebHandler&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;包含一组WebFilter和WebHandler的用于请求处理的责任链&lt;br&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;&lt;font color=&quot;#000000&quot;&gt;private final DefaultWebFilterChain chain;&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;br&gt;//继承WebHandlerDecorator&lt;br&gt;&lt;span style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;private final WebHandler delegate;&lt;/font&gt;&lt;/span&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" vertex="1" parent="1">
          <mxGeometry x="-800" y="1340" width="280" height="160" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-95" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;font size=&quot;1&quot;&gt;&lt;b&gt;Route&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;路由规则对象&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;//&lt;/span&gt;路由ID&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final String id;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//路由转发目标URI&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final URI uri;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//匹配优先级，&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//一个请求可能匹配多个路由规则，选择优先级最高的&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final int order;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//断言，用于匹配请求&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final AsyncPredicate&amp;lt;ServerWebExchange&amp;gt; predicate;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//局部过滤器&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final List&amp;lt;GatewayFilter&amp;gt; gatewayFilters;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//元数据，TODO&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final Map&amp;lt;String, Object&amp;gt; metadata;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" vertex="1" parent="1">
          <mxGeometry x="-320" y="1540" width="280" height="220" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-96" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b&gt;AsyncPredicate&amp;lt;T&amp;gt;&lt;/b&gt; extends Function&amp;lt;T, Publisher&amp;lt;Boolean&amp;gt;&amp;gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;断言规则, 实例由断言工厂创建&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" vertex="1" parent="1">
          <mxGeometry x="-680" y="1540" width="320" height="160" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-107" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-97" target="TLQ8Jejc-yUDhLceZBrH-106">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-109" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-97" target="TLQ8Jejc-yUDhLceZBrH-108">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-97" value="&lt;div style=&quot;&quot;&gt;Mono&amp;lt;Void&amp;gt; mono = &lt;b&gt;webHandler&lt;/b&gt;.handle(exchange);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;FilteringWebHandler&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2240" y="1640" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-102" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-99" target="TLQ8Jejc-yUDhLceZBrH-81">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-103" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-99" target="TLQ8Jejc-yUDhLceZBrH-83">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-104" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-99" target="TLQ8Jejc-yUDhLceZBrH-84">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-105" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-99" target="TLQ8Jejc-yUDhLceZBrH-85">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-99" value="&lt;div style=&quot;&quot;&gt;for (HandlerAdapter handlerAdapter : this.handlerAdapters)&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;if (handlerAdapter.&lt;b&gt;supports&lt;/b&gt;(handler))&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;handlerAdapter.&lt;b&gt;handle&lt;/b&gt;(exchange, handler);&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="1760" y="1400" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-106" value="&lt;div style=&quot;&quot;&gt;return mono.then(Mono.empty());&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2240" y="1720" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-112" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-108" target="TLQ8Jejc-yUDhLceZBrH-111">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-108" value="&lt;div style=&quot;&quot;&gt;Route route = exchange&lt;/div&gt;&lt;div style=&quot;&quot;&gt;.getRequiredAttribute(&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;GATEWAY_ROUTE_ATTR);&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2481" y="1640" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-114" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-111" target="TLQ8Jejc-yUDhLceZBrH-113">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-111" value="&lt;div style=&quot;&quot;&gt;List&amp;lt;GatewayFilter&amp;gt; gatewayFilters = route.getFilters();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;此Route的局部过滤器&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2481" y="1720" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-116" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-113" target="TLQ8Jejc-yUDhLceZBrH-115">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-113" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;List&amp;lt;GatewayFilter&amp;gt; combined = new ArrayList&amp;lt;&amp;gt;(this.globalFilters);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;combined.addAll(gatewayFilters);&lt;/div&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;AnnotationAwareOrderComparator.sort(combined);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;合并全局过滤器和局部过滤器并排序，值越小优先级越高&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2481" y="1800" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-120" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-115" target="TLQ8Jejc-yUDhLceZBrH-119">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-115" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;return new &lt;b&gt;DefaultGatewayFilterChain&lt;/b&gt;(combined)&lt;/div&gt;&lt;div style=&quot;&quot;&gt;.&lt;b&gt;filter&lt;/b&gt;(exchange);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;责任链模式，依次执行GatewayFilter&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2481" y="1880" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-118" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font size=&quot;1&quot; color=&quot;#000000&quot;&gt;&lt;b&gt;GatewayFilterAdapter&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;这里使用适配器模式，为了适配全局过滤器，因为&lt;br&gt;DefaultGatewayFilterChain中调用的&lt;b&gt;GatewayFilter&lt;/b&gt;接口，但是&lt;br&gt;全局过滤器实现的是&lt;b&gt;GlobalFilter&lt;/b&gt;接口，所以需要适配&lt;br&gt;&lt;/font&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;br&gt;//被适配的全局过滤器对象&lt;br&gt;&lt;font color=&quot;#000000&quot;&gt;&amp;nbsp;private final &lt;b&gt;GlobalFilter&lt;/b&gt; delegate;&lt;/font&gt;&lt;/font&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" vertex="1" parent="1">
          <mxGeometry x="-320" y="1780" width="280" height="120" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-133" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-119" target="TLQ8Jejc-yUDhLceZBrH-121">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="2950" y="1690" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-136" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-119" target="TLQ8Jejc-yUDhLceZBrH-123">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-137" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-119" target="TLQ8Jejc-yUDhLceZBrH-125">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-146" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-119" target="TLQ8Jejc-yUDhLceZBrH-126">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-154" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-119" target="TLQ8Jejc-yUDhLceZBrH-127">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-155" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-119" target="TLQ8Jejc-yUDhLceZBrH-128">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-156" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-119" target="TLQ8Jejc-yUDhLceZBrH-129">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-157" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-119" target="TLQ8Jejc-yUDhLceZBrH-130">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-158" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-119" target="TLQ8Jejc-yUDhLceZBrH-132">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-159" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-119" target="TLQ8Jejc-yUDhLceZBrH-131">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-119" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;return this.delegate.filter(exchange, chain);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这里省略了一步责任链遍历执行Filter（实际是&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;GatewayFilterAdapter对象&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;）的过程&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2721" y="1880" width="199" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-191" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-121" target="TLQ8Jejc-yUDhLceZBrH-123">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-121" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;RemoveCachedBodyFilter&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;doFinally()阶段，用于&lt;b&gt;处理返回&lt;/b&gt;后释放属性&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;CACHED_REQUEST_BODY_ATTR值&lt;/font&gt;&lt;b style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;PooledDataBuffer &lt;/b&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 127, 255);&quot;&gt;（反而是最后执行）&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;最高优先级，Integer.MIN_VALUE&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2960" y="1640" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-192" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-123" target="TLQ8Jejc-yUDhLceZBrH-125">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-123" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;AdaptCachedBodyGlobalFilter&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2960" y="1720" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-139" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-125" target="TLQ8Jejc-yUDhLceZBrH-138">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-193" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-125" target="TLQ8Jejc-yUDhLceZBrH-126">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-125" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;NettyWriteResponseFilter&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;then()阶段，即用于处理&lt;b&gt;返回后&lt;/b&gt;写Response响应&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="2960" y="1800" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-148" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-126" target="TLQ8Jejc-yUDhLceZBrH-147">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-194" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-126" target="TLQ8Jejc-yUDhLceZBrH-127">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-126" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;ForwardPathFilter&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;如果schema是forward类型执行右边逻辑，&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;否则直接跳过执行下一个过滤器&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2960" y="2120" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-172" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-127" target="TLQ8Jejc-yUDhLceZBrH-171">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-195" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-127" target="TLQ8Jejc-yUDhLceZBrH-128">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-127" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;GatewayMetricsFilter&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;doOnSuccess()&amp;nbsp;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;doOnError()&amp;nbsp;&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;阶段&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;即用于处理返回后记录监控数据&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2960" y="2280" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-174" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-128" target="TLQ8Jejc-yUDhLceZBrH-173">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-196" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-128" target="TLQ8Jejc-yUDhLceZBrH-129">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-128" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;RouteToRequestUrlFilter&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于生成最终转发给目标服务的完整的URL&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="2960" y="2358" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-197" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-129" target="TLQ8Jejc-yUDhLceZBrH-130">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-129" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;NoLoadBalancerClientFilter&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;默认没有配置负载均衡时使用&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2960" y="2600" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-181" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-130" target="TLQ8Jejc-yUDhLceZBrH-180">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-198" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-130" target="TLQ8Jejc-yUDhLceZBrH-132">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-130" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;WebsocketRoutingFilter&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于处理WebSocket&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;请求&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;或者Http升级为WebSokcet, 对于WebSocket请求这个是最后的过滤器&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="2960" y="2680" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-166" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-131" target="TLQ8Jejc-yUDhLceZBrH-165">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-131" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;ForwardRoutingFilter&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;用于处理schema为&lt;b&gt;forward&lt;/b&gt;的请求&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="2960" y="3200" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-199" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-132" target="TLQ8Jejc-yUDhLceZBrH-131">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-201" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-132" target="TLQ8Jejc-yUDhLceZBrH-200">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-132" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;NettyRoutingFilter&lt;/b&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;对于要转发给后端服务的Http请求，这个是最后的过滤器，借助reactor-netty HttpClient 向后端服务发起请求&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="2960" y="2760" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-141" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-138" target="TLQ8Jejc-yUDhLceZBrH-140">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-138" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;Connection connection = exchange.getAttribute(&lt;/div&gt;&lt;div style=&quot;&quot;&gt;CLIENT_RESPONSE_CONN_ATTR);&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="1800" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-143" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-140" target="TLQ8Jejc-yUDhLceZBrH-142">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-140" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;ServerHttpResponse response = exchange.getResponse();&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="1880" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-145" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-142" target="TLQ8Jejc-yUDhLceZBrH-144">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-142" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;div&gt;final Flux&amp;lt;DataBuffer&amp;gt; body = connection&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;.inbound()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.receive()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.retain()&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.map(byteBuf -&amp;gt; wrap(byteBuf,response));&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="1960" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-144" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;div style=&quot;text-align: left;&quot;&gt;&lt;div&gt;return (isStreamingMediaType(contentType)&lt;span style=&quot;background-color: initial;&quot;&gt;? response.&lt;b&gt;writeAndFlushWith&lt;/b&gt;(body.map(Flux::just))&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;: response.&lt;b&gt;writeWith&lt;/b&gt;(body));&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="2038" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-152" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-147" target="TLQ8Jejc-yUDhLceZBrH-151">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-147" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;exchange = exchange.mutate().&lt;b&gt;request&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;&quot;&gt;exchange.getRequest().mutate()&lt;/div&gt;&lt;div style=&quot;&quot;&gt;.path(routeUri.getPath()).build()).build();&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这步其实是复制exchange对象&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="2120" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-151" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;return chain.filter(exchange);&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="2200" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-160" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;URI mergedUrl = UriComponentsBuilder.fromUri(uri)&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&lt;/span&gt;.scheme(routeUri.getScheme()).host(routeUri.getHost())&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.port(routeUri.getPort()).build(encoded).toUri();&lt;/div&gt;&lt;div&gt;exchange.getAttributes().put(&lt;/div&gt;&lt;div&gt;&lt;b&gt;&amp;nbsp; GATEWAY_REQUEST_URL_ATTR&lt;/b&gt;, mergedUrl);&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry x="3180.75" y="2520" width="239.25" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-165" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;return handle(this.getDispatcherHandler(), exchange);&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="3200" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-167" value="&lt;font color=&quot;#007fff&quot;&gt;下面过滤器按优先级从高到低排序&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2960.75" y="1605" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-168" value="&lt;font color=&quot;#007fff&quot;&gt;这里可以看到SCG网关转发请求&lt;br&gt;其实就是重新发起请求&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2760" y="2800" width="190" height="40" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-171" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;TODO&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;监控原理&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="2280" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-178" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-173" target="TLQ8Jejc-yUDhLceZBrH-177">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-173" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;Route route = exchange.getAttribute(&lt;/div&gt;&lt;div style=&quot;&quot;&gt;GATEWAY_ROUTE_ATTR);&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;即获取前面与预言匹配的Route对象&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="2358" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-179" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0.5;exitY=1;exitDx=0;exitDy=0;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-177" target="TLQ8Jejc-yUDhLceZBrH-160">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-177" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;URI &lt;b&gt;uri&lt;/b&gt; = exchange.getRequest().getURI();&lt;/div&gt;&lt;div&gt;boolean encoded = containsEncodedParts(uri);&lt;/div&gt;&lt;div&gt;URI &lt;b&gt;routeUri&lt;/b&gt; = route.getUri();&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="2440" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-180" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;return this.&lt;b&gt;webSocketService&lt;/b&gt;.handleRequest(&lt;/div&gt;&lt;div&gt;exchange,&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;new ProxyWebSocketHandler(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;requestUrl,&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;this.webSocketClient, filtered, protocols));&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="2680" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-182" value="&lt;font color=&quot;#007fff&quot;&gt;TODO&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="3400.75" y="2695" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-183" value="schema: ws wss" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2795" y="2695" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-184" value="schema: forward" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2795" y="3215" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-185" value="schema: http https" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2790" y="2770" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-186" value="负载均衡" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2815" y="2615" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-187" value="URL转换" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2815" y="2373" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-188" value="监控" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2825" y="2295" width="50" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-189" value="后端服务响应返回" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2795" y="1815" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-190" value="资源释放" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="2820" y="1648" width="70" height="30" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-203" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-200" target="TLQ8Jejc-yUDhLceZBrH-202">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-200" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;URI requestUrl = exchange.getRequiredAttribute(&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;b&gt;GATEWAY_REQUEST_URL_ATTR&lt;/b&gt;);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;即前面 RouteToRequestUrlFilter 组装的完整URL&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="2760" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-205" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-202" target="TLQ8Jejc-yUDhLceZBrH-204">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-202" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;HttpHeaders filtered =&amp;nbsp;&lt;b&gt;filterRequest&lt;/b&gt;(&lt;/div&gt;&lt;div style=&quot;&quot;&gt;getHeadersFilters(), exchange);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;filtered.forEach(httpHeaders::set);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;依次执行HttpHeadersFilter提取请求头信息&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="2840" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-207" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-204" target="TLQ8Jejc-yUDhLceZBrH-206">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-204" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;Route route = exchange.getAttribute(&lt;br&gt;GATEWAY_ROUTE_ATTR);&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;获取前面匹配的Route&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="2920" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-210" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;" edge="1" parent="1" source="TLQ8Jejc-yUDhLceZBrH-206" target="TLQ8Jejc-yUDhLceZBrH-209">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-206" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;Flux&amp;lt;HttpClientResponse&amp;gt; responseFlux = &lt;b&gt;getHttpClient&lt;/b&gt;(route, exchange)&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;.headers(...).request(method).uri(uri)&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;.&lt;b&gt;send&lt;/b&gt;(...)&lt;/div&gt;&lt;div style=&quot;&quot;&gt;.&lt;b&gt;responseConnection&lt;/b&gt;(...)&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;即通过reactor-netty向后台服务发送Http请求&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这里的流程有必要在Markdown中详细讲解&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="3200" y="3000" width="200.75" height="100" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-209" value="&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;return responseFlux.then(chain.filter(exchange));&lt;br&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=8;" vertex="1" parent="1">
          <mxGeometry x="3200" y="3120" width="200.75" height="60" as="geometry" />
        </mxCell>
        <mxCell id="TLQ8Jejc-yUDhLceZBrH-211" value="&lt;font color=&quot;#007fff&quot;&gt;TODO 主流程代码提取出来&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="3400.75" y="3035" width="170" height="30" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="Ez1TyftaJfGHxwHzaOZi" name="第 2 页">
    <mxGraphModel dx="954" dy="674" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="zk2YVmp4RuFzN-BgWDgF-0" />
        <mxCell id="zk2YVmp4RuFzN-BgWDgF-1" parent="zk2YVmp4RuFzN-BgWDgF-0" />
        <mxCell id="QsaYZ_X7G6O-sY303PH3-0" value="Gateway Client" style="rounded=1;whiteSpace=wrap;html=1;" parent="zk2YVmp4RuFzN-BgWDgF-1" vertex="1">
          <mxGeometry x="40" y="120" width="120" height="40" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
