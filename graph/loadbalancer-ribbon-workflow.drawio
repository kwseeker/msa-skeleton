<mxfile host="Electron" modified="2023-10-27T10:11:43.107Z" agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/21.6.5 Chrome/114.0.5735.243 Electron/25.3.1 Safari/537.36" etag="xVfam6Oa12gu73FCF0Ty" version="21.6.5" type="device" pages="3">
  <diagram id="f3Fi9e5t7PhujOKiYEsx" name="SpringCloudLoadBalancer">
    <mxGraphModel dx="3498" dy="606" grid="1" gridSize="10" guides="0" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" background="none" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="KydxWmPEN0qJnf4pflOT-1" value="&lt;p style=&quot;line-height: 1&quot;&gt;&lt;/p&gt;&lt;h1&gt;&lt;font style=&quot;font-size: 20px&quot;&gt;Spring Cloud LoadBalancer 工作原理&lt;/font&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;(v3.1.5)&amp;nbsp;&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;这里研究 LoadBalancer 结合 Nacos 的负载均衡实现原理&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;所有测试DEMO，参考 SpringBoot-Labs/netflix-ribbon。&lt;/font&gt;&lt;/div&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;前提：&lt;/font&gt;&lt;/p&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;&lt;ul style=&quot;font-size: 10px&quot;&gt;&lt;li style=&quot;font-size: 10px&quot;&gt;Spring Cloud NamedContextFactory 机制（参考对应原理流程图，主要是为Specification创建独立的隔离的子应用上下文）&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;说明：&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="10" y="20" width="590" height="140" as="geometry" />
        </mxCell>
        <mxCell id="9Nb5X1CC6daOf7xSNShJ-1" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;需要重点关注的一些原理：&lt;br&gt;&lt;ul&gt;&lt;li&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;Spring Cloud LoadBalancer 是如何为不同的服务创建配置不同的客户端的？&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;主要归功于 NamedContextFactory 机制&lt;/font&gt;&lt;/li&gt;&lt;li&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;服务节点列表发生动态变更，SpringCloud如何及时监测到并更新缓存列表？&lt;/font&gt;&lt;/li&gt;&lt;/ul&gt;&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="600" y="20" width="640" height="140" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-1" target="khGB8-cCiWg7Y-Ce-5PI-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;fontSize=10;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-1" target="khGB8-cCiWg7Y-Ce-5PI-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;fontSize=10;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-1" target="khGB8-cCiWg7Y-Ce-5PI-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-1" value="自动配置阶段" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-5" target="khGB8-cCiWg7Y-Ce-5PI-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-5" value="spring-cloud-starter-alibaba-nacos-discovery&lt;br&gt;spring.factories" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-20" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-7" target="khGB8-cCiWg7Y-Ce-5PI-19" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-7" value="spring-cloud-starter-loadbalancer&lt;br&gt;spring.factories" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-17" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-10" target="khGB8-cCiWg7Y-Ce-5PI-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-18" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-10" target="khGB8-cCiWg7Y-Ce-5PI-14" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-24" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-10" target="khGB8-cCiWg7Y-Ce-5PI-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-29" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-10" target="khGB8-cCiWg7Y-Ce-5PI-15" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-10" value="请求处理流程&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;省略Spring MVC WebFlux&amp;nbsp; 处理流程&lt;br&gt;直接看Controller层负载均衡处理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="801" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-104" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-12" target="uEqFnHDyktXJyKcs36Fb-103" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-12" value="@LoadBalanced WebClient.Builder&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;在BeanPostProcessor中为WebClient.Builder添加了一个过滤器&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="1840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-107" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-14" target="uEqFnHDyktXJyKcs36Fb-106" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-14" value="ReactorLoadBalancerExchangeFilterFunction&lt;br&gt;WebClient.Builder" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-83" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-15" target="uEqFnHDyktXJyKcs36Fb-82" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-96" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-15" target="uEqFnHDyktXJyKcs36Fb-95" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-15" value="@LoadBalanced RestTemplate&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;本质是在RestTemplate拦截器中注册了一个&lt;b&gt;负载均衡拦截LoadBalancerInterceptor&lt;/b&gt;，&lt;br&gt;猜测还以为是创建了个动态代理&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="1320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-19" value="&lt;div&gt;&lt;b&gt;LoadBalancerAutoConfiguration&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;BlockingLoadBalancerClientAutoConfiguration&lt;/b&gt;&lt;/div&gt;&lt;div&gt;LoadBalancerCacheAutoConfiguration&lt;/div&gt;&lt;div&gt;OAuth2LoadBalancerClientAutoConfiguration&lt;/div&gt;&lt;div&gt;LoadBalancerStatsAutoConfiguration&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="500" y="350" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-21" value="&lt;div&gt;NacosDiscoveryAutoConfiguration&lt;/div&gt;&lt;div&gt;NacosDiscoveryEndpointAutoConfiguration&lt;/div&gt;&lt;div&gt;NacosServiceRegistryAutoConfiguration&lt;/div&gt;&lt;div&gt;NacosDiscoveryClientConfiguration&lt;/div&gt;&lt;div&gt;NacosReactiveDiscoveryClientConfiguration&lt;/div&gt;&lt;div&gt;NacosConfigServerAutoConfiguration&lt;/div&gt;&lt;div&gt;&lt;b&gt;LoadBalancerNacosAutoConfiguration&lt;/b&gt;&lt;/div&gt;&lt;div&gt;NacosServiceAutoConfiguration&lt;/div&gt;&lt;div&gt;UtilIPv6AutoConfiguration&lt;/div&gt;&lt;div&gt;&lt;b&gt;NacosLoadBalancerClientConfiguration&lt;/b&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="500" y="170" width="240" height="120" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-23" target="khGB8-cCiWg7Y-Ce-5PI-25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-23" value="LoadBalancerClient&amp;nbsp;RestTemplate&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里默认注入的是&amp;nbsp;BlockingLoadBalancerClient&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="280" y="801" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-28" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-25" target="khGB8-cCiWg7Y-Ce-5PI-27" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-7" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-25" target="iAYe1x8H37XBPk3sPTiQ-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-25" value="ServiceInstance instance = &lt;b&gt;loadBalancerClient&lt;/b&gt;.choose(&quot;demo-provider&quot;)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="801" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-81" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-27" target="uEqFnHDyktXJyKcs36Fb-80" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-27" value="根据 ServiceInstance (包括host port 等信息)创建真正的请求URL targetUrl" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-84" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;fillColor=#d5e8d4;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-32" target="khGB8-cCiWg7Y-Ce-5PI-25" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="860" y="390" />
              <mxPoint x="860" y="770" />
              <mxPoint x="620" y="770" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-32" value="&lt;div&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;BlockingLoadBalancerClient&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;依赖Bean LoadBalancerClientFactory&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="880" y="360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-33" target="iAYe1x8H37XBPk3sPTiQ-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-33" value="LoadBalancerClientFactory&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;继承 NamedContextFactory&amp;lt;&lt;br&gt;LoadBalancerClientSpecification&amp;gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="880" y="280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-5" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=-0.009;entryY=0.091;entryDx=0;entryDy=0;entryPerimeter=0;fillColor=#d5e8d4;strokeColor=default;shadow=0;" parent="1" source="khGB8-cCiWg7Y-Ce-5PI-37" target="khGB8-cCiWg7Y-Ce-5PI-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-37" value="LoadBalancerClientsProperties&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;spring.cloud.loadbalancer 前缀的配置属性，内部还有一些子属性类&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="880" y="200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-45" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;约定的默认配置：&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;properties = {&lt;b&gt;LoadBalancerClientsProperties&lt;/b&gt;@6009}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;clients&lt;/b&gt; = {HashMap@6030}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;healthCheck&lt;/b&gt; = {LoadBalancerProperties$HealthCheck@6031}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; initialDelay = {Duration@6037} &quot;PT0S&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; interval = {Duration@6038} &quot;PT25S&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; refetchInstancesInterval = {Duration@6039} &quot;PT25S&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; path = {LinkedCaseInsensitiveMap@6040}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; port = null&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; refetchInstances = false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; repeatHealthCheck = true&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;hint&lt;/b&gt; = {LinkedCaseInsensitiveMap@6032}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;hintHeaderName&lt;/b&gt; = &quot;X-SC-LB-Hint&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;retry&lt;/b&gt; = {LoadBalancerProperties$Retry@6034}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; enabled = true&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; retryOnAllOperations = false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; maxRetriesOnSameServiceInstance = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; maxRetriesOnNextServiceInstance = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; retryableStatusCodes = {HashSet@7051}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; backoff = {LoadBalancerProperties$Retry$Backoff@7052}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;stickySession&lt;/b&gt; = {LoadBalancerProperties$StickySession@6035}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; instanceIdCookieName = &quot;sc-lb-instance-id&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; addServiceInstanceCookie = false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;useRawStatusCodeInResponseData&lt;/b&gt; = false&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;xForwarded&lt;/b&gt; = {LoadBalancerProperties$XForwarded@6036}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&amp;nbsp; enabled = false&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBorderColor=default;" parent="1" vertex="1">
          <mxGeometry x="1440" y="200" width="320" height="330" as="geometry" />
        </mxCell>
        <mxCell id="khGB8-cCiWg7Y-Ce-5PI-47" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;创建的重要Bean&lt;/font&gt;" style="shape=singleArrow;whiteSpace=wrap;html=1;" parent="1" vertex="1">
          <mxGeometry x="760" y="280" width="100" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-1" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;b&gt;BlockingLoadBalancerClient&amp;nbsp;&lt;/b&gt;&lt;/font&gt;&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;implements LoadBalancerClient&lt;/span&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这个并不是实际的客户端实现，从其成员字段可以看到它其实是 &lt;b&gt;NamedContextFactory&lt;/b&gt;, &lt;b&gt;要查询某个服务&lt;br&gt;专属的子应用上下文还是需要通过这个Bean&lt;/b&gt;&lt;br&gt;&lt;/font&gt;&lt;br&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//实际类型是 LoadBalancerClientFactory，继承 NamedContextFactory&amp;lt;&lt;span style=&quot;background-color: initial;&quot;&gt;LoadBalancerClientSpecification&amp;gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;private final ReactiveLoadBalancer.Factory&amp;lt;ServiceInstance&amp;gt; &lt;b&gt;loadBalancerClientFactory&lt;/b&gt;;&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-520" y="200" width="480" height="120" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-3" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;super(&lt;/font&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;LoadBalancerClientConfiguration&lt;/b&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;.class, &quot;loadbalancer&quot;, &quot;loadbalancer.client.name&quot;);&lt;/font&gt;&lt;br&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;隔离的子应用上下文中都会加载配置类&lt;/font&gt;&lt;span style=&quot;font-size: 9px; border-color: var(--border-color);&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;LoadBalancerClientConfiguration&lt;/b&gt;，另外关注&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;font style=&quot;font-size: 9px;&quot; color=&quot;#007fff&quot;&gt;&lt;b&gt;LoadBalancerClientSpecification &lt;/b&gt;定义的隔离的Bean&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1100" y="280" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-6" target="iAYe1x8H37XBPk3sPTiQ-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-6" target="iAYe1x8H37XBPk3sPTiQ-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-6" value="ReactiveLoadBalancer&amp;lt;ServiceInstance&amp;gt; loadBalancer = this.loadBalancerClientFactory&lt;br&gt;.&lt;b&gt;getInstance&lt;/b&gt;(serviceId);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;// 1&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="801" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-8" value="BlockingLoadBalancerClient" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="775" y="769" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-3" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0;exitDx=0;exitDy=0;fillColor=#d5e8d4;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-9" target="uEqFnHDyktXJyKcs36Fb-2" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1240" y="790" />
              <mxPoint x="1240" y="645" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-9" value="return (ReactiveLoadBalancer)this&lt;br&gt;.&lt;b&gt;getInstance&lt;/b&gt;(serviceId, ReactorServiceInstanceLoadBalancer.class);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;从serviceId的子应用上下文获取&amp;nbsp;ReactorServiceInstanceLoadBalancer Bean实例&lt;br&gt;默认获取的是 &lt;b&gt;RoundRobinLoadBalancer&lt;/b&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="980" y="790" width="240" height="81" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-11" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;这里可以看到是以 serviceId (即服务名) 为name,&amp;nbsp;隔离子应用上下文的，&lt;br&gt;不过 ReactorServiceInstanceLoadBalancer 实例&lt;br&gt;是通过 &lt;b&gt;NamedContextFactory&lt;/b&gt; defautlConfigType(&lt;b style=&quot;border-color: var(--border-color); font-size: 9px; text-align: center;&quot;&gt;LoadBalancerClientConfiguration&lt;/b&gt;)&amp;nbsp;在子应用上下文&amp;nbsp;&lt;b&gt;refresh&lt;/b&gt;() 时加载的&lt;br&gt;即&amp;nbsp;LoadBalancerClientConfiguration&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="1220" y="790" width="560" height="70" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-32" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-12" target="iAYe1x8H37XBPk3sPTiQ-31" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-12" value="RoundRobinLoadBalancer&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Bean名：reactorServiceInstanceLoadBalancer&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="880" y="440" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-13" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;RandomLoadBalancer&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-250" y="520" width="200" height="33" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-14" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;i style=&quot;font-size: 10px;&quot;&gt;&amp;lt;&amp;lt;interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;ReactorLoadBalancer&lt;t style=&quot;font-size: 10px;&quot;&gt;&lt;/t&gt;&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-384" y="360" width="227" height="39" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-15" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;i style=&quot;font-size: 10px;&quot;&gt;&amp;lt;&amp;lt;interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;ReactorServiceInstanceLoadBalancer&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-426" y="441" width="310" height="39" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-16" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;RoundRobinLoadBalancer&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;轮询负载均衡器&lt;/font&gt;&lt;br&gt;&lt;br&gt;final AtomicInteger position;&lt;div&gt;final String serviceId;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//ObjectProvider 其实就是用于获取ServiceInstanceListSupplier Bean实例的&lt;/font&gt;&lt;/div&gt;&lt;div&gt;ObjectProvider&amp;lt;ServiceInstanceListSupplier&amp;gt; serviceInstanceListSupplierProvider;&lt;/div&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-680" y="520" width="386" height="120" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-17" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=1;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-13" target="iAYe1x8H37XBPk3sPTiQ-15" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-152" y="510" />
              <mxPoint x="-271" y="510" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-18" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-15" target="iAYe1x8H37XBPk3sPTiQ-14" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-19" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=1;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-16" target="iAYe1x8H37XBPk3sPTiQ-15" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-487" y="510" />
              <mxPoint x="-271" y="510" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-20" target="iAYe1x8H37XBPk3sPTiQ-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-20" target="iAYe1x8H37XBPk3sPTiQ-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-20" value="Response&amp;lt;ServiceInstance&amp;gt; loadBalancerResponse = (Response)&lt;br&gt;Mono.from(loadBalancer.&lt;b&gt;choose&lt;/b&gt;(request))&lt;br&gt;.&lt;b&gt;block&lt;/b&gt;();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-22" value="&lt;ol&gt;&lt;li&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;通过NamedContextFactory机制获取serviceId对应的ReactiveLoadBalancer Bean实例，默认是&lt;/span&gt;RoundRobinLoadBalancer&lt;br&gt;（即从某服务独立的子应用上下文获取其响应式&lt;b&gt;负载均衡器&lt;/b&gt;）&lt;/li&gt;&lt;li&gt;loadBalancer先获取ServiceInstanceListSupplier Bean 然后用此Supplier获取服务实例列表，最后根据负载均衡规则选取一个服务实例并返回&lt;br&gt;(即负载均衡器包含一个懒加载获取ServiceInstanceListSupplier Bean的 &lt;b&gt;ObjectProvider&lt;/b&gt;, 通过它获取 Supplier Bean 后，然后获取服务实例列表，最终会从 Nacos NacosReactiveDiscoveryClient 读取服务实例列表)&lt;br&gt;&lt;/li&gt;&lt;li&gt;执行负载均衡器中定义的负载均衡规则，从服务实例列表中选择一个实例&lt;/li&gt;&lt;li&gt;通过服务实例的地址信息创建真正的请求URL, 然后借助RestTemplate执行请求&lt;/li&gt;&lt;/ol&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;whiteSpace=wrap;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="240" y="860" width="360" height="180" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-23" value="return loadBalancerResponse == null ? null : (ServiceInstance)loadBalancerResponse&lt;br&gt;.getServer();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="760" y="1060" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-26" target="iAYe1x8H37XBPk3sPTiQ-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-26" target="iAYe1x8H37XBPk3sPTiQ-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-26" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;ServiceInstanceListSupplier supplier = (ServiceInstanceListSupplier)this.&lt;br&gt;&lt;b&gt;serviceInstanceListSupplierProvider&lt;/b&gt;.getIfAvailable(&lt;br&gt;NoopServiceInstanceListSupplier::new);&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="980" y="900" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-28" value="RoundRobinLoadBalancer" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1020" y="880" width="160" height="30" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-29" target="iAYe1x8H37XBPk3sPTiQ-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-37" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-29" target="uEqFnHDyktXJyKcs36Fb-4" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1230" y="1010" />
              <mxPoint x="1230" y="1250" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-29" value="&lt;div&gt;&lt;font size=&quot;1&quot;&gt;return &lt;b&gt;supplier&lt;/b&gt;.&lt;b&gt;get&lt;/b&gt;(request).&lt;b&gt;next&lt;/b&gt;()&lt;/font&gt;&lt;span style=&quot;font-size: x-small; background-color: initial;&quot;&gt;.map(&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-size: x-small; background-color: initial;&quot;&gt;(serviceInstances) -&amp;gt; {&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font size=&quot;1&quot;&gt;&amp;nbsp; &amp;nbsp; return this.&lt;b&gt;processInstanceResponse&lt;/b&gt;(supplier, serviceInstances);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font size=&quot;1&quot;&gt;});&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="980" y="980" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-31" value="new RoundRobinLoadBalancer(&lt;br&gt;loadBalancerClientFactory.getLazyProvider(name, ServiceInstanceListSupplier.class), name);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1100" y="440" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-36" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-33" target="iAYe1x8H37XBPk3sPTiQ-35" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-33" value="return this.delegate()&lt;br&gt;.getIfAvailable(defaultSupplier);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;获取&amp;nbsp;ServiceInstanceListSupplier Bean实例&lt;br&gt;为空则通过defaultSupplier 创建&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1240" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-39" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-35" target="iAYe1x8H37XBPk3sPTiQ-38" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-35" value="this.provider = this.clientFactory.getProvider(this.name, this.type);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;首次执行provider为null, 创建provider后存到provider&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1480" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-37" value="ClientFactoryObjectProvider" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1250" y="878" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-38" target="iAYe1x8H37XBPk3sPTiQ-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-38" value="&lt;div&gt;AnnotationConfigApplicationContext context = this.getContext(name);&lt;/div&gt;&lt;div&gt;return context.&lt;b&gt;getBeanProvider&lt;/b&gt;(type);&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;获取ServiceInstanceListSupplier的 ObjectProvider&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1720" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-40" value="NamedContextFactory" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1750" y="878" width="140" height="30" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-41" value="&lt;div&gt;resolveBean()&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="1960" y="900" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-34" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="iAYe1x8H37XBPk3sPTiQ-43" target="uEqFnHDyktXJyKcs36Fb-33" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="iAYe1x8H37XBPk3sPTiQ-43" value="supplier.get(request)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;ServiceInstanceListSupplier是&lt;b&gt;装饰器模式&lt;/b&gt;组织的，会依次执行每一层get()&lt;br&gt;// 2&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-68" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-1" target="uEqFnHDyktXJyKcs36Fb-67" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-1" value="DiscoveryClientServiceInstanceListSupplier&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Bean名：reactorServiceInstanceLoadBalancer&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="880" y="520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-2" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;this.&lt;b&gt;clientFactory&lt;/b&gt; = {LoadBalancerClientFactory@9255}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;properties = {LoadBalancerClientsProperties@9278}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;propertySourceName = &quot;loadbalancer&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;propertyName = &quot;loadbalancer.client.name&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b&gt;contexts&lt;/b&gt; = {ConcurrentHashMap@9281}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &quot;demo-provider&quot; -&amp;gt; {AnnotationConfigApplicationContext@9277}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;key = &quot;demo-provider&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp;value = {&lt;b&gt;AnnotationConfigApplicationContext&lt;/b&gt;@9277}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;beanFactory&lt;/b&gt; = {DefaultListableBeanFactory@10536}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp;&lt;b&gt;singletonObjects&lt;/b&gt; = {ConcurrentHashMap@10617}&amp;nbsp; size = 22&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;org.springframework.cloud.loadbalancer.annotation.LoadBalancerClientConfiguration$ReactiveSupportConfiguration&quot; -&amp;gt; {LoadBalancerClientConfiguration$ReactiveSupportConfiguration@10530}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&quot; -&amp;gt; {ConfigurationClassPostProcessor@10905}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;propertySourcesPlaceholderConfigurer&quot; -&amp;gt; {PropertySourcesPlaceholderConfigurer@10906}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;applicationStartup&quot; -&amp;gt; {DefaultApplicationStartup@10574}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;autoConfigurationReport&quot; -&amp;gt; {ConditionEvaluationReport@10909}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;org.springframework.context.event.internalEventListenerFactory&quot; -&amp;gt; {DefaultEventListenerFactory@10910}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;systemEnvironment&quot; -&amp;gt; {Collections$UnmodifiableMap@10912}&amp;nbsp; size = 50&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;org.springframework.context.event.internalEventListenerProcessor&quot; -&amp;gt; {EventListenerMethodProcessor@10913}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;propertyPlaceholderAutoConfiguration&quot; -&amp;gt; {PropertyPlaceholderAutoConfiguration@10914}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;loadBalancerClientConfiguration&quot; -&amp;gt; {LoadBalancerClientConfiguration@10915}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;lifecycleProcessor&quot; -&amp;gt; {DefaultLifecycleProcessor@10833}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;org.springframework.context.annotation.internalAutowiredAnnotationProcessor&quot; -&amp;gt; {AutowiredAnnotationBeanPostProcessor@10917}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;org.springframework.context.annotation.ConfigurationClassPostProcessor.importRegistry&quot; -&amp;gt; {ConfigurationClassParser$ImportStack@10919}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;applicationEventMulticaster&quot; -&amp;gt; {SimpleApplicationEventMulticaster@10573}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;environment&quot; -&amp;gt; {StandardEnvironment@10566}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;org.springframework.context.annotation.internalCommonAnnotationProcessor&quot; -&amp;gt; {CommonAnnotationBeanPostProcessor@10922}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;&lt;b&gt;reactorServiceInstanceLoadBalancer&lt;/b&gt;&quot; -&amp;gt; {RoundRobinLoadBalancer@10802}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;&lt;b&gt;discoveryClientServiceInstanceListSupplier&lt;/b&gt;&quot; -&amp;gt; {CachingServiceInstanceListSupplier@10523}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;systemProperties&quot; -&amp;gt; {Properties@10924}&amp;nbsp; size = 70&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;xForwarderHeadersTransformer&quot; -&amp;gt; {XForwardedHeadersTransformer@10925}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;messageSource&quot; -&amp;gt; {DelegatingMessageSource@10572} &quot;Empty MessageSource&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &quot;org.springframework.cloud.loadbalancer.annotation.LoadBalancerClientConfiguration$BlockingSupportConfiguration&quot; -&amp;gt; {LoadBalancerClientConfiguration$BlockingSupportConfiguration@10927}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; ...&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;configurations = {ConcurrentHashMap@9282}&amp;nbsp; size = 2&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;parent = {AnnotationConfigServletWebServerApplicationContext@9283}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;defaultConfigType = {Class@9284} &quot;class org.springframework.cloud.loadbalancer.annotation.&lt;b&gt;LoadBalancerClientConfiguration&lt;/b&gt;&quot;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;labelBorderColor=default;" parent="1" vertex="1">
          <mxGeometry x="1760" y="410" width="910" height="470" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-64" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-4" target="uEqFnHDyktXJyKcs36Fb-63" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-4" value="processInstanceResponse(supplier, serviceInstances)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;next() 等待服务实例列表返回后，根据负载均衡规则选择一个实例回&amp;nbsp;DefaultResponse&lt;br&gt;// 3&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1240" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-5" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;CachingServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;private final &lt;b&gt;Flux&lt;/b&gt;&amp;lt;List&amp;lt;ServiceInstance&amp;gt;&amp;gt; &lt;br&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;&lt;b&gt;serviceInstances&lt;/b&gt;;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-1140" y="962" width="250" height="58" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-6" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;DelegatingServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;protected final ServiceInstanceListSupplier delegate;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1040" y="870" width="256" height="44" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-71" style="rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=0;exitY=0;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;fillColor=#d5e8d4;strokeColor=default;shape=link;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-7" target="uEqFnHDyktXJyKcs36Fb-70" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-7" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;DiscoveryClientServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-748.5" y="881" width="260" height="33" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-8" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;HealthCheckServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-1380" y="962" width="227" height="33" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-9" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;HintBasedServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-870" y="962" width="220" height="33" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-10" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;NoopServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-470" y="881" width="180" height="33" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-11" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;RequestBasedStickySessionServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-1710" y="962" width="300" height="33" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-12" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;RetryAwareServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-1970" y="962" width="221" height="33" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-13" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;SameInstancePreferenceServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-330" y="962" width="280" height="33" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-14" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;i style=&quot;font-size: 10px;&quot;&gt;&amp;lt;&amp;lt;interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;SelectedInstanceCallback&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-200" y="875" width="160" height="39" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-15" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;i style=&quot;font-size: 10px;&quot;&gt;&amp;lt;&amp;lt;interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br style=&quot;font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;ServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-740" y="800" width="243" height="39" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-16" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;ZonePreferenceServiceInstanceListSupplier&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-610" y="962" width="243" height="33" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-17" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-5" target="uEqFnHDyktXJyKcs36Fb-6" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-18" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=1;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-6" target="uEqFnHDyktXJyKcs36Fb-15" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-912" y="860" />
              <mxPoint x="-618" y="860" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-19" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=1;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-7" target="uEqFnHDyktXJyKcs36Fb-15" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-20" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-8" target="uEqFnHDyktXJyKcs36Fb-6" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1266" y="937" />
              <mxPoint x="-912" y="937" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-21" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-9" target="uEqFnHDyktXJyKcs36Fb-6" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-760" y="937" />
              <mxPoint x="-912" y="937" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-22" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=1;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-10" target="uEqFnHDyktXJyKcs36Fb-15" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-380" y="860" />
              <mxPoint x="-618" y="860" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-23" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-11" target="uEqFnHDyktXJyKcs36Fb-6" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1560" y="937" />
              <mxPoint x="-912" y="937" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-24" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-12" target="uEqFnHDyktXJyKcs36Fb-6" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1859" y="937" />
              <mxPoint x="-912" y="937" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-25" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.250;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-13" target="uEqFnHDyktXJyKcs36Fb-6" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-260" y="937" />
              <mxPoint x="-912" y="937" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-26" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=1;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.750;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-13" target="uEqFnHDyktXJyKcs36Fb-14" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-120" y="920" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-27" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=default;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;fontSize=10;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-16" target="uEqFnHDyktXJyKcs36Fb-6" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-488" y="937" />
              <mxPoint x="-912" y="937" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-28" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;如果启用健康检查、粘性会话、提示等功能&lt;br&gt;会加载多个ServiceInstanceListSupplier 实现&lt;br&gt;组织模式是&lt;b&gt;装饰器模式&lt;/b&gt;&lt;/font&gt;" style="text;html=1;align=right;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="-1270" y="860" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-29" value="&lt;font color=&quot;#000000&quot; style=&quot;font-size: 10px;&quot;&gt;Spring Cloud LoadBalancer + Nacos 不添加任何配置的话，默认就是下面这种&lt;br&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;如果开启多种功能，会在中间插入其他的ServiceInstanceListSupplier实现&lt;/span&gt;&lt;br&gt;&lt;/font&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;this = {&lt;b&gt;CachingServiceInstanceListSupplier&lt;/b&gt;@10523}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;serviceInstances = {FluxDefer@10932} &quot;FluxDefer&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;&lt;b&gt;delegate&lt;/b&gt; = {&lt;b&gt;DiscoveryClientServiceInstanceListSupplier&lt;/b&gt;@10524}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; timeout = {Duration@10934} &quot;PT30S&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; serviceId = &quot;demo-provider&quot;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp; serviceInstances = {FluxDefer@10935} &quot;FluxDefer&quot;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-920" y="1040" width="370" height="110" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-46" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-33" target="uEqFnHDyktXJyKcs36Fb-45" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-33" value="&lt;b&gt;CachingServiceInstanceListSupplier&lt;/b&gt;#get()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;定义先从缓存中取服务实例列表，缓存为空则交给下一级（&lt;b&gt;delegate&lt;/b&gt;） ServiceInstanceListSupplier get()&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-59" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-35" target="uEqFnHDyktXJyKcs36Fb-57" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-35" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;&lt;b&gt;DiscoveryClientServiceInstanceListSupplier&lt;/b&gt;#&lt;br&gt;get()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;定义从服务发现服务中获取服务实例列表&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-53" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-38" target="uEqFnHDyktXJyKcs36Fb-35" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1700" y="1090" />
              <mxPoint x="1700" y="1130" />
              <mxPoint x="1460" y="1130" />
              <mxPoint x="1460" y="1170" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-38" value="&lt;font size=&quot;1&quot;&gt;中间根据配置可能有其他ServiceInstanceListSupplier&lt;br&gt;不过这些&amp;nbsp;&lt;/font&gt;Supplier 不是共存的，有些和 Cache Supplier 也不共存&lt;font size=&quot;1&quot;&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1060" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-48" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-45" target="uEqFnHDyktXJyKcs36Fb-47" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-45" value="return serviceInstances;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;是Flux&amp;lt;List&amp;lt;ServiceInstance&amp;gt;&amp;gt; 类型，即数据发布者&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1720" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-51" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-47" target="uEqFnHDyktXJyKcs36Fb-38" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="2180" y="1010" />
              <mxPoint x="2180" y="1050" />
              <mxPoint x="1460" y="1050" />
              <mxPoint x="1460" y="1090" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-54" value="onCacheMissResume 内部逻辑" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="uEqFnHDyktXJyKcs36Fb-51" vertex="1" connectable="0">
          <mxGeometry x="-0.6906" y="2" relative="1" as="geometry">
            <mxPoint x="-31" as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-47" value="serviceInstances = &lt;b&gt;CacheFlux&lt;/b&gt;.&lt;b&gt;lookup&lt;/b&gt;(key -&amp;gt; {...}, delegate.getServiceId())&lt;br&gt;.&lt;b&gt;onCacheMissResume&lt;/b&gt;(...).&lt;b&gt;andWriteWith&lt;/b&gt;(...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;CacheFlux属于reactor-extra的逻辑，不深入了&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1960" y="980" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-50" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;lookup: 先从缓存查询，&lt;br&gt;onCacheMissResume： 查询为空执行，即从下一个ServiceInstanceListSupplier#get() 获取，&lt;br&gt;andWriteWith： 获取成功再写入缓存&lt;br&gt;参考测试：&amp;nbsp;&lt;/font&gt;CacheFluxLoadBalancerTest#testMockLoadBalancerCacheFlux()&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="2180" y="980" width="420" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-60" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-57" target="uEqFnHDyktXJyKcs36Fb-58" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-57" value="return serviceInstances;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;是Flux&amp;lt;List&amp;lt;ServiceInstance&amp;gt;&amp;gt; 类型，即数据发布者&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-62" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-58" target="uEqFnHDyktXJyKcs36Fb-61" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-58" value="serviceInstances = Flux.defer(() -&amp;gt; {...})&lt;br&gt;.onErrorResume(...)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1960" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-75" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-61" target="uEqFnHDyktXJyKcs36Fb-74" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-61" value="&lt;b&gt;delegate&lt;/b&gt;.getInstances(serviceId)&lt;br&gt;.collectList().flux()&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里delegate 就是配置类中创建的&lt;/font&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;NacosReactiveDiscoveryClient&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="2200" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-66" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-63" target="uEqFnHDyktXJyKcs36Fb-65" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-63" value="Response&amp;lt;ServiceInstance&amp;gt; serviceInstanceResponse = &lt;b&gt;getInstanceResponse&lt;/b&gt;(serviceInstances);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;此方法中定义负载均衡规则实现&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-65" value="&lt;div&gt;int pos = this.position.incrementAndGet() &amp;amp; Integer.MAX_VALUE;&lt;/div&gt;&lt;div&gt;ServiceInstance instance = instances.get(pos % instances.size());&lt;span style=&quot;&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;RoundRobin 主要实现是这两行代码&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1720" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-67" value="return &lt;b&gt;ServiceInstanceListSupplier&lt;/b&gt;.builder()&lt;br&gt;.withDiscoveryClient().withCaching()&lt;br&gt;.build(context);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="1120" y="520" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-69" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;ServiceInstanceListSupplierBuilder&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;业务中真正的ServiceInstanceListSupplier 是经过层层装饰的对象，是使用这个&lt;br&gt;&amp;nbsp;Builder类构建起来的&lt;/font&gt;&lt;br&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;//实际用于获取服务实例列表的 Supplier 的创建 Function, 比如DiscoveryClientServiceInstanceListSupplier&lt;br&gt;&lt;/font&gt;&lt;div&gt;private Creator baseCreator;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;//缓存Supplier 的创建 Function &lt;/font&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;private DelegateCreator cachingCreator;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;//其他过滤服务实例的 Supplier 的创建 Function, 这些 Supplier 逻辑不是共存的&lt;/font&gt;&lt;/div&gt;&lt;div&gt;private final List&amp;lt;DelegateCreator&amp;gt; creators = new ArrayList&amp;lt;&amp;gt;();&lt;/div&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-520" y="1040" width="480" height="140" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-70" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center;&quot;&gt;&lt;b&gt;DiscoveryClientServiceInstanceListSupplier&lt;/b&gt;&lt;br&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;private Duration timeout = Duration.ofSeconds(30);&lt;/div&gt;&lt;div&gt;private final String serviceId;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;// serviceInstances 是个Flux发布器，内部通过 delegate.getInstances(serviceId)&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;获取服务列表，而 &lt;b&gt;delegate 是配置类中创建的 ReactiveDiscoveryClient Bean实例&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;private final Flux&amp;lt;List&amp;lt;ServiceInstance&amp;gt;&amp;gt; &lt;b&gt;serviceInstances&lt;/b&gt;;&lt;/div&gt;&lt;/div&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-1200" y="720" width="400" height="120" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-72" value="NacosReactiveDiscoveryClient&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;Bean名：nacosReactiveDiscoveryClient&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="880" y="600" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-73" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;太多了，梳理后面逻辑的时候&lt;br&gt;遇到要注入Bean再回来找&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="730" y="340" width="150" height="40" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-77" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-74" target="uEqFnHDyktXJyKcs36Fb-76" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-74" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;return Mono.justOrEmpty(serviceId)&lt;br&gt;.flatMapMany(this.&lt;b&gt;loadInstancesFromNacos&lt;/b&gt;())&lt;br&gt;.subscribeOn(Schedulers.boundedElastic());&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2440" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-79" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-76" target="uEqFnHDyktXJyKcs36Fb-78" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-76" value="&lt;font size=&quot;1&quot;&gt;serviceDiscovery.&lt;b&gt;getInstances&lt;/b&gt;(serviceId)&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="2680" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-78" value="&lt;font size=&quot;1&quot;&gt;String group = this.discoveryProperties.getGroup();&lt;br&gt;&lt;b&gt;nacosServiceManager&lt;/b&gt;.getNamingService()&lt;br&gt;&lt;/font&gt;.&lt;b&gt;selectInstances&lt;/b&gt;(serviceId, group, true);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;这里回去看下Nacos源码流程&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1">
          <mxGeometry x="2920" y="1140" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-80" value="String response = restTemplateWithoutLB.&lt;b&gt;getForObject&lt;/b&gt;(&lt;br&gt;targetUrl, String.class);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;// 4 执行 RestTemplate 常规请求&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520" y="1220" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-86" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-82" target="uEqFnHDyktXJyKcs36Fb-85" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-89" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-82" target="uEqFnHDyktXJyKcs36Fb-87" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-93" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-82" target="uEqFnHDyktXJyKcs36Fb-91" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-94" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.439;entryDx=0;entryDy=0;entryPerimeter=0;dashed=1;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-82" target="uEqFnHDyktXJyKcs36Fb-90" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-82" value="@LoadBalanced 相关处理逻辑&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;参考LoadBalancerAutoConfiguration&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-85" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;@LoadBalanced&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;@Autowired(required = false)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;private List&amp;lt;RestTemplate&amp;gt; restTemplates = Collections.emptyList();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;注入所有注释有@LoadBalanced的RestTemplate Bean&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="1320" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-92" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-87" target="uEqFnHDyktXJyKcs36Fb-90" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1170" y="1680" />
              <mxPoint x="1170" y="1590" />
              <mxPoint x="750" y="1590" />
              <mxPoint x="750" y="1555" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-87" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;@Bean&lt;/div&gt;&lt;div&gt;public &lt;b&gt;SmartInitializingSingleton&lt;/b&gt; loadBalancedRestTemplateInitializerDeprecated(&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; final &lt;b&gt;ObjectProvider&lt;/b&gt;&amp;lt;List&amp;lt;RestTemplateCustomizer&amp;gt;&amp;gt; &lt;b&gt;restTemplateCustomizers&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return () -&amp;gt; restTemplateCustomizers.ifAvailable(customizers -&amp;gt; {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (RestTemplate restTemplate : LoadBalancerAutoConfiguration.this.&lt;b&gt;restTemplates&lt;/b&gt;) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; for (RestTemplateCustomizer customizer : customizers) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &lt;b&gt;customizer&lt;/b&gt;.customize(restTemplate);&amp;nbsp;&lt;font color=&quot;#007fff&quot;&gt; //即执行&amp;nbsp;LoadBalancerInterceptor 的注册&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; });&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;创建 SmartInitializingSingleton Bean, 会在所有单例Bean初始化完成后调用&amp;nbsp;afterSingletonsInstantiated() 即 这里的 lambda 表达式&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=3;" parent="1" vertex="1">
          <mxGeometry x="760" y="1600" width="400" height="160" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-90" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div style=&quot;&quot;&gt;@Bean&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;@ConditionalOnMissingBean&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;public &lt;b&gt;RestTemplateCustomizer&lt;/b&gt; restTemplateCustomizer(final LoadBalancerInterceptor loadBalancerInterceptor) {&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; return restTemplate -&amp;gt; {&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; 里面将 &lt;b&gt;loadBalancerInterceptor&lt;/b&gt; 添加到 restTemplate 的拦截器链中&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp; &amp;nbsp; };&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;}&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=8;" parent="1" vertex="1">
          <mxGeometry x="760" y="1480" width="400" height="100" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-91" value="&lt;div style=&quot;font-size: 8px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;@Bean&lt;/div&gt;&lt;div&gt;public LoadBalancerInterceptor loadBalancerInterceptor(LoadBalancerClient loadBalancerClient,&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; LoadBalancerRequestFactory requestFactory) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; return new &lt;b&gt;LoadBalancerInterceptor&lt;/b&gt;(&lt;b&gt;loadBalancerClient&lt;/b&gt;, requestFactory);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 8px;&quot; color=&quot;#007fff&quot;&gt;// 这里的 loadBalancerClient 和 上面的是同一个Bean&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=9;" parent="1" vertex="1">
          <mxGeometry x="760" y="1400" width="400" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-95" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;RestTemplate 经过&amp;nbsp;loadBalancerInterceptor&lt;br&gt;loadBalancerClient 处理后URL就转换成可以访问的URL了&lt;br&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;拦截器参考RestTemplate 源码流程图&lt;/font&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-97" value="LoadBalancerAutoConfiguration" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="790" y="1288" width="190" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-99" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;借助 SmartInitializingSingleton 机制&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="280" y="1380" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-100" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;借助 BeanPostProcessor 机制&lt;/font&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="280" y="1900" width="200" height="30" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-101" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;@Override&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;public Object &lt;b&gt;postProcessBeforeInitialization&lt;/b&gt;(Object bean, String beanName) throws BeansException {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; if (bean instanceof &lt;b&gt;WebClient.Builder&lt;/b&gt;) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; if (context.findAnnotationOnBean(beanName, LoadBalanced.class) == null) {&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return bean;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; ((WebClient.Builder) bean).&lt;b&gt;filter&lt;/b&gt;(exchangeFilterFunction);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; }&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; return bean;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;}&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 9px;&quot;&gt;即为所有注释有 @LoadBalanced 的&amp;nbsp;WebClient.Builder 注册&amp;nbsp;DeferringLoadBalancerExchangeFilterFunction&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=2;" parent="1" vertex="1">
          <mxGeometry x="760" y="1800" width="400" height="140" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-105" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;strokeColor=default;shadow=0;" parent="1" source="uEqFnHDyktXJyKcs36Fb-103" target="uEqFnHDyktXJyKcs36Fb-101" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-103" value="LoadBalancerWebClientBuilder&lt;br&gt;BeanPostProcessor" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1840" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="uEqFnHDyktXJyKcs36Fb-106" value="WebClient.builder().filter(lbFunction).build()&lt;br&gt;.get().uri(...).retrieve()&lt;br&gt;.bodyToMono(...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;也是注册过滤器的方式，和上面相同&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" edge="1" parent="1" source="hy-jY-Vdd2qQ_RdFIRII-1" target="hy-jY-Vdd2qQ_RdFIRII-2">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-1" value="ServiceInstanceListSupplierBuilder&amp;nbsp;&lt;br&gt;Bean 实例化原理&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;研究这个流程主要是为了自定义Supplier&lt;br&gt;这个Bean用了装饰器模式&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="2080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" edge="1" parent="1" source="hy-jY-Vdd2qQ_RdFIRII-2" target="hy-jY-Vdd2qQ_RdFIRII-4">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-2" value="&lt;b&gt;LoadBalancerClientConfiguration&lt;/b&gt;#&lt;br&gt;discoveryClientServiceInstanceListSupplier(&lt;br&gt;ConfigurableApplicationContext context))" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="2080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-4" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;return &lt;b&gt;ServiceInstanceListSupplier&lt;/b&gt;.builder()&lt;br&gt;.withDiscoveryClient().withCaching()&lt;br&gt;.build(context);&lt;br&gt;&lt;/font&gt;&lt;font color=&quot;#007fff&quot;&gt;通过withXxx() 方法装配功能, Supplier初始化原理较简单略&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="520" y="2080" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-6" value="DiscoveryClientServiceInstanceListSupplier 是&amp;nbsp;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-500" y="800" width="270" height="30" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-10" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;strokeColor=default;shadow=0;" edge="1" parent="1" source="hy-jY-Vdd2qQ_RdFIRII-8" target="hy-jY-Vdd2qQ_RdFIRII-9">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-13" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeColor=default;shadow=0;" edge="1" parent="1" source="hy-jY-Vdd2qQ_RdFIRII-8" target="hy-jY-Vdd2qQ_RdFIRII-11">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-8" value="@LoadBalancerClient &amp;amp;&lt;br&gt;@LoadBalancerClients 原理&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;其实本质就是&lt;b&gt;@Import&lt;/b&gt;，源码搜索到右边两个应用场景&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="40" y="2180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-9" value="&lt;font size=&quot;1&quot;&gt;DiscoveryLoadBalancerConfiguration&lt;br&gt;中用于创建 HasFeatures Bean&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;HasFeatures 机制用于 Actuator 中查看引入用了哪些功能的，暂略&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="2180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-22" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" edge="1" parent="1" source="hy-jY-Vdd2qQ_RdFIRII-11" target="hy-jY-Vdd2qQ_RdFIRII-21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-11" value="&lt;font style=&quot;&quot;&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;LoadBalancerClientConfigurationRegistrar&lt;/b&gt;&lt;font size=&quot;1&quot;&gt; implements &lt;/font&gt;&lt;b style=&quot;font-size: 9px;&quot;&gt;ImportBeanDefinitionRegistrar&lt;/b&gt;&lt;br&gt;&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;&lt;font size=&quot;1&quot;&gt;实现了ImportBeanDefinitionRegistrar&lt;/font&gt;&lt;br&gt;&lt;font size=&quot;1&quot;&gt;接口，就是用于注册BeanDefinition的&lt;/font&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="280" y="2260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-14" value="&lt;font size=&quot;1&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;registry.registerBeanDefinition(...)&lt;/span&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;fontSize=10;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="760" y="2260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-16" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;这两个注解都注释了@Import&lt;br&gt;&lt;span style=&quot;&quot;&gt;@Import(LoadBalancerClientConfigurationRegistrar.class)&lt;br&gt;&lt;/span&gt;@Import 注解处理原理参考 Spring流程图&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-40" y="2240" width="280" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-18" value="注意子应用上下文（Bean容器）维护在这个Bean里&lt;br&gt;调试时经常需要查看子应用上下文验证一些猜想或查看效果，&lt;br&gt;就从这个Bean进去&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;loadBalancerClient = {BlockingLoadBalancerClient@9228}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;&lt;b&gt;loadBalancerClientFactory&lt;/b&gt; = {LoadBalancerClientFactory@9226}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; properties = {LoadBalancerClientsProperties@9586}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; propertySourceName = &quot;loadbalancer&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; propertyName = &quot;loadbalancer.client.name&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &lt;b&gt;contexts&lt;/b&gt; = {ConcurrentHashMap@9589}&amp;nbsp; size = 1&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp; &amp;nbsp;&quot;demo-provider&quot; -&amp;gt; {&lt;b&gt;AnnotationConfigApplicationContext&lt;/b&gt;@9225}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" vertex="1" parent="1">
          <mxGeometry x="-920" y="195" width="400" height="170" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-20" value="&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#ea6b66&quot; style=&quot;font-size: 11px;&quot;&gt;这里发现 @LoadBalancerClient &amp;amp;&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;@LoadBalancerClients 引入的配置类定义的Bean &lt;br&gt;并不会被父应用上下文加载，什么原因？测试参考 name 和&amp;nbsp;&lt;/span&gt;anotherName 这两个Bean&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#ea6b66&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;结合之前的Spring的流程图看&amp;nbsp;&lt;/font&gt;beanFactory.preInstantiateSingletons() 这一步确实没有 anotherName&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 11px;&quot;&gt;&lt;font color=&quot;#ea6b66&quot; style=&quot;font-size: 11px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;TODO&amp;nbsp;&lt;/span&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;LoadBalancerClientConfigurationRegistrar 处理原理&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="970" y="2260" width="510" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-23" style="edgeStyle=orthogonalEdgeStyle;rounded=0;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" edge="1" parent="1" source="hy-jY-Vdd2qQ_RdFIRII-21" target="hy-jY-Vdd2qQ_RdFIRII-14">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-21" value="&lt;font size=&quot;1&quot;&gt;&lt;span style=&quot;font-weight: normal;&quot;&gt;TODO&lt;/span&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fontStyle=1;fillColor=#f8cecc;strokeColor=#b85450;" vertex="1" parent="1">
          <mxGeometry x="520" y="2260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="hy-jY-Vdd2qQ_RdFIRII-24" value="&lt;p style=&quot;margin: 4px 0px 0px; text-align: center; font-size: 10px;&quot;&gt;&lt;b style=&quot;font-size: 10px;&quot;&gt;NacosLoadBalancer&lt;/b&gt;&lt;/p&gt;&lt;hr style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;&amp;nbsp;Nacos实现的负载均衡器，使用&lt;b&gt;随机权重&lt;/b&gt;算法，支持&lt;b&gt;总是连接同集群同IP类型服务实例&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;br&gt;&lt;div&gt;private final String &lt;b&gt;serviceId&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;private ObjectProvider&amp;lt;ServiceInstanceListSupplier&amp;gt; &lt;b&gt;serviceInstanceListSupplierProvider&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;private final NacosDiscoveryProperties &lt;b&gt;nacosDiscoveryProperties&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;private static final String IPV4_REGEX = &quot;((2(5[0-5]|[0-4]\\d))|[0-1]?\\d{1,2})(.((2(5[0-5]|[0-4]\\d))|[0-1]?\\d{1,2})){3}&quot;;&lt;/div&gt;&lt;div&gt;private static final String IPV6_KEY = &quot;IPv6&quot;;&lt;/div&gt;&lt;div&gt;public static String &lt;b&gt;ipv6&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;@Autowired&lt;/div&gt;&lt;div&gt;private InetIPv6Utils &lt;b&gt;inetIPv6Utils&lt;/b&gt;;&lt;/div&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=10;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" vertex="1" parent="1">
          <mxGeometry x="-1240" y="520" width="519" height="160" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram id="sthaRJRf7krDnvooZX53" name="Ribbon">
    <mxGraphModel dx="3088" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="WeO6OLhi-FBfppIhu5CC-1" value="&lt;b&gt;URLConnectionLoadBalancerExample&lt;/b&gt;&lt;br&gt;使用LoadBalancerCommand通过固定Server列表的负载均衡器和HttpURLConnection发送请求的示例。" style="text;html=1;align=left;verticalAlign=middle;whiteSpace=wrap;rounded=0;" parent="1" vertex="1">
          <mxGeometry x="40" y="20" width="480" height="50" as="geometry" />
        </mxCell>
        <mxCell id="WeO6OLhi-FBfppIhu5CC-5" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="WeO6OLhi-FBfppIhu5CC-3" target="WeO6OLhi-FBfppIhu5CC-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="WeO6OLhi-FBfppIhu5CC-3" value="List&amp;lt;Server&amp;gt; servers =&amp;nbsp;&lt;br style=&quot;font-size: 10px;&quot;&gt;Lists.newArrayList(new Server(...), ...)&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;b&gt;获取服务节点列表&lt;/b&gt;，企业级应用一般是从注册中心通过服务名获取的&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="80" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-3" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="WeO6OLhi-FBfppIhu5CC-4" target="dFHeEVBBE8L6X1gG-yMv-2" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-95" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="WeO6OLhi-FBfppIhu5CC-4" target="dFHeEVBBE8L6X1gG-yMv-94" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="WeO6OLhi-FBfppIhu5CC-4" value="URLConnectionLoadBalancer &lt;b&gt;urlLoadBalancer&lt;/b&gt; = new URLConnectionLoadBalancer(servers);&lt;br&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-1" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;com.netflix.loadbalancer.&lt;/font&gt;&lt;b style=&quot;font-size: 10px; color: rgb(0, 0, 0); background-color: initial;&quot;&gt;Server&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;服务端服务实例描述对象&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;private String &lt;b&gt;host&lt;/b&gt;;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;private int &lt;b&gt;port&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;private String &lt;b&gt;scheme&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;private volatile String &lt;b&gt;id&lt;/b&gt;;&lt;/div&gt;&lt;div&gt;private volatile boolean isAliveFlag;&lt;/div&gt;&lt;div&gt;private String zone;&lt;/div&gt;&lt;div&gt;private volatile boolean readyToServe;&lt;/div&gt;&lt;div&gt;private MetaInfo simpleMetaInfo;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-320" y="80" width="280" height="240" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-11" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-2" target="dFHeEVBBE8L6X1gG-yMv-9" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-12" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-2" target="dFHeEVBBE8L6X1gG-yMv-4" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-2" value="loadBalancer = LoadBalancerBuilder.newBuilder()&lt;br&gt;.&lt;b&gt;buildFixedServerListLoadBalancer&lt;/b&gt;(&lt;br&gt;serverList);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-31" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-4" target="dFHeEVBBE8L6X1gG-yMv-30" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-42" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-4" target="dFHeEVBBE8L6X1gG-yMv-41" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-4" value="&lt;div&gt;if (rule == null) {&lt;/div&gt;&lt;div&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;&amp;nbsp; &amp;nbsp; rule = createRuleFromConfig(config, factory);&lt;/font&gt;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;创建负载均衡规则，根据实际加载的配置&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#007fff&quot;&gt;NFLoadBalancerRuleClassName&amp;nbsp;&lt;/font&gt;&lt;span style=&quot;color: rgb(0, 127, 255); background-color: initial;&quot;&gt;创建&lt;/span&gt;&lt;font color=&quot;#007fff&quot;&gt;&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#fff2cc;strokeColor=#d6b656;align=left;" parent="1" vertex="1">
          <mxGeometry x="520" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-7" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;com.netflix.loadbalancer.&lt;/font&gt;&lt;b style=&quot;font-size: 10px; color: rgb(0, 0, 0); background-color: initial;&quot;&gt;LoadBalancerBuilder&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;服务端服务实例描述对象&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;//负载均衡器配置&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private IClientConfig &lt;b&gt;config&lt;/b&gt; = ClientConfigFactory&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;.findDefaultConfigFactory().newConfig();&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private ServerListFilter &lt;b&gt;serverListFilter&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;//配置中定义的负载均衡规则&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private IRule &lt;b&gt;rule&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private IPing ping = new DummyPing();&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private ServerList &lt;b&gt;serverListImpl&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private ServerListUpdater serverListUpdater;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;//传入类名，根据客户端配置config 实例化类&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;private IClientConfigAware.Factory &lt;b&gt;factory&lt;/b&gt; =&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&#x9;&lt;/span&gt;ClientFactory::instantiateInstanceWithClientConfig;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-720" y="80" width="360" height="240" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-9" target="dFHeEVBBE8L6X1gG-yMv-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-9" value="IClientConfig config = ClientConfigFactory&lt;br&gt;.findDefaultConfigFactory().newConfig();&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;如过没其他提名默认加载配置 &lt;b&gt;DefaultClientConfigImpl&lt;/b&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="520" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-10" value="LoadBalancerBuilder" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="555" y="130" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-13" value="&lt;b&gt;FeignOptionsClientConfig&lt;/b&gt;&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;SpringCloudFeign中重写了ribbon-core中默认配置类DefaultClientConfigImpl，参考 spring-cloud-openfeign-core&lt;br&gt;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="1241" y="320" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-22" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-16" target="dFHeEVBBE8L6X1gG-yMv-21" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-25" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-16" target="dFHeEVBBE8L6X1gG-yMv-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-16" value="&lt;b&gt;SPI机制&lt;/b&gt;加载&amp;nbsp;&lt;b&gt;ClientConfigFactory&lt;/b&gt;.class&lt;br&gt;并按&amp;nbsp;getPriority() 方法返回的优先级排序，返回优先级最高的" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="760" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-18" value="&lt;font style=&quot;&quot; color=&quot;#007fff&quot;&gt;如果引入了ribbon-archaius，会提名com.netflix.client.config.ArchaiusClientConfigFactory&lt;br&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;(&lt;b&gt;注意&lt;/b&gt;创建的配置类名字也是DefaultClientConfigImpl&lt;/span&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;但是和ribbon-core中的类不是同一个类)&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;如果没有提名，默认使用 DefaultClientConfigFactory&lt;/span&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1440.5" y="160" width="490" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-20" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;endArrow=diamondThin;endFill=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-19" target="dFHeEVBBE8L6X1gG-yMv-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-19" value="&lt;div style=&quot;text-align: center; font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot;&gt;&lt;font style=&quot;font-size: 11px;&quot; color=&quot;#000000&quot;&gt;ribbon-&lt;b style=&quot;&quot;&gt;archaius&lt;/b&gt;&amp;nbsp;&lt;/font&gt;&lt;font style=&quot;background-color: initial; font-size: 11px;&quot; color=&quot;#000000&quot;&gt;com.netflix.client.config&lt;/font&gt;&lt;span style=&quot;background-color: initial; color: rgb(0, 0, 0);&quot;&gt;.&lt;/span&gt;&lt;b style=&quot;background-color: initial; color: rgb(0, 0, 0);&quot;&gt;DefaultClientConfigImpl&lt;/b&gt;&lt;/font&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 11px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;&quot;&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;默认的负载均衡器配置&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;propertyNameSpace = &quot;ribbon&quot;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;vipResolver = null&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;//&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;internalProperties = {ConcurrentHashMap@1071}&amp;nbsp; size = 0&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;dynamicProperties = {ConcurrentHashMap@1072}&amp;nbsp; size = 0&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;changeActions = {ConcurrentHashMap@1073}&amp;nbsp; size = 0&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;refreshCounter = {AtomicLong@1074} &quot;0&quot;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;resolver = {ArchaiusPropertyResolver@1075}&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;clientName = &quot;&quot;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;namespace = &quot;ribbon&quot;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;isDynamic = false&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;cachedToString = &quot;ClientConfig:&quot;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1120" y="80" width="360" height="240" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-27" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-21" target="dFHeEVBBE8L6X1gG-yMv-26" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-21" value="&lt;b&gt;ArchaiusClientConfigFactory&lt;/b&gt;#&lt;br&gt;newConfig()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1000" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-29" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-23" target="dFHeEVBBE8L6X1gG-yMv-28" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-23" value="&lt;b&gt;DefaultClientConfigFactory&lt;/b&gt;#&lt;br&gt;newConfig()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1000" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-26" value="&lt;b&gt;DefaultClientConfigImpl&lt;/b&gt;&lt;br&gt;extends AbstractDefaultClientConfigImpl&lt;br&gt;extends ReloadableClientConfig&lt;br&gt;implements IClientConfig&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;测试DEMO中加载的这个配置&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="1241" y="160" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-28" value="&lt;b&gt;DefaultClientConfigImpl&lt;/b&gt;&lt;br&gt;implements IClientConfig" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="1240.5" y="240" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-30" target="dFHeEVBBE8L6X1gG-yMv-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-30" target="dFHeEVBBE8L6X1gG-yMv-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-30" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;String ruleClassName = config.getOrDefault(IClientConfigKey.Keys.&lt;br&gt;NFLoadBalancerRuleClassName);&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="400" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-32" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;NFLoadBalancerRuleClassName = new &lt;b&gt;CommonClientConfigKey&lt;/b&gt;&amp;lt;String&amp;gt;(&quot;NFLoadBalancerRuleClassName&quot;, &quot;com.netflix.loadbalancer.&lt;b style=&quot;border-color: var(--border-color);&quot;&gt;AvailabilityFilteringRule&lt;/b&gt;&quot;) {&lt;span style=&quot;background-color: initial;&quot;&gt;};&lt;/span&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="990" y="400" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-40" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-34" target="dFHeEVBBE8L6X1gG-yMv-36" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-34" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;rule = (IRule) factory.create(ruleClassName, config);&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="760" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-30" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-36" target="dtkDTw0i2Apqsin4ytUc-29" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-36" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;AvailabilityFilteringRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#3333ff&quot; size=&quot;1&quot;&gt;继承&lt;/font&gt;&lt;/div&gt;&lt;font color=&quot;#3333ff&quot; size=&quot;1&quot;&gt;ClientConfigEnabledRoundRobinRule&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-38" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;BestAvailableRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="560" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-44" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;align=center;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-41" target="dFHeEVBBE8L6X1gG-yMv-43" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-92" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-41" target="dFHeEVBBE8L6X1gG-yMv-91" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-41" value="&lt;div&gt;&lt;/div&gt;BaseLoadBalancer lb = new BaseLoadBalancer(config, rule, ping);" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="520" y="1280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-43" value="&lt;div&gt;&lt;/div&gt;lb.&lt;b&gt;setServersList&lt;/b&gt;(servers);&lt;br&gt;return lb;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="520" y="1360" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-45" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;ClientConfigEnabledRoundRobinRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="640" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-47" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;RandomRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="720" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-48" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;ResponseTimeWeightedRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="800" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-49" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;RetryRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="880" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-41" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-50" target="dtkDTw0i2Apqsin4ytUc-40" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-50" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;RoundRobinRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#007fff&quot; size=&quot;1&quot;&gt;轮询&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-51" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;WeightedResponseTimeRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1040" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-52" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;ZoneAvoidanceRule&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1120" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-53" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;NacosRule&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1200" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-54" value="" style="shape=curlyBracket;whiteSpace=wrap;html=1;rounded=1;labelPosition=left;verticalLabelPosition=middle;align=right;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="980" y="480" width="10" height="700" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-55" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;ribbon-core&lt;br&gt;定义的负载均衡规则&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="880" y="810" width="110" height="40" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-57" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AbstractLoadBalancerRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-665" y="441" width="235" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-58" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AvailabilityFilteringRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-954" y="684" width="214" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-59" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;BestAvailableRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-842" y="620" width="174" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-60" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ClientConfigEnabledRoundRobinRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&amp;nbsp;RoundRobinRule &lt;b&gt;roundRobinRule&lt;/b&gt; = new RoundRobinRule();&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1006" y="522" width="310" height="58" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-61" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br/&gt;&lt;b&gt;IRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-590" y="360" width="85" height="39" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-62" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;PredicateBasedRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-1052" y="620" width="190" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-63" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;RandomRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-537" y="522" width="140" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-64" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ResponseTimeWeightedRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-556" y="603" width="248" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-65" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;RetryRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-676" y="522" width="119" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-66" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;RoundRobinRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-377" y="522" width="168" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-67" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;WeightedResponseTimeRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-288" y="603" width="248" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-68" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ZoneAvoidanceRule&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-1162" y="684" width="188" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-69" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=1;startArrow=none;endArrow=block;endSize=12;strokeColor=#008200;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-57" target="dFHeEVBBE8L6X1gG-yMv-61" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-70" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-58" target="dFHeEVBBE8L6X1gG-yMv-62" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-847" y="670" />
              <mxPoint x="-957" y="670" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-71" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-59" target="dFHeEVBBE8L6X1gG-yMv-60" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-755" y="600" />
              <mxPoint x="-851" y="600" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-72" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-60" target="dFHeEVBBE8L6X1gG-yMv-57" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-851" y="497" />
              <mxPoint x="-547" y="497" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-73" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-62" target="dFHeEVBBE8L6X1gG-yMv-60" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-957" y="600" />
              <mxPoint x="-851" y="600" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-74" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-63" target="dFHeEVBBE8L6X1gG-yMv-57" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-467" y="497" />
              <mxPoint x="-547" y="497" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-75" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-64" target="dFHeEVBBE8L6X1gG-yMv-66" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-432" y="578" />
              <mxPoint x="-293" y="578" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-76" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-65" target="dFHeEVBBE8L6X1gG-yMv-57" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-617" y="497" />
              <mxPoint x="-547" y="497" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-77" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-66" target="dFHeEVBBE8L6X1gG-yMv-57" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-293" y="497" />
              <mxPoint x="-547" y="497" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-78" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-67" target="dFHeEVBBE8L6X1gG-yMv-66" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-164" y="578" />
              <mxPoint x="-293" y="578" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-79" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-68" target="dFHeEVBBE8L6X1gG-yMv-62" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-1068" y="670" />
              <mxPoint x="-957" y="670" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-80" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;AbstractLoadBalancer&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;" parent="1" vertex="1">
          <mxGeometry x="-466" y="762" width="204" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-81" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;BaseLoadBalancer (核心类)&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//默认RoundRobinRule&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected &lt;b&gt;IRule&lt;/b&gt; &lt;b&gt;rule&lt;/b&gt; = DEFAULT_RULE;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//默认SerialPingStrategy&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected IPingStrategy &lt;b&gt;pingStrategy&lt;/b&gt; = DEFAULT_PING_STRATEGY;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected IPing &lt;b&gt;ping&lt;/b&gt; = null;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;@Monitor(name = PREFIX + &quot;AllServerList&quot;, type = DataSourceType.INFORMATIONAL)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//所有服务实例列表&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected volatile List&amp;lt;Server&amp;gt; &lt;b&gt;allServerList&lt;/b&gt; = Collections&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;.synchronizedList(new ArrayList&amp;lt;Server&amp;gt;());&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;@Monitor(name = PREFIX + &quot;UpServerList&quot;, type = DataSourceType.INFORMATIONAL)&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//可用的服务实例列表&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected volatile List&amp;lt;Server&amp;gt; &lt;b&gt;upServerList&lt;/b&gt; = Collections&lt;/font&gt;&lt;span style=&quot;background-color: initial;&quot;&gt;.synchronizedList(new ArrayList&amp;lt;Server&amp;gt;());&lt;/span&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected ReadWriteLock &lt;b&gt;allServerLock&lt;/b&gt; = new ReentrantReadWriteLock();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected ReadWriteLock &lt;b&gt;upServerLock&lt;/b&gt; = new ReentrantReadWriteLock();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;//默认default&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected String &lt;b&gt;name&lt;/b&gt; = DEFAULT_NAME;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected Timer &lt;b&gt;lbTimer&lt;/b&gt; = null;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected int &lt;b&gt;pingIntervalSeconds&lt;/b&gt; = 10;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected int &lt;b&gt;maxTotalPingTimeSeconds&lt;/b&gt; = 5;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected Comparator&amp;lt;Server&amp;gt; &lt;b&gt;serverComparator&lt;/b&gt; = new ServerComparator();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected AtomicBoolean &lt;b&gt;pingInProgress&lt;/b&gt; = new AtomicBoolean(false);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;protected LoadBalancerStats &lt;b&gt;lbStats&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private volatile Counter &lt;b&gt;counter&lt;/b&gt; = Monitors.newCounter(&quot;LoadBalancer_ChooseServer&quot;);&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private PrimeConnections &lt;b&gt;primeConnections&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private volatile boolean &lt;b&gt;enablePrimingConnections&lt;/b&gt; = false;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private IClientConfig &lt;b&gt;config&lt;/b&gt;;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private List&amp;lt;ServerListChangeListener&amp;gt; &lt;b&gt;changeListeners&lt;/b&gt; = new CopyOnWriteArrayList&amp;lt;ServerListChangeListener&amp;gt;();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;private List&amp;lt;ServerStatusChangeListener&amp;gt; &lt;b&gt;serverStatusListeners&lt;/b&gt; =&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;white-space: pre;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new CopyOnWriteArrayList&amp;lt;ServerStatusChangeListener&amp;gt;();&lt;/font&gt;&lt;/div&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-570" y="841" width="530" height="379" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-82" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;DynamicServerListLoadBalancer&lt;T&gt;&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-456.5" y="1240" width="303" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-83" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;i&gt;&amp;lt;&amp;lt;interface&amp;gt;&amp;gt;&lt;/i&gt;&lt;br/&gt;&lt;b&gt;ILoadBalancer&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="-438" y="681" width="149" height="39" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-84" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;NoOpLoadBalancer&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-800" y="840" width="185" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-85" value="&lt;p style=&quot;margin:0px;margin-top:4px;text-align:center;&quot;&gt;&lt;b&gt;ZoneAwareLoadBalancer&lt;T&gt;&lt;/b&gt;&lt;/p&gt;&lt;hr size=&quot;1&quot;/&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=14;fontFamily=Helvetica;html=1;rounded=0;shadow=0;comic=0;labelBackgroundColor=none;strokeWidth=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="-430" y="1310" width="250" height="33" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-86" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=1;startArrow=none;endArrow=block;endSize=12;strokeColor=#008200;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-80" target="dFHeEVBBE8L6X1gG-yMv-83" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-87" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-81" target="dFHeEVBBE8L6X1gG-yMv-80" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-305" y="818" />
              <mxPoint x="-364" y="818" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-88" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;entryX=0.5;entryY=1;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-82" target="dFHeEVBBE8L6X1gG-yMv-81" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
            <mxPoint x="-305" y="1230" as="sourcePoint" />
            <mxPoint x="-295" y="1340" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-89" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;exitX=0.500;exitY=0.002;exitDx=0;exitDy=0;entryX=0.500;entryY=1.002;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-84" target="dFHeEVBBE8L6X1gG-yMv-80" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="-707" y="818" />
              <mxPoint x="-364" y="818" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-90" value="" style="html=1;rounded=1;edgeStyle=orthogonalEdgeStyle;dashed=0;startArrow=none;endArrow=block;endSize=12;strokeColor=#000082;entryX=0.500;entryY=1.001;entryDx=0;entryDy=0;exitX=0.5;exitY=0;exitDx=0;exitDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-85" target="dFHeEVBBE8L6X1gG-yMv-82" edge="1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <Array as="points" />
            <mxPoint x="-305" y="1330" as="sourcePoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-91" value="&lt;div&gt;&lt;/div&gt;initWithConfig(config, rule, ping, createLoadBalancerStatsFromConfig(config, ClientFactory&lt;br&gt;::instantiateInstanceWithClientConfig));" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;align=center;" parent="1" vertex="1">
          <mxGeometry x="760" y="1280" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-93" value="&lt;div style=&quot;font-size: 10px;&quot;&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;rule = {AvailabilityFilteringRule@1239}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;pingStrategy = {BaseLoadBalancer$SerialPingStrategy@1255}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;ping = {DummyPing@1082}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;allServerList = {ArrayList@1962}&amp;nbsp; size = 3&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;upServerList = {ArrayList@1962}&amp;nbsp; size = 3&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;allServerLock = {ReentrantReadWriteLock@1267} &quot;java.util.concurrent.locks.ReentrantReadWriteLock@473b46c3[Write locks = 0, Read locks = 0]&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;upServerLock = {ReentrantReadWriteLock@1270} &quot;java.util.concurrent.locks.ReentrantReadWriteLock@516be40f[Write locks = 0, Read locks = 0]&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;name = &quot;&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;lbTimer = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;pingIntervalSeconds = 30&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;maxTotalPingTimeSeconds = 2&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;serverComparator = {ServerComparator@1283}&amp;nbsp;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;pingInProgress = {AtomicBoolean@1287} &quot;false&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;lbStats = {LoadBalancerStats@1402} &quot;Zone stats: {},Server stats: []&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;counter = {BasicCounter@1311} &quot;BasicCounter{config=MonitorConfig{name=LoadBalancer_ChooseServer, tags=COUNTER, policy=DefaultPublishingPolicy}, count=0}&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;primeConnections = null&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;enablePrimingConnections = false&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;config = {DefaultClientConfigImpl@1039} &quot;ClientConfig:&quot;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;changeListeners = {CopyOnWriteArrayList@1317}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#007fff&quot;&gt;serverStatusListeners = {CopyOnWriteArrayList@1320}&amp;nbsp; size = 0&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;" style="text;html=1;align=left;verticalAlign=top;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="740" y="1360" width="770" height="250" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-97" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-94" target="dFHeEVBBE8L6X1gG-yMv-96" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-99" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-94" target="dFHeEVBBE8L6X1gG-yMv-98" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-94" value="urlLoadBalancer.call(&quot;/&quot;)" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-96" value="urlLoadBalancer.getLoadBalancerStats()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="40" y="2260" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-101" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;dashed=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-98" target="dFHeEVBBE8L6X1gG-yMv-100" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pBpu9pEkk6tikpP2m6K1-5" value="选取服务节点后回调" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="dFHeEVBBE8L6X1gG-yMv-101" vertex="1" connectable="0">
          <mxGeometry relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-106" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-98" target="dFHeEVBBE8L6X1gG-yMv-105" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="pBpu9pEkk6tikpP2m6K1-6" value="submit() 实现" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];" parent="dFHeEVBBE8L6X1gG-yMv-106" vertex="1" connectable="0">
          <mxGeometry x="0.05" y="-4" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-98" value="LoadBalancerCommand.&amp;lt;String&amp;gt;builder()&lt;br&gt;.withLoadBalancer(loadBalancer)&lt;br&gt;.build().&lt;b&gt;submit&lt;/b&gt;(new ServerOperation&amp;lt;String&amp;gt;() {...})&lt;br&gt;.toBlocking().&lt;b&gt;first&lt;/b&gt;()" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="280" y="1620" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-100" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;url = new URL(&quot;http://&quot; + server.getHost() + &quot;:&quot; + server.getPort() + path);&lt;br&gt;HttpURLConnection conn = (HttpURLConnection) url.openConnection();&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;font style=&quot;font-size: 9px;&quot;&gt;return Observable.just(conn.getResponseMessage());&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;" parent="1" vertex="1">
          <mxGeometry x="760" y="1620" width="240" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-103" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;com.netflix.loadbalancer.&lt;/font&gt;&lt;b style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;LoadBalancerCommand&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;每个对象表示一次负载均衡调用执行&lt;br&gt;选择Sever -&amp;gt; 调用call(Server) -&amp;gt; 调用ExecutionListener &lt;br&gt;(如果有的话) -&amp;gt; call异常重试 -&amp;gt; 提供反馈信息到LoadBalancerStats&lt;br&gt;&lt;br&gt;&lt;span style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;private final URI&amp;nbsp; &amp;nbsp; loadBalancerURI;&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;background-color: initial; font-size: 10px;&quot;&gt;&lt;div style=&quot;&quot;&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final Object loadBalancerKey;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//里面主要是LoadBalancer实例&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final LoadBalancerContext &lt;b&gt;loadBalancerContext&lt;/b&gt;;&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final RetryHandler &lt;b&gt;retryHandler&lt;/b&gt;;&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private volatile ExecutionInfo executionInfo;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//如果没有手动指定server就为null, 通过selectServer()选取一个服务实例&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final Server &lt;b&gt;server&lt;/b&gt;;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//监听Command执行生命周期：onExecutionStart()&amp;nbsp;onStartWithServer()&lt;/div&gt;&lt;div style=&quot;&quot;&gt;//onExceptionWithServer()&amp;nbsp;onExecutionSuccess()&amp;nbsp;onExecutionFailed()&lt;/div&gt;&lt;div style=&quot;color: rgb(0, 0, 0);&quot;&gt;private final ExecutionContextListenerInvoker&amp;lt;?, T&amp;gt; &lt;b&gt;listenerInvoker&lt;/b&gt;;&lt;/div&gt;&lt;/div&gt;&lt;/span&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1200" y="760" width="360" height="240" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-104" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;响应式回调，这里并没有异步调用&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="775" y="1680" width="170" height="30" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-108" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-105" target="dFHeEVBBE8L6X1gG-yMv-107" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-105" value="final ExecutionInfoContext context = new ExecutionInfoContext();" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="520" y="1700" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-2" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dFHeEVBBE8L6X1gG-yMv-107" target="dtkDTw0i2Apqsin4ytUc-1" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dFHeEVBBE8L6X1gG-yMv-107" value="if (listenerInvoker != null) {&lt;br&gt;&amp;nbsp; &amp;nbsp; &lt;b&gt;listenerInvoker&lt;/b&gt;.onExecutionStart();&lt;br&gt;}" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="520" y="1780" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-4" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-1" target="dtkDTw0i2Apqsin4ytUc-3" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-1" value="&lt;div&gt;final int maxRetrysSame = retryHandler.getMaxRetriesOnSameServer();&lt;/div&gt;&lt;div&gt;final int maxRetrysNext = retryHandler.getMaxRetriesOnNextServer();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="520" y="1860" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-6" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-3" target="dtkDTw0i2Apqsin4ytUc-5" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;dashed=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-3" target="dtkDTw0i2Apqsin4ytUc-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-11" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-3" target="dtkDTw0i2Apqsin4ytUc-10" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-3" value="&lt;font style=&quot;font-size: 9px;&quot;&gt;Observable&amp;lt;T&amp;gt; &lt;b&gt;o&lt;/b&gt; =&amp;nbsp;(server == null ? &lt;b&gt;selectServer&lt;/b&gt;() : Observable.just(server))&lt;br&gt;.&lt;b&gt;concatMap&lt;/b&gt;(new Func1&amp;lt;Server, Observable&amp;lt;T&amp;gt;&amp;gt;() {...})&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="520" y="1940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-17" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-5" target="dtkDTw0i2Apqsin4ytUc-16" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-5" value="&lt;font size=&quot;1&quot;&gt;selectServer()&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;verticalAlign=middle;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="760" y="1940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pBpu9pEkk6tikpP2m6K1-9" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" parent="1" source="dtkDTw0i2Apqsin4ytUc-7" target="dFHeEVBBE8L6X1gG-yMv-100" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-7" value="operation.call(server)&lt;br&gt;&lt;font color=&quot;#3333ff&quot;&gt;核心是调用请求，另外还有一些请求次数记录、监听通知、状态记录等操作，略&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="760" y="2020" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-13" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-10" target="dtkDTw0i2Apqsin4ytUc-12" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-10" value="&lt;div&gt;if (maxRetrysNext &amp;gt; 0 &amp;amp;&amp;amp; server == null)&amp;nbsp;&lt;/div&gt;&lt;div&gt;o = o.&lt;b&gt;retry&lt;/b&gt;(retryPolicy(maxRetrysNext, false));&lt;/div&gt;&lt;div&gt;&lt;font color=&quot;#3333ff&quot;&gt;通过RxJava接口设置重试策略&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="510" y="2100" width="220" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pBpu9pEkk6tikpP2m6K1-8" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-12" target="pBpu9pEkk6tikpP2m6K1-7" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-12" value="return o.&lt;b&gt;onErrorResumeNext&lt;/b&gt;(new Func1&amp;lt;Throwable, Observable&amp;lt;T&amp;gt;&amp;gt;() {...});&lt;br&gt;&lt;font color=&quot;#3333ff&quot;&gt;如果前面发生错误，会执行这里面的逻辑&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="520" y="2180" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-14" value="&lt;font color=&quot;#007fff&quot; style=&quot;font-size: 10px;&quot;&gt;如果没有指定LoadBalancerCommand server&lt;br&gt;就通过selectServer() 选择一个&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="300" y="1950" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-15" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;ExecutionContextListenerInvoker &lt;br&gt;用于监听Command执行生命周期：onExecutionStart() &lt;br&gt;onStartWithServer()&amp;nbsp;&lt;span style=&quot;background-color: initial;&quot;&gt;onExceptionWithServer() &lt;br&gt;onExecutionSuccess() onExecutionFailed()&lt;/span&gt;&amp;nbsp;&lt;/font&gt;" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="260" y="1775" width="260" height="70" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-21" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-16" target="dtkDTw0i2Apqsin4ytUc-20" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-16" value="&lt;font size=&quot;1&quot;&gt;Server server = loadBalancerContext&lt;br&gt;.getServerFromLoadBalancer(&lt;br&gt;loadBalancerURI, loadBalancerKey);&lt;br&gt;...&amp;nbsp;&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="1000" y="1940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-19" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;endArrow=diamondThin;endFill=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-18" target="dFHeEVBBE8L6X1gG-yMv-103" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-18" value="&lt;div style=&quot;text-align: center;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;com.netflix.loadbalancer.&lt;/font&gt;&lt;b style=&quot;color: rgb(0, 0, 0); background-color: initial;&quot;&gt;LoadBalancerContext&lt;/b&gt;&lt;/div&gt;&lt;hr style=&quot;font-size: 10px;&quot; size=&quot;1&quot;&gt;&lt;font style=&quot;font-size: 10px;&quot;&gt;负载均衡器上下文，来自于&amp;nbsp;LoadBalancerCommand$Builder&lt;br&gt;&lt;br&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected String clientName = &quot;default&quot;;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected String vipAddresses;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected int maxAutoRetriesNextServer = CommonClientConfigKey&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.MaxAutoRetriesNextServer.defaultValue();&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected int maxAutoRetries = CommonClientConfigKey&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.MaxAutoRetries.defaultValue();&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected RetryHandler defaultRetryHandler =&amp;nbsp;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;new DefaultLoadBalancerRetryHandler();&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;protected boolean okToRetryOnAllOperations = CommonClientConfigKey&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;&lt;span style=&quot;&quot;&gt;&lt;span style=&quot;&quot;&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/span&gt;&lt;/span&gt;.OkToRetryOnAllOperations.defaultValue();&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;private ILoadBalancer &lt;b&gt;lb&lt;/b&gt;;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font color=&quot;#000000&quot;&gt;&lt;span style=&quot;font-size: 10px;&quot;&gt;private volatile Timer tracer;&lt;/span&gt;&lt;/font&gt;&lt;/div&gt;&lt;/font&gt;" style="verticalAlign=top;align=left;overflow=fill;fontSize=12;fontFamily=Helvetica;html=1;fontColor=#007FFF;" parent="1" vertex="1">
          <mxGeometry x="-1600" y="760" width="360" height="240" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-24" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-20" target="dtkDTw0i2Apqsin4ytUc-23" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-20" value="&lt;font size=&quot;1&quot;&gt;Server svc = lb.chooseServer(loadBalancerKey);&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;verticalAlign=middle;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1241" y="1940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-22" value="BaseLoadBalancer" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1281" y="1910" width="120" height="30" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-26" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-23" target="dtkDTw0i2Apqsin4ytUc-25" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-23" value="&lt;div&gt;if (counter == null) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; counter = createCounter();&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;counter.increment();&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="1480" y="1940" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-31" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" parent="1" source="dtkDTw0i2Apqsin4ytUc-25" target="dtkDTw0i2Apqsin4ytUc-29" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1700" y="2050" />
              <mxPoint x="1700" y="1270" />
              <mxPoint x="1221" y="1270" />
              <mxPoint x="1221" y="525" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-25" value="return rule.choose(key);&lt;br&gt;&lt;font color=&quot;#007fff&quot;&gt;具体参考各种负载均衡规则的实现&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;verticalAlign=middle;fillColor=#fff2cc;strokeColor=#d6b656;" parent="1" vertex="1">
          <mxGeometry x="1480" y="2020" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-33" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-29" target="dtkDTw0i2Apqsin4ytUc-32" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-29" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;&lt;b&gt;choose&lt;/b&gt;(Object key)&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1241" y="480" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-35" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-32" target="dtkDTw0i2Apqsin4ytUc-34" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-44" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.75;entryDx=0;entryDy=0;" parent="1" source="dtkDTw0i2Apqsin4ytUc-32" target="dtkDTw0i2Apqsin4ytUc-40" edge="1">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1700" y="510" />
              <mxPoint x="1700" y="650" />
              <mxPoint x="1230" y="650" />
              <mxPoint x="1230" y="1005" />
            </Array>
          </mxGeometry>
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-32" value="&lt;div style=&quot;font-size: 9px;&quot;&gt;&lt;div&gt;int count = 0;&lt;/div&gt;&lt;div&gt;Server server = &lt;b&gt;roundRobinRule&lt;/b&gt;.choose(key);&lt;/div&gt;&lt;div&gt;while (count++ &amp;lt;= 10) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; if (server != null &amp;amp;&amp;amp; &lt;b&gt;predicate&lt;/b&gt;.apply(new PredicateKey(server))) {&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; &amp;nbsp; &amp;nbsp; return server;&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; }&lt;/div&gt;&lt;div&gt;&amp;nbsp; &amp;nbsp; server = roundRobinRule.choose(key);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="1480" y="460" width="200" height="100" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-38" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-34" target="dtkDTw0i2Apqsin4ytUc-37" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-34" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;return super.choose(key);&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;使用 PredicateBasedRule 选择Server&lt;/font&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="1480" y="581" width="200" height="59" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-36" value="&lt;font style=&quot;font-size: 10px;&quot;&gt;&lt;font color=&quot;#007fff&quot;&gt;即先使用RoundRobinRule选择一个Server, &lt;/font&gt;&lt;br&gt;&lt;span style=&quot;color: rgb(0, 127, 255);&quot;&gt;然后使用服务可用性断言进行校验，校验失败重试（最多10次）&lt;/span&gt;&lt;br&gt;&lt;span style=&quot;color: rgb(0, 127, 255);&quot;&gt;经过10次还是失败则使用 PredicateBasedRule 选择Server&lt;br&gt;&lt;/span&gt;&lt;font color=&quot;#3333ff&quot;&gt;&lt;b&gt;之所以这么实现主要是因为服务不可用是小概率事件，异常的服务实例往往占据很小一部分&lt;br&gt;而直接对所有服务进行可用性校验是很耗费性能的事&lt;/b&gt;&lt;/font&gt;&lt;br&gt;&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1690" y="465" width="420" height="90" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-37" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;ILoadBalancer lb = getLoadBalancer();&lt;/font&gt;&lt;br&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;Optional&amp;lt;Server&amp;gt; server = getPredicate()&lt;br&gt;.chooseRoundRobinAfterFiltering(&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;lb.getAllServers(), key);&lt;br&gt;&lt;/font&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;arcSize=7;" parent="1" vertex="1">
          <mxGeometry x="1720" y="581" width="200" height="59" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-39" value="PredicateBasedRule" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1755" y="551" width="130" height="30" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-43" value="" style="edgeStyle=orthogonalEdgeStyle;rounded=1;orthogonalLoop=1;jettySize=auto;html=1;" parent="1" source="dtkDTw0i2Apqsin4ytUc-40" target="dtkDTw0i2Apqsin4ytUc-42" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-40" value="&lt;div style=&quot;&quot;&gt;&lt;font size=&quot;1&quot;&gt;choose(Object key)&lt;/font&gt;&lt;br&gt;&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;fillColor=#dae8fc;strokeColor=#6c8ebf;" parent="1" vertex="1">
          <mxGeometry x="1241" y="960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="dtkDTw0i2Apqsin4ytUc-42" value="&lt;div style=&quot;&quot;&gt;while循环（最多10次）从&amp;nbsp;lb.getAllServers()&lt;/div&gt;&lt;div style=&quot;&quot;&gt;中用RoundRobin算法选择一个Server实例&lt;br&gt;如果&amp;nbsp;server.&lt;b&gt;isAlive&lt;/b&gt;() &amp;amp;&amp;amp; (server.&lt;b&gt;isReadyToServe&lt;/b&gt;()) 就返回否则重试&lt;/div&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=center;" parent="1" vertex="1">
          <mxGeometry x="1480" y="960" width="200" height="60" as="geometry" />
        </mxCell>
        <mxCell id="pBpu9pEkk6tikpP2m6K1-1" value="&lt;font style=&quot;font-size: 10px;&quot; color=&quot;#007fff&quot;&gt;先对所有服务进行可用性校验，过滤出&lt;br&gt;合格的Server列表再用RoundRobin算法选择&lt;/font&gt;" style="text;html=1;align=left;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1920" y="590.5" width="220" height="40" as="geometry" />
        </mxCell>
        <mxCell id="pBpu9pEkk6tikpP2m6K1-2" value="AvailabilityFilteringRule" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1505" y="430" width="150" height="30" as="geometry" />
        </mxCell>
        <mxCell id="pBpu9pEkk6tikpP2m6K1-3" value="RoundRobinRule" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1524" y="930" width="110" height="30" as="geometry" />
        </mxCell>
        <mxCell id="pBpu9pEkk6tikpP2m6K1-4" value="TODO" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;strokeColor=none;fillColor=none;" parent="1" vertex="1">
          <mxGeometry x="1690" y="975" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="pBpu9pEkk6tikpP2m6K1-7" value="只是额外封装些错误信息，通知监听器&lt;br&gt;listenerInvoker.onExecutionFailed(...)&lt;br&gt;最后&amp;nbsp;return Observable.error(e);&lt;br&gt;&lt;font color=&quot;#3333ff&quot;&gt;这部分不需要关注&lt;/font&gt;" style="rounded=1;whiteSpace=wrap;html=1;fontSize=10;align=left;verticalAlign=middle;" parent="1" vertex="1">
          <mxGeometry x="760" y="2180" width="200" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
  <diagram name="SpringCloudRibbon" id="zkSsGF1-KdQGoPuGVche">
    <mxGraphModel dx="1434" dy="879" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="NESGkONN5W8GX_anX7YY-1" value="&lt;p style=&quot;line-height: 1&quot;&gt;&lt;/p&gt;&lt;h1&gt;&lt;font style=&quot;font-size: 20px&quot;&gt;Spring Cloud Ribbon 工作原理&lt;/font&gt;&lt;font style=&quot;font-size: 16px&quot;&gt;&amp;nbsp;&lt;/font&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;(v2.7.18)&amp;nbsp;&lt;br style=&quot;font-size: 10px&quot;&gt;&lt;/font&gt;&lt;/h1&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;为了让流程图不显的那么复杂，这页只展示Spring Cloud Ribbon对Ribbon的封装；Ribbon组件细节原理看前面的页面。&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;所有测试DEMO，参考 SpringBoot-Labs/netflix-ribbon。&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;spring-cloud-starter-netflix-ribbon 较新的版本中已经被弃用。&lt;/font&gt;&lt;/div&gt;&lt;div style=&quot;font-size: 10px&quot;&gt;&lt;font style=&quot;font-size: 10px&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;br&gt;&lt;/p&gt;&lt;p style=&quot;font-size: 10px&quot;&gt;&lt;/p&gt;&lt;p&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;fontSize=10;" parent="1" vertex="1">
          <mxGeometry x="10" y="20" width="630" height="180" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
