# Gateway 原理篇

源码版本：v2.0.0.M4 。

前提：需要有WebFlux基础，理解WebFlux工作原理。

首先整理清思路：Gateway终究也只是个**基于WebFlux的Web应用**, 应该和MVC一样有请求Handler Mapping，根据应用篇对Gateway的了解，这里研究Gateway源码就需要先找到这个Handler Mapping 的代码，然后要看路由route组件（包括内部的断言、过滤器）怎么加载执行的，最后可能还需要看下其他限流组件、服务发现组件是怎么起作用的。

即：

+ Gateway Handler Mapping
+ Gateway 路由组件加载 & 执行
+ Gateway 其他组件加载 & 执行



## 源码启动的坑

这里源码版本：v2.0.0.M4 （因为找到了个有添加源码注释的[仓库](https://github.com/YunaiV/spring-cloud-gateway)，就用这个仓库调试加快原理流程梳理）。

启动后访问 http://127.0.0.1:8080/image/webp 会显示一个狼头图片。

启动过程遇到的坑：

+ **依赖下载失败**

  需要选上Maven -> Profiles -> spring。

  这里详细说下这个Profile是做什么的。

  之前看Maven使用方法（参考：[Maven Profile](https://github.com/kwseeker/cloud-native/blob/master/build-tools/Maven.md#maven-profile)），知道这里的Profile是POM文件中配置的，用于做个性化配置的，可以选择是否激活。

  从下面定义上看是注册了Maven依赖和插件仓库，然后你肯定会立马反应过来，因为这里选择的源码版本并不是正式版本，而默认的Maven仓库是不包含非正式版本的依赖的，所以肯定会出现依赖下载失败的问题，所以需要注册下面非正式版本依赖的仓库地址。

  > 关于Spring 项目管理周期：M(Milestone) RC GA 的区别，参考：https://stackoverflow.com/questions/32356053/what-is-a-spring-milestone， 我理解M RC 也归属于SNAPSHOT, 只有GA是RELEASE版本。

  ```xml
  <profile>
      <id>spring</id>
      <repositories>
          <repository>
              <id>spring-snapshots</id>
              <name>Spring Snapshots</name>
              <url>https://repo.spring.io/libs-snapshot-local</url>
              <snapshots>
                  <enabled>true</enabled>
              </snapshots>
              <releases>
                  <enabled>false</enabled>
              </releases>
          </repository>
          <repository>
              <id>spring-milestones</id>
              <name>Spring Milestones</name>
              <url>https://repo.spring.io/libs-milestone-local</url>
              <snapshots>
                  <enabled>false</enabled>
              </snapshots>
          </repository>
          <repository>
              <id>spring-releases</id>
              <name>Spring Releases</name>
              <url>https://repo.spring.io/release</url>
              <snapshots>
                  <enabled>false</enabled>
              </snapshots>
          </repository>
      </repositories>
      <pluginRepositories>
          <pluginRepository>
              <id>spring-snapshots</id>
              <name>Spring Snapshots</name>
              <url>https://repo.spring.io/libs-snapshot-local</url>
              <snapshots>
                  <enabled>true</enabled>
              </snapshots>
              <releases>
                  <enabled>false</enabled>
              </releases>
          </pluginRepository>
          <pluginRepository>
              <id>spring-milestones</id>
              <name>Spring Milestones</name>
              <url>https://repo.spring.io/libs-milestone-local</url>
              <snapshots>
                  <enabled>false</enabled>
              </snapshots>
          </pluginRepository>
          <pluginRepository>
              <id>spring-releases</id>
              <name>Spring Releases</name>
              <url>https://repo.spring.io/libs-release-local</url>
              <snapshots>
                  <enabled>false</enabled>
              </snapshots>
          </pluginRepository>
      </pluginRepositories>
  </profile>
  ```

+ **Kotlin版本太低**

  启动时提示`Kotlin: Language version 1.1 is no longer supported; please, use version 1.3 or greater`，Spring Cloud Gateway 在定义RouteLocator等组件时有使用Kotlin。

  依赖列表中可以看到有下面依赖，可以实现Java调用Kotlin。

  > 据说现在Android开发存在大量 Java Kotlin 混合编程。

  ```properties
  org.jetbrains.kotlin:kotlin-stdlib:1.1.51
  org.jetbrains.kotlin:kotlin-reflect:1.1.51
  ```

  只需要修改根目录和`spring-cloud-gateway-sample`模块下POM文件，指定一个更高的支持版本。

  ```xml
  <kotlin.version>1.6.21</kotlin.version>
  ```



## WebFlux应用请求处理流程





## WebFlux Handler Mapping

`spring-cloud-gateway-sample` 中定义了一个Rest接口：`/localcontroller`，这里加断点，看 Gateway请求处理流程。

```
localController:87, GatewaySampleApplication$TestConfig (org.springframework.cloud.gateway.sample)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:62, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:498, Method (java.lang.reflect)
doInvoke:243, InvocableHandlerMethod (org.springframework.web.reactive.result.method)
lambda$invoke$0:138, InvocableHandlerMethod (org.springframework.web.reactive.result.method)
apply:-1, 30366803 (org.springframework.web.reactive.result.method.InvocableHandlerMethod$$Lambda$870)
trySubscribeScalarMap:141, FluxFlatMap (reactor.core.publisher)
subscribe:53, MonoFlatMap (reactor.core.publisher)
subscribe:52, MonoDefer (reactor.core.publisher)
drain:148, MonoIgnoreThen$ThenIgnoreMain (reactor.core.publisher)
subscribe:56, MonoIgnoreThen (reactor.core.publisher)
subscribe:74, MonoPeekFuseable (reactor.core.publisher)
subscribe:74, MonoPeekFuseable (reactor.core.publisher)
subscribe:44, MonoOnErrorResume (reactor.core.publisher)
onNext:150, MonoFlatMap$FlatMapMain (reactor.core.publisher)
onNext:67, FluxSwitchIfEmpty$SwitchIfEmptySubscriber (reactor.core.publisher)
onNext:76, MonoNext$NextSubscriber (reactor.core.publisher)
innerNext:271, FluxConcatMap$ConcatMapImmediate (reactor.core.publisher)
onNext:803, FluxConcatMap$ConcatMapInner (reactor.core.publisher)
onNext:115, FluxMapFuseable$MapFuseableSubscriber (reactor.core.publisher)
request:1630, Operators$ScalarSubscription (reactor.core.publisher)
request:156, FluxMapFuseable$MapFuseableSubscriber (reactor.core.publisher)
set:1444, Operators$MultiSubscriptionSubscriber (reactor.core.publisher)
onSubscribe:1318, Operators$MultiSubscriptionSubscriber (reactor.core.publisher)
onSubscribe:90, FluxMapFuseable$MapFuseableSubscriber (reactor.core.publisher)
subscribe:54, MonoJust (reactor.core.publisher)
subscribe:59, MonoMapFuseable (reactor.core.publisher)
subscribe:3080, Mono (reactor.core.publisher)
drain:418, FluxConcatMap$ConcatMapImmediate (reactor.core.publisher)
onSubscribe:210, FluxConcatMap$ConcatMapImmediate (reactor.core.publisher)
subscribe:128, FluxIterable (reactor.core.publisher)
subscribe:61, FluxIterable (reactor.core.publisher)
subscribe:121, FluxConcatMap (reactor.core.publisher)
subscribe:40, MonoNext (reactor.core.publisher)
subscribe:44, MonoSwitchIfEmpty (reactor.core.publisher)
subscribe:60, MonoFlatMap (reactor.core.publisher)
subscribe:60, MonoFlatMap (reactor.core.publisher)
subscribe:52, MonoDefer (reactor.core.publisher)
subscribe:61, MonoPeekTerminal (reactor.core.publisher)
onNext:150, MonoFlatMap$FlatMapMain (reactor.core.publisher)
complete:1073, Operators$MonoSubscriber (reactor.core.publisher)
signal:241, MonoZip$ZipCoordinator (reactor.core.publisher)
onNext:323, MonoZip$ZipInner (reactor.core.publisher)
request:1630, Operators$ScalarSubscription (reactor.core.publisher)
onSubscribe:312, MonoZip$ZipInner (reactor.core.publisher)
subscribe:54, MonoJust (reactor.core.publisher)
subscribe:3080, Mono (reactor.core.publisher)
subscribe:128, MonoZip (reactor.core.publisher)
subscribe:60, MonoFlatMap (reactor.core.publisher)
subscribe:52, MonoDefer (reactor.core.publisher)
subscribe:61, MonoPeekTerminal (reactor.core.publisher)
subscribe:74, MonoPeekFuseable (reactor.core.publisher)
subscribe:52, MonoDefer (reactor.core.publisher)
subscribe:52, MonoDefer (reactor.core.publisher)
subscribe:44, MonoOnErrorResume (reactor.core.publisher)
subscribe:44, MonoOnErrorResume (reactor.core.publisher)
subscribe:44, MonoOnErrorResume (reactor.core.publisher)
subscribe:3080, Mono (reactor.core.publisher)
drain:167, MonoIgnoreThen$ThenIgnoreMain (reactor.core.publisher)
subscribe:56, MonoIgnoreThen (reactor.core.publisher)
subscribe:70, MonoPeekFuseable (reactor.core.publisher)
subscribe:61, MonoPeekTerminal (reactor.core.publisher)
applyHandler:381, ChannelOperations (reactor.ipc.netty.channel)
onHandlerStart:397, HttpServerOperations (reactor.ipc.netty.http.server)
run:-1, 1198212792 (reactor.ipc.netty.channel.ContextHandler$$Lambda$701)
safeExecute$$$capture:163, AbstractEventExecutor (io.netty.util.concurrent)
safeExecute:-1, AbstractEventExecutor (io.netty.util.concurrent)
 - Async stack trace
addTask:-1, SingleThreadEventExecutor (io.netty.util.concurrent)
execute:766, SingleThreadEventExecutor (io.netty.util.concurrent)
createOperations:245, ContextHandler (reactor.ipc.netty.channel)
channelRead:133, HttpServerHandler (reactor.ipc.netty.http.server)
invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)
invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)
fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)
fireChannelRead:438, CombinedChannelDuplexHandler$DelegatingChannelHandlerContext (io.netty.channel)
fireChannelRead:310, ByteToMessageDecoder (io.netty.handler.codec)
channelRead:284, ByteToMessageDecoder (io.netty.handler.codec)
channelRead:253, CombinedChannelDuplexHandler (io.netty.channel)
invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)
invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)
fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)
channelRead:241, LoggingHandler (io.netty.handler.logging)
invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)
invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)
fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)
channelRead:1434, DefaultChannelPipeline$HeadContext (io.netty.channel)
invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)
invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)
fireChannelRead:965, DefaultChannelPipeline (io.netty.channel)
read:163, AbstractNioByteChannel$NioByteUnsafe (io.netty.channel.nio)
processSelectedKey:645, NioEventLoop (io.netty.channel.nio)
processSelectedKeysOptimized:580, NioEventLoop (io.netty.channel.nio)
processSelectedKeys:497, NioEventLoop (io.netty.channel.nio)
run:459, NioEventLoop (io.netty.channel.nio)
run:886, SingleThreadEventExecutor$5 (io.netty.util.concurrent)
run:750, Thread (java.lang)
```



## Gateway 路由组件

还是从 spring-cloud-starter-gateway 开始分析。

其 pom.xml 引入了三个主要的依赖

```xml
spring-cloud-gateway-core
spring-boot-starter-webflux
spring-cloud-starter-loadbalancer
```

**先看spring-cloud-gateway-core：**

spring.factories定义

```properties
# Auto Configure
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.cloud.gateway.config.GatewayClassPathWarningAutoConfiguration,\
org.springframework.cloud.gateway.config.GatewayAutoConfiguration,\
org.springframework.cloud.gateway.config.GatewayHystrixCircuitBreakerAutoConfiguration,\
org.springframework.cloud.gateway.config.GatewayResilience4JCircuitBreakerAutoConfiguration,\
org.springframework.cloud.gateway.config.GatewayLoadBalancerClientAutoConfiguration,\
org.springframework.cloud.gateway.config.GatewayNoLoadBalancerClientAutoConfiguration,\
org.springframework.cloud.gateway.config.GatewayMetricsAutoConfiguration,\
org.springframework.cloud.gateway.config.GatewayRedisAutoConfiguration,\
org.springframework.cloud.gateway.discovery.GatewayDiscoveryClientAutoConfiguration,\
org.springframework.cloud.gateway.config.SimpleUrlHandlerMappingGlobalCorsAutoConfiguration,\
org.springframework.cloud.gateway.config.GatewayReactiveLoadBalancerClientAutoConfiguration

org.springframework.boot.env.EnvironmentPostProcessor=\
org.springframework.cloud.gateway.config.GatewayEnvironmentPostProcessor
```

GatewayAutoConfiguration 中定义核心功能：



## Gateway 其他组件

