# SkyWalking 应用篇

参考资料：

+ [中文翻译文档](https://skyapm.github.io/document-cn-translation-of-skywalking/zh/8.0.0/)
+ [OpenTracing标准规范](https://github.com/opentracing-contrib/opentracing-specification-zh/blob/master/specification.md)
+ [Dapper，大规模分布式系统的跟踪系统](https://www.iocoder.cn/Fight/Dapper-translation//)
+ [Skywalking解析](https://www.zhihu.com/column/c_1551681469726212096)



## 框架对比

+ skywalking
+ zipkin
+ pinpoint
+ CAT



## 架构

### 架构组成

skywalking的组件：https://skywalking.apache.org/docs/

![](https://skywalking.apache.org/images/home/architecture_2160x720.png)

**数据收集**：包含各种语言自动探针，可对各语言各种服务框架的调用链路进行追踪

+ Agent
  + Java Agent
  + Python Agent
  + Go Agent
  + NodeJS Agent
  + ...
+ SDK
+ Service Mesh

> 基本所有软件都可以用skywalking追踪调用链路，只要有可用的探测钩子且能将钩子放到软件对应的进程中（和debug工具原理类似）；
> 比如：追踪SpringMVC框架接口调用链路，追踪JDBC访问MySQL的调用链路，追踪Jedis访问Redis的调用链路，追踪RocketMQ的消息发送与消费的链路等。

**传输层协议**：

借张图：

![](imgs/skywalking-transport-layer.jpg)

+ Data Collect Protocol
+ Query Protocol
+ Go API

**OAP**（Observability Analysis Platform，可观测的分析平台)：

+ OAL（Observability Analysis Language）: 用来进行度量分析的DSL，类似于SQL，用于查询度量分析结果和 警报。

**持久化**（支持多种数据库）：

+ ES
+ MySQL
+ TiDB
+ H2
+ BanyanDB
+ ...

**界面（GUI/CLI）**：支持图形和命令行界面

+ SkyWalking UI
+ Booster UI
+ Grafana Plugins

### 源码目录

```shell
.
├── apm-checkstyle
│   └── checkStyle.xml		#代码规范校验，官方文档：https://checkstyle.sourceforge.io/index.html
├── apm-dist
├── apm-protocol
│   ├── apm-network
├── apm-webapp
├── codeStyle.xml
├── dist-material
│   ├── alarm-settings.yml
│   ├── bin
│   │   ├── oapService.bat
│   │   ├── oapServiceInit.bat
│   │   ├── oapServiceInit.sh
│   │   ├── oapServiceNoInit.bat
│   │   ├── oapServiceNoInit.sh
│   │   ├── oapService.sh
│   │   ├── startup.bat
│   │   ├── startup.sh
│   │   ├── webappService.bat
│   │   └── webappService.sh
│   ├── config-examples
│   │   ├── alarm-settings.yml
│   │   ├── lal.yaml
│   │   └── log-mal.yaml
│   ├── log4j2.xml
│   └── release-docs
├── docker
│   ├── data-generator
│   ├── docker-compose.yml
│   ├── oap
│   └── ui
├── docs
├── HEADER
├── lombok.config
├── Makefile
├── oap-server
│   ├── analyzer
│   │   ├── agent-analyzer
│   │   ├── analyzer.iml
│   │   ├── event-analyzer
│   │   ├── log-analyzer
│   │   ├── meter-analyzer
│   │   └── pom.xml
│   ├── exporter
│   │   ├── exporter.iml
│   │   ├── pom.xml
│   │   └── src
│   ├── microbench
│   │   ├── microbench.iml
│   │   ├── pom.xml
│   │   └── src
│   ├── oal-grammar
│   │   ├── oal-grammar.iml
│   │   ├── pom.xml
│   │   └── src
│   ├── oal-rt
│   │   ├── oal-rt.iml
│   │   ├── pom.xml
│   │   └── src
│   ├── oap-server.iml
│   ├── pom.xml
│   ├── server-alarm-plugin
│   │   ├── pom.xml
│   │   ├── server-alarm-plugin.iml
│   │   └── src
│   ├── server-cluster-plugin
│   │   ├── cluster-consul-plugin
│   │   ├── cluster-etcd-plugin
│   │   ├── cluster-kubernetes-plugin
│   │   ├── cluster-nacos-plugin
│   │   ├── cluster-standalone-plugin
│   │   ├── cluster-zookeeper-plugin
│   │   ├── pom.xml
│   │   └── server-cluster-plugin.iml
│   ├── server-configuration
│   │   ├── configuration-api
│   │   ├── configuration-apollo
│   │   ├── configuration-consul
│   │   ├── configuration-etcd
│   │   ├── configuration-k8s-configmap
│   │   ├── configuration-nacos
│   │   ├── configuration-zookeeper
│   │   ├── grpc-configuration-sync
│   │   ├── pom.xml
│   │   └── server-configuration.iml
│   ├── server-core
│   │   ├── pom.xml
│   │   ├── server-core.iml
│   │   └── src
│   ├── server-fetcher-plugin
│   │   ├── kafka-fetcher-plugin
│   │   ├── pom.xml
│   │   └── server-fetcher-plugin.iml
│   ├── server-health-checker
│   │   ├── pom.xml
│   │   ├── server-health-checker.iml
│   │   └── src
│   ├── server-library
│   │   ├── library-client
│   │   ├── library-datacarrier-queue
│   │   ├── library-elasticsearch-client
│   │   ├── library-kubernetes-support
│   │   ├── library-module
│   │   ├── library-server
│   │   ├── library-util
│   │   ├── pom.xml
│   │   └── server-library.iml
│   ├── server-query-plugin
│   │   ├── mqe-grammar
│   │   ├── pom.xml
│   │   ├── promql-plugin
│   │   ├── query-graphql-plugin
│   │   ├── server-query-plugin.iml
│   │   └── zipkin-query-plugin
│   ├── server-receiver-plugin
│   │   ├── aws-firehose-receiver
│   │   ├── configuration-discovery-receiver-plugin
│   │   ├── envoy-metrics-receiver-plugin
│   │   ├── otel-receiver-plugin
│   │   ├── receiver-proto
│   │   ├── server-receiver-plugin.iml
│   │   ├── skywalking-browser-receiver-plugin
│   │   ├── skywalking-clr-receiver-plugin
│   │   ├── skywalking-ebpf-receiver-plugin
│   │   ├── skywalking-event-receiver-plugin
│   │   ├── skywalking-jvm-receiver-plugin
│   │   ├── skywalking-log-recevier-plugin
│   │   ├── skywalking-management-receiver-plugin
│   │   ├── skywalking-mesh-receiver-plugin
│   │   ├── skywalking-meter-receiver-plugin
│   │   ├── skywalking-profile-receiver-plugin
│   │   ├── skywalking-sharing-server-plugin
│   │   ├── skywalking-telegraf-receiver-plugin
│   │   ├── skywalking-trace-receiver-plugin
│   │   ├── skywalking-zabbix-receiver-plugin
│   │   └── zipkin-receiver-plugin
│   ├── server-starter																		#OAP服务启动模块，OAP Server 配置文件都在这里
│   ├── server-storage-plugin														#存储插件支持，微内核通过插件拓展 		
│   │   ├── pom.xml
│   │   ├── server-storage-plugin.iml										#默认H2
│   │   ├── storage-banyandb-plugin										 #banyandb
│   │   ├── storage-elasticsearch-plugin								#支持通过ES持久化数据
│   │   ├── storage-jdbc-hikaricp-plugin								#jdbc + hikaricp 连接池
│   │   ├── storage-shardingsphere-plugin
│   │   └── storage-tidb-plugin
│   ├── server-telemetry
│   │   ├── telemetry-api
│   │   └── telemetry-prometheus
│   ├── server-testing
│   └── server-tools
│       ├── data-generator
│       ├── profile-exporter
├── oap-server-bom
├── pom.xml
├── README.md
├── skywalking-ui
├── test
│   ├── e2e-v2
│   │   ├── cases
│   │   ├── java-test-service
│   │   └── script
│   └── Makefile
└── tools
    ├── profile-exporter
    ├── releasing
    │   └── create_source_release.sh
    └── TLS
        └── tls_key_generate.sh
```



## 部署

### 单机部署

#### 组件选型：

+ 跟踪目标：SpringBoot应用

+ OAP Server: v9.4.0

  配置文件：

  - application.yml
  - log4j.xml
  - alarm-settings.yml

+ 数据采集：SkyWalking Agent

+ 数据存储：ElasticSearch

  > 选择ES作为持久化工具，详细配置参考 application.yml  `storage.elasticsearch`配置项。
  >
  > ```shell
  > storage:
  >   selector: ${SW_STORAGE:h2}	# 选择哪种持久化方案
  >   elasticsearch:
  >   	...
  > ```

+ 其他

  + 日志
  + 监控
  + UI

#### docker部署（快速开发测试）

参考：[How to use the Docker images](https://skywalking.apache.org/docs/main/v9.4.0/en/setup/backend/backend-docker/)

```shell
# 这里全部使用本地网络 机器内存紧张的话会报内存不足的异常
# docker 启动 elasticsearch
docker run --name es-single \
-e "discovery.type=single-node" \
-e "cluster.routing.allocation.disk.watermark.low=97%" \
-e "cluster.routing.allocation.disk.watermark.high=98%" \
-e "cluster.routing.allocation.disk.watermark.flood_stage=99%" \
-e "xpack.security.enabled=false" \
-e "xpack.security.http.ssl:enabled=false" \
-e ES_JAVA_OPTS="-Xms256m -Xmx1024m" \
--network host \
-d elasticsearch:8.8.0

# ElasticHD, UI 端口9800
docker run  --name es-hd-single --network host -d containerize/elastichd:latest

# docker 启动 skywalking OAP, 9.4.0 最低要求 jdk-11.0.18+10
# docker run 不支持通过容器名称调用，docker-compose可以
docker run --name oap-server-single \
	-e TZ=Asia/Shanghai \
    -e SW_STORAGE=elasticsearch \
    -e SW_CORE_REST_PORT=12801 \
    -e SW_CORE_GRPC_PORT=11801 \
    -e SW_STORAGE_ES_CLUSTER_NODES=127.0.0.1:9200  \
    -e JAVA_OPTS="-Xms256m -Xmx1G " \
    --security-opt=seccomp:unconfined \
    --network host \
    -d apache/skywalking-oap-server:9.4.0

# skywalking GUI
docker run --name skywalking-ui-single \
	-e TZ=Asia/Shanghai \
	-e SW_OAP_ADDRESS=http://127.0.0.1:12801 \
	--network host \
	-d apache/skywalking-ui:9.4.0    
```

> oap-server 9.4.0 docker 部署一直报错，显示端口占用，但是端口并没有被占用：
>
> 2023-06-09 19:59:42,158 org.apache.skywalking.oap.server.starter.OAPServerBootstrap 57 [main] ERROR [] - [9.4.0-520d531] io.netty.channel.unix.Errors$NativeIoException: bind(..) failed: Address already in use
> java.util.concurrent.CompletionException: io.netty.channel.unix.Errors$NativeIoException: bind(..) failed: Address already in use
> 	at java.util.concurrent.CompletableFuture.reportJoin(Unknown Source) ~[?:?]
> 	at java.util.concurrent.CompletableFuture.join(Unknown Source) ~[?:?]
> 	at com.linecorp.armeria.common.util.EventLoopCheckingFuture.join(EventLoopCheckingFuture.java:87) ~[armeria-1.21.0.jar:?]
> 	at org.apache.skywalking.oap.server.library.server.http.HTTPServer.start(HTTPServer.java:120) ~[library-server-9.4.0.jar:9.4.0]
> 	at org.apache.skywalking.oap.query.promql.PromQLProvider.notifyAfterCompleted(PromQLProvider.java:89) ~[promql-plugin-9.4.0.jar:9.4.0]
> 	at org.apache.skywalking.oap.server.library.module.BootstrapFlow.notifyAfterCompleted(BootstrapFlow.java:52) ~[library-module-9.4.0.jar:9.4.0]
> 	at org.apache.skywalking.oap.server.library.module.ModuleManager.init(ModuleManager.java:61) ~[library-module-9.4.0.jar:9.4.0]
> 	at org.apache.skywalking.oap.server.starter.OAPServerBootstrap.start(OAPServerBootstrap.java:43) [server-starter-9.4.0.jar:9.4.0]
> 	at org.apache.skywalking.oap.server.starter.OAPServerStartUp.main(OAPServerStartUp.java:23) [server-starter-9.4.0.jar:9.4.0]
> Caused by: io.netty.channel.unix.Errors$NativeIoException: bind(..) failed: Address already in use
>
> 临时先换成9.0.0版本，端口占用问题后面再看。

#### 源码部署（源码调试，分析实现原理）

```shell
# TODO
```

### 集群部署



## 应用链路追踪

下载 SkyWalking [JavaAgent](https://dlcdn.apache.org/skywalking/java-agent/)。

IDEA `Run/Debug Configuration`配置：

```
VM options: -javaagent:/home/lee/lib/skywalking/skywalking-agent/skywalking-agent.jar
Environment variables: SW_AGENT_NAME=demo-application;SW_AGENT_COLLECTOR_BACKEND_SERVICES=127.0.0.1:11800;SW_AGENT_SPAN_LIMIT=2000
```

然后启动应用，发送请求，就会自动通过11800端口向skywalking上报数据。



## 9.x面板说明



## 插件

9.x的插件都在独立的项目中，比如Java相关的插件位于 https://github.com/apache/skywalking-java

主要目录：

```

```

常用插件：

+ 忽略部分 URL 的追踪
+ 



