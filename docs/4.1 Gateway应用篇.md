# Gateway 应用篇

官方文档：[Spring Cloud Gateway](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/)

Spring Cloud Gateway 构建于 Spring Boot、Spring WebFlux 和 Project Reactor 之上。

引入 spring-cloud-starter-gateway 但是不想开启网关可以设置 spring.cloud.gateway.enabled=false。



## 工作原理

### 网关负责的功能

+ 路由转发
+ 认证
+ 熔断
+ 限流
+ 日志监控

### SCG实现原理

SCG 基于 WebFlux 响应式Web框架，WebFlux内默认使用Netty异步Web容器。

**特征**：

+ 基于Spring Framework 5, Project Reactor 和 Spring Boot 2.0 进行构建；

+ 动态路由：能够匹配任何请求属性；

+ 集成 Spring Cloud 服务发现功能；

+ 可以对路由指定 Predicate（断言）和 Filter（过滤器）；

+ 易于编写的 Predicate（断言）和 Filter（过滤器）；

+ 集成Hystrix的断路器功能；

+ 请求限流功能；

+ 支持路径重写。

#### 工作流程

官方配图，有点粗略。

<img src="https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/images/spring_cloud_gateway_diagram.png" style="zoom: 67%;" />

+ **路由（route)**
  路由是网关中最基础的部分，路由信息包括一个ID、一个目的URI（被代理微服务URI）、一组断言工厂、一组Filter组成。如果断言为真，则说明请求的URL和配置的路由匹配。
+ **断言(predicates)**
  Java8中的断言函数，SpringCloud Gateway中的断言函数类型是Spring5.0框架中的ServerWebExchange。断言函数允
  许开发者去定义匹配Http request中的任何信息，比如请求头和参数等。
+ **过滤器（Filter)**
  SpringCloud Gateway中的filter分为Gateway FilIer和Global Filter。Filter可以对请求和响应进行处理。

相关配置：

```yaml
spring:
  cloud:
    gateway:
      routes:
        - id: echo_route                  # 路由ID，全局唯一，建议配合服务名
          uri: http://localhost:8080      # 被代理的微服务的请求地址和端口
          #uri: lb://srv-echo              # lb 整合负载均衡器ribbon,loadbalancer
          predicates:					  # 断言工厂，用于路由匹配
            # Path路径匹配
            - Path=/echo/**
            # 匹配在指定的日期时间之后发生的请求，入参是ZonedDateTime类型
            #- After=2021-05-16T20:50:57.511+08:00[Asia/Shanghai]
            # Cookie匹配
            #- Cookie=username, fox
            # Header匹配  请求中带有请求头名为 x-request-id，其值与 \d+ 正则表达式匹配
            #- Header=X-Request-Id, \d+
            # 自定义CheckAuth断言工厂
            #- name: CheckAuth
            #  args:
            #  name: fox
            #- CheckAuth=monkey
          filters:							 # 过滤器工厂,对匹配此路由的请求做额外处理（比如修改请求信息、认证等）
            - AddRequestHeader=X-Request-color, red # 添加请求头
            - AddRequestParameter=color, blue       # 添加请求参数
            #- PrefixPath=/echo                     # 添加前缀，对应微服务需要配置context-path
            #- RedirectTo=302, http://baidu.com     # 重定向到百度
            #- CheckAuth=fox,男                      # 配置自定义的过滤器工厂
```



官方原理图太粗略重新画一张。



常与服务注册中心配合使用。



## SCG 各功能配置

### Actuator API

为了方便测试，先开启gateway端点监控，详细参考 [Actuator API](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#actuator-api)：

```java
management:
  endpoint:
    gateway:
      enabled: true
  endpoints:
    web:
      exposure:
        include: gateway
```

测试DEMO地址是 http://localhost:9999，对应各端点查看url是：

+ 路由列表 http://localhost:9999/actuator/gateway/routes

  查询指定路由信息：http://localhost:9999/actuator/gateway/routes/{id}

+ 全局过滤器列表 http://localhost:9999/actuator/gateway/globalfilters

+ 路由过滤器列表 http://localhost:9999/actuator/gateway/routefilters
+ 刷新路由缓存  http://localhost:9999/actuator/gateway/refresh

### sentinel 限流

